{"createdAt":"2025-04-09T19:41:25.137Z","updatedAt":"2025-05-26T21:54:23.000Z","id":"FRs9Q4wSKR7f8Jl7","name":"Chat IA v1.0","active":false,"isArchived":false,"nodes":[{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1100,-540],"id":"7e11b38b-c04c-478b-a3df-7189b535cde1","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"httpMethod":"POST","path":"63f2f3df-96c0-41a3-9fb8-dc5107b3b861","responseMode":"lastNode","options":{"rawBody":true}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,-580],"id":"28d82361-d7da-4f5d-ac65-678898c985ea","name":"Webhook","webhookId":"63f2f3df-96c0-41a3-9fb8-dc5107b3b861"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook').item.json.body.userid }}{{ $execution.id }}ACTIVO"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[1220,-540],"id":"b76e64e2-ec2c-498f-a137-7b2f4c2b2845","name":"Simple Memory"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.services[0].status }}","rightValue":"Activo","operator":{"type":"string","operation":"equals"},"id":"bd7c5847-6a96-44ed-8942-c3da23fe2404"}],"combinator":"and"},"renameOutput":true,"outputKey":"Activo"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f74167c9-fc82-4406-9ed4-0e813de28a07","leftValue":"={{ $('Webhook').item.json.body.services[0].status }}","rightValue":"Cancelado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cerrado"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[600,-580],"id":"6ffbc25f-fd66-45ed-b06e-0329da453f9c","name":"Switch"},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1100,-60],"id":"8708c2b2-6c14-46dd-8232-cf6d3e3e4738","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook').item.json.body.userid }}{{ $execution.id }}CANCELADO"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[1240,-60],"id":"35855c8c-6f95-469a-9dd4-5bbd3afbd66e","name":"Simple Memory1"},{"parameters":{"jsCode":"// Code Node - Dinámico y optimizado para reducir tokens\nconst services =  $input.first().json.body.services || [];\n\n// Estadísticas básicas\nconst totalServicios = services.length;\nconst serviciosActivos = services.filter(s => s.status === 'Activo').length;\nconst anchoBandaTotal = services.reduce((sum, s) => sum + (parseFloat(s.bandwidthService) || 0), 0);\n\n// Agrupar dinámicamente por ciudad (solo ciudades con servicios)\nconst ciudades = {};\nservices.forEach(s => {\n  const ciudad = s.cityInstall;\n  if (!ciudades[ciudad]) {\n    ciudades[ciudad] = { count: 0, banda: 0 };\n  }\n  ciudades[ciudad].count++;\n  ciudades[ciudad].banda += parseFloat(s.bandwidthService) || 0;\n});\n\n// Agrupar dinámicamente por país\nconst paises = {};\nservices.forEach(s => {\n  const pais = s.countryInstall;\n  if (!paises[pais]) {\n    paises[pais] = { count: 0, banda: 0 };\n  }\n  paises[pais].count++;\n  paises[pais].banda += parseFloat(s.bandwidthService) || 0;\n});\n\n// Agrupar dinámicamente por tipo de producto\nconst tipos = {};\nservices.forEach(s => {\n  const tipo = s.productType;\n  if (!tipos[tipo]) {\n    tipos[tipo] = 0;\n  }\n  tipos[tipo]++;\n});\n\n// Agrupar dinámicamente por familia\nconst familias = {};\nservices.forEach(s => {\n  const familia = s.family;\n  if (!familias[familia]) {\n    familias[familia] = 0;\n  }\n  familias[familia]++;\n});\n\n// Crear texto ultra-compacto dinámico\nconst ciudadesTexto = Object.entries(ciudades)\n  .map(([ciudad, data]) => `${ciudad}:${data.count}(${data.banda}Mbps)`)\n  .join(',');\n\nconst paisesTexto = Object.entries(paises)\n  .map(([pais, data]) => `${pais}:${data.count}(${data.banda}Mbps)`)\n  .join(',');\n\nconst tiposTexto = Object.entries(tipos)\n  .map(([tipo, count]) => `${tipo}:${count}`)\n  .join(',');\n\nconst familiasTexto = Object.entries(familias)\n  .map(([familia, count]) => `${familia}:${count}`)\n  .join(',');\n\n// Lista compacta de servicios (incluyendo dirección)\nconst serviciosLista = services.map(s => \n  `${s.code}|${s.productType}|${s.cityInstall}|${s.addressInstall}|${s.status}|${parseFloat(s.bandwidthService) || 0}Mbps`\n).join(' ');\n\n// Texto final súper compacto\nconst textoFinal = `Total:${totalServicios},Activos:${serviciosActivos},Banda:${anchoBandaTotal}Mbps. Ciudades:[${ciudadesTexto}]. Paises:[${paisesTexto}]. Tipos:[${tiposTexto}]. Familias:[${familiasTexto}]. Servicios:[${serviciosLista}]`;\n\nreturn [{\n  json: {\n    texto_para_ia: textoFinal,\n    // Datos estructurados para consultas específicas\n    resumen: {\n      total: totalServicios,\n      activos: serviciosActivos,\n      banda_total: anchoBandaTotal,\n      por_ciudad: ciudades,\n      por_pais: paises,\n      por_tipo: tipos,\n      por_familia: familias\n    }\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[340,-580],"id":"33766197-ecea-46c6-b742-ee011dfb58cd","name":"Transformacion_Json"},{"parameters":{"promptType":"define","text":"=Eres un asistente que responde preguntas  sobre servicios ACTIVOS del cliente.\n\nAnalisa los servicios del cliente  {{ $json.texto_para_ia }} y responde la consulta {{ $('Webhook').item.json.body.consulta }} \n\nCaracterisitcas de los servicios:\n\nEl tipo del producto está en: productType\nLa Familia del producto esta en: family\nEstado del servicio: status\n\nNo inventes informacion\nNo entras informacion diferente a servicios\nNo respondas consultas no realizadas\nNo recomiendes otros portales\n\nResponde con formato html y puedes agregar emojis de ser necesario.\n\n","options":{"systemMessage":"=Responde solo mensajes en base a los servicios del Cliente\n\nNo inventes informacion, responde solo lo consultado.\n\nResponde en un tono profesional.\n\nResponde unicamente con informacion de los servicios del cliente.","returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1240,-820],"id":"9f89b8f9-727e-422c-99b7-bf0cd13b7186","name":"AI Agent Activos","alwaysOutputData":true,"onError":"continueErrorOutput"},{"parameters":{"promptType":"define","text":"=Eres un asistente que responde preguntas  sobre servicios CANCELADOS del cliente.\n\nAnalisa los servicios del cliente  {{ $json.texto_para_ia }} y responde la consulta {{ $('Webhook').item.json.body.consulta }} \n\nCaracterisitcas de los servicios:\n\nEl tipo del producto está en: productType\nLa Familia del producto esta en: family\nEstado del servicio: status\n\nNo inventes informacion\nNo entras informacion diferente a servicios\nNo respondas consultas no realizadas\nNo recomiendes otros portales\n\nResponde con formato html y puedes agregar emojis de ser necesario.\n\n","options":{"systemMessage":"=Responde solo mensajes en base a los servicios del Cliente\n\nNo inventes informacion, responde solo lo consultado.\n\nResponde en un tono profesional.\n\nResponde unicamente con informacion de los servicios del cliente.","returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1240,-300],"id":"093a437a-5473-4c94-aba4-32af0d28c1e8","name":"AI Agent Cancelados","alwaysOutputData":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"b9aa1c35-796e-4fcf-a133-606e32c702b3","name":"success","value":false,"type":"boolean"},{"id":"74aca4d1-5c1b-48fa-81b7-5c22f5c531b3","name":"error","value":"","type":"string"},{"id":"aeec426e-af43-4ee0-81f7-acde75cc1a89","name":"message","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1640,-720],"id":"77d72ea3-b775-49ab-a1de-327c0caa86a3","name":"Edit Fields"},{"parameters":{"assignments":{"assignments":[{"id":"b9aa1c35-796e-4fcf-a133-606e32c702b3","name":"success","value":true,"type":"boolean"},{"id":"74aca4d1-5c1b-48fa-81b7-5c22f5c531b3","name":"error","value":"","type":"string"},{"id":"aeec426e-af43-4ee0-81f7-acde75cc1a89","name":"message","value":"={{ $json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1640,-920],"id":"76aaa39e-d258-4af9-b15b-3584a7277cc8","name":"Edit Fields1"},{"parameters":{"assignments":{"assignments":[{"id":"b9aa1c35-796e-4fcf-a133-606e32c702b3","name":"success","value":true,"type":"boolean"},{"id":"74aca4d1-5c1b-48fa-81b7-5c22f5c531b3","name":"error","value":"","type":"string"},{"id":"aeec426e-af43-4ee0-81f7-acde75cc1a89","name":"message","value":"={{ $json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1640,-420],"id":"01397114-153c-4dde-a701-f9a1c6e5b7b9","name":"Edit Fields2"},{"parameters":{"assignments":{"assignments":[{"id":"b9aa1c35-796e-4fcf-a133-606e32c702b3","name":"success","value":false,"type":"boolean"},{"id":"74aca4d1-5c1b-48fa-81b7-5c22f5c531b3","name":"error","value":"","type":"string"},{"id":"aeec426e-af43-4ee0-81f7-acde75cc1a89","name":"message","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1660,-200],"id":"984bd74f-2bc7-4e58-83c0-82d8c910db5e","name":"Edit Fields3"},{"parameters":{"description":"valida las respuestas y deben obedecer las reglas \n\nNo inventes informacion\nNo entras informacion diferente a servicios\nNo respondas consultas no realizadas\nNo recomiendes otros portales"},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[1400,-80],"id":"07ba8714-55c0-4d57-990e-f354817644f3","name":"Think1"}],"connections":{"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent Activos","type":"ai_languageModel","index":0}]]},"Webhook":{"main":[[{"node":"Transformacion_Json","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"AI Agent Activos","type":"ai_memory","index":0}]]},"Switch":{"main":[[{"node":"AI Agent Activos","type":"main","index":0}],[{"node":"AI Agent Cancelados","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent Cancelados","type":"ai_languageModel","index":0}]]},"Simple Memory1":{"ai_memory":[[{"node":"AI Agent Cancelados","type":"ai_memory","index":0}]]},"Transformacion_Json":{"main":[[{"node":"Switch","type":"main","index":0}]]},"AI Agent Activos":{"main":[[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Edit Fields","type":"main","index":0}]]},"AI Agent Cancelados":{"main":[[{"node":"Edit Fields2","type":"main","index":0}],[{"node":"Edit Fields3","type":"main","index":0}]]},"Think1":{"ai_tool":[[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2bd90c25-bf4a-4f5c-b049-9e069df5bbd7","triggerCount":1,"tags":[]}