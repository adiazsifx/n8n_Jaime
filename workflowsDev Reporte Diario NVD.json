{"createdAt":"2025-03-27T14:46:32.319Z","updatedAt":"2025-04-17T18:44:59.000Z","id":"RPgpw7EGeWqNYpcg","name":"Dev Reporte Diario NVD","active":false,"nodes":[{"parameters":{"promptType":"define","text":"={{ $json.concatenated_data }}","options":{"systemMessage":"ERES UN EXPERTO ANALISTA DE CIBERSEGURIDAD Y TU FUNCI√ìN PRINCIPAL ES ANALIZAR, CLASIFICAR Y RESUMIR REPORTES DE VULNERABILIDADES OBTENIDOS A TRAV√âS DE LA **NVD (NATIONAL VULNERABILITY DATABASE) NIST.GOV**. DEBES PRODUCIR UNA SALIDA **ESTRICTAMENTE EN FORMATO JSON** QUE CUMPLA CON LA ESTRUCTURA PROPORCIONADA M√ÅS ABAJO.\n\n---\n\n### ENCABEZADO OBLIGATORIO ###\nINCLUYE SIEMPRE AL INICIO DE CADA INFORME LA SIGUIENTE L√çNEA EN NEGRITA:\n\n**FUENTE DEL REPORTE: NVD (NATIONAL VULNERABILITY DATABASE) NIST.GOV**\n\n---\n\n### INSTRUCCIONES DE SALIDA ###\n\n1. **CLASIFICA** LAS VULNERABILIDADES EN TRES CATEGOR√çAS BASADAS EN SU CVSS:\n   - üî¥ **CRITICIDAD ALTA**\n   - üü† **CRITICIDAD MEDIA**\n   - üü¢ **CRITICIDAD BAJA**\n\n2. **EXTRAE Y PRESENTA** PARA CADA VULNERABILIDAD LOS SIGUIENTES CAMPOS:\n   - **CVE**\n   - **Fecha del Reporte**\n   - **Fabricante Afectado**\n   - **Producto Afectado**\n   - **CVSS**\n   - **Descripci√≥n T√©cnica**\n   - **Acciones Recomendadas**\n   - **Referencias** (S√ìLO LAS URLS TAL COMO VIENEN, SIN FORMATO EXTRA)\n\n3. AGREGA UNA SECCI√ìN DE **PAUTAS DE ACCI√ìN GENERALES**, CONTENIENDO BUENAS PR√ÅCTICAS DE SEGURIDAD.\n\n4. INCLUYE UNA SECCI√ìN DE **ESTAD√çSTICAS** AL FINAL CON LOS SIGUIENTES CAMPOS:\n   - **Total de Vulnerabilidades**\n   - **Conteo por Criticidad**\n   - **Promedio CVSS**\n\n---\n\n### FORMATO JSON OBLIGATORIO DE SALIDA ###\nDEVUELVE **EXCLUSIVAMENTE** UNA RESPUESTA EN FORMATO JSON, SIENDO OBLGATORIO ESTE ESQUEMA JSON\n\n{\n  \"metadata\": {\n    \"title\": \"\",\n    \"fecha\": \"\",\n    \"fuente\": \"\"\n  },\n  \"vulnerabilidades\": [\n    {\n      \"criticidad\": \"Alta\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    },\n    {\n      \"criticidad\": \"Media\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    },\n    {\n      \"criticidad\": \"Baja\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    }\n  ],\n  \"pautas_generales\": [\n    \"\",\n    \"\"\n  ],\n  \"estadisticas\": {\n    \"total_vulnerabilidades\": null,\n    \"vulnerabilidades_altas\": null,\n    \"vulnerabilidades_medias\": null,\n    \"vulnerabilidades_bajas\": null,\n    \"promedio_cvss\": null\n  }\n}\n\n### CHAIN OF THOUGHTS ###\nSIGUE ESTRICTAMENTE ESTE PROCESO ANTES DE GENERAR LA SALIDA:\n\n1. **ENTENDER**: LEER Y COMPRENDER LA INFORMACI√ìN CRUDA DE LA API DE VULNERS.\n2. **IDENTIFICAR**: EXTRAER LOS CAMPOS RELEVANTES COMO CVE, CVSS, FABRICANTE, ETC.\n3. **CLASIFICAR**: ASIGNAR UNA CATEGOR√çA DE CRITICIDAD BASADA EN EL CVSS.\n4. **ANALIZAR**: EVALUAR IMPACTO, VECTORES Y DETALLES T√âCNICOS RELEVANTES.\n5. **SINTETIZAR**: REDACTAR DESCRIPCIONES Y RECOMENDACIONES CLARAS Y √öTILES.\n6. **ESTRUCTURAR**: ORDENAR LA INFORMACI√ìN EN EL FORMATO JSON DEFINIDO.\n7. **VALIDAR**: ASEGURAR QUE TODAS LAS SECCIONES Y CAMPOS EST√âN COMPLETOS Y CORRECTOS.\n8. **TRADUCIR**: LA DESCRIPCION TECNICA SIEMPRE DEBE SER ENTREGADA EN ESPA√±OL, MANTENIENDO SOLAMENTE LOS TERMINOS TECNICOS EN EL IDIOMA ORIGINAL.\n\n---\n\n### WHAT NOT TO DO ###\n- **NO OMITAS EL ENCABEZADO DE LA FUENTE (API DE LA NATIONAL VULNERABILITY DATABASE DE NIST.GOV)**\n- **NO FUSIONES VULNERABILIDADES DE DIFERENTES NIVELES DE CRITICIDAD EN UNA MISMA ENTRADA**\n- **NO OMITAS CAMPOS COMO FECHA, CVSS, O FABRICANTE**\n- **NO USES DESCRIPCIONES GEN√âRICAS O INEXACTAS**\n- **NO DEJES VAC√çAS LAS ACCIONES RECOMENDADAS**\n- **NO FORMATEES ENLACES COMO MARKDOWN, NI LOS ENCAPSULES ENTRE PAR√âNTESIS O CORCHETES**\n- **NO DEVUELVAS OTRO FORMATO QUE NO SEA EL JSON DEFINIDO**\n- **NO A√ëADAS TEXTO EXTERNO FUERA DE LA RESPUESTA JSON (NI COMENTARIOS, NI CABECERAS EXTRA, NI SALUDOS)**"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1620,60],"id":"25850a6f-e3f1-4918-8379-07e335d43de5","name":"AI Agent"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=VMware&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-720],"id":"25d10467-5320-481b-a145-e419db5dea7c","name":"Vmware"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Sophos&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-580],"id":"eea33629-fade-4561-8e4f-27b5b07a45d5","name":"Sophos"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=HPE&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-440],"id":"84300add-7950-43e3-bd81-dabe2666d172","name":"HPE"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Veeam&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-300],"id":"1af016ee-5c8d-40fd-9801-e294513e73df","name":"Veeam"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Fortinet&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-160],"id":"cee547c4-480b-49ff-92a1-8f943ae6ed82","name":"Fortinet"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Cisco&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-20],"id":"3d210a03-5784-402c-bf0f-1181872731bb","name":"Cisco"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Ansible&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,120],"id":"746ec11c-4c14-46e0-bbf1-3f4719855884","name":"Ansible"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Kubernetes&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,260],"id":"b4fba520-a20a-4530-b6d5-bbf29b862e4b","name":"Kubernetes"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=SolarWinds&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"29cd63d6-3f9e-4350-ad58-cc6846cc092b"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,400],"id":"cf94395f-2c9a-4576-bcaa-6a56a34fc120","name":"SolarWinds"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Acronis&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,540],"id":"213691d3-d573-4dd0-963e-25a2e0729772","name":"Acronis"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Juniper&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-720],"id":"ed03bdda-7d84-4ffb-96a0-24dd2431acce","name":"Juniper"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Huawei&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-580],"id":"2e1f1a56-a3bb-4ee5-9c62-c89b72e5996d","name":"Huawei"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Chrome&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-440],"id":"bcc9b5aa-934c-4e4f-8afc-fac36f2ebd44","name":"Chrome"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Edge&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-300],"id":"aded0859-3bcd-4325-bce6-db80ac71bc87","name":"Edge"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Outlook&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-160],"id":"61819a16-6e92-418d-b58c-b25a79855ed1","name":"Outlook"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Dell&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-20],"id":"3ad6c840-b7d1-4d67-b05a-3a685149b858","name":"Dell"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=IBM&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,120],"id":"e2640345-1b1d-4e81-ae6c-cde0a7d5d4c9","name":"IBM"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Hitachi&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,260],"id":"1d312f1b-ca94-443c-baa2-6f16a513bcfd","name":"Hitachi"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Pure&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"29cd63d6-3f9e-4350-ad58-cc6846cc092b"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,400],"id":"18f3c060-e3c0-40ca-aa92-06b80b43f085","name":"Pure"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Broadcom&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,540],"id":"5186cd21-c373-44f9-a4cb-970817702e63","name":"Broadcom"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Mikrotik&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,680],"id":"6e9668d2-4e83-45d5-ac38-c6a176a37c42","name":"Mikrotik"},{"parameters":{"numberInputs":10},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,-440],"id":"e1ae4c9d-7fba-4832-91fb-b5d58d2b94e3","name":"Grupo 1"},{"parameters":{"numberInputs":9},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,60],"id":"2d99f719-3423-48b1-b61f-3115beac9e8d","name":"Grupo 2"},{"parameters":{"numberInputs":4},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,500],"id":"c4f12faa-c990-4184-b741-4dedcb333f2e","name":"Grupo 3"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[1140,60],"id":"1dc4095f-70cb-4eb7-9c63-b80fd7927da4","name":"Merge"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-720],"id":"fe9555c1-eb5e-45c6-a65b-94a0c537ad0e","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-580],"id":"b1419001-92a9-473f-b63e-9a0fe35a7f26","name":"If1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-440],"id":"8a765431-9d6a-40b8-86fa-af8d384102e3","name":"If2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-300],"id":"8ace5df1-ae2e-4b37-8ce6-4c0cfd9a1e6a","name":"If3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-160],"id":"8ecca69f-9788-4503-b26d-d5198af01364","name":"If4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-20],"id":"2223a636-bb17-4fef-8076-bf3bf956548d","name":"If5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,120],"id":"9621f477-d6b6-4fd3-8e59-aa9f5511a436","name":"If6"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,260],"id":"2317d82a-19a4-4b97-9640-f2a5fe9f9df3","name":"If7"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,400],"id":"9fa467c3-9d85-4f03-a63d-0d82797d959f","name":"If8"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,540],"id":"862438fb-c863-480b-a938-cbf2520062e8","name":"If9"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,680],"id":"ca625e1a-ee24-4d2a-9fec-de8dccf729ac","name":"If10"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-720],"id":"c02e01d8-daa5-4666-b492-aefc01226866","name":"If11"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-580],"id":"fcefeb39-372f-4437-8ed4-104f19263896","name":"If12"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-440],"id":"847b8db5-256f-4bc2-b09d-98b3ac7f318a","name":"If13"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-300],"id":"a6282917-7841-491e-b27d-1aa249efc1e2","name":"If14"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-160],"id":"c5fea34a-1c40-4190-be68-05d360ff26ef","name":"If15"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-20],"id":"2c525d74-0d84-4c78-a321-c38b69a2c8c7","name":"If16"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,120],"id":"e3942e87-e4a4-4f1e-b1a8-72fb8b0910f5","name":"If17"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,260],"id":"ce7ae8c4-8600-40c5-b068-3e0dd184e286","name":"If18"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,400],"id":"26019224-8eb1-4083-b7a1-ceca69052561","name":"If19"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,540],"id":"3686c6c4-b7f2-45c5-8bbe-d6ea19333145","name":"If20"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1300,60],"id":"f5206700-a40f-4936-94af-252eec06e60d","name":"Aggregate"},{"parameters":{"jsCode":"const now = new Date();\nconst endDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));\nconst startDate = new Date(endDate);\nstartDate.setUTCDate(startDate.getUTCDate() - 7); // resta 7 d√≠as (una semana)\nstartDate.setUTCHours(0, 0, 0, 0); // establece al inicio del d√≠a\n\nconst formatISO8601 = (date) => date.toISOString().replace(/\\.\\d{3}Z$/, '.000Z');\n\nreturn {\n  startDate: formatISO8601(startDate),\n  endDate: formatISO8601(endDate)\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-980,360],"id":"41f1144d-3a2e-4db9-939f-edd0921480fc","name":"Semanal"},{"parameters":{"jsCode":"const now = new Date();\nnow.setUTCDate(now.getUTCDate() - 1); // resta 1 d√≠a\nconst startOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));\nconst endOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));\nconst formatISO8601 = (date) => date.toISOString().replace(/\\.\\d{3}Z$/, '.000Z');\nreturn {\n  startDate: formatISO8601(startOfDay),\n  endDate: formatISO8601(endOfDay)\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-980,200],"id":"d4e1239c-8849-4fd3-b962-9d906db61a49","name":"Diario"},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"data","includeEmpty":true,"separateBy":", "}]},"options":{}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[1460,60],"id":"a2a875c3-7494-4968-b974-fdd1991c94ff","name":"Summarize"},{"parameters":{"jsCode":"const apiKey = \"35a2b3f3-6ab1-45c2-b067-23a5344985ae\";\n\nconst now = new Date();\nnow.setUTCDate(now.getUTCDate() - 1); // resta 1 d√≠a\nconst startOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));\nconst endOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));\nconst formatISO8601 = (date) => date.toISOString().replace(/\\.\\d{3}Z$/, '.000Z');\nreturn {\n  startDate: formatISO8601(startOfDay),\n  endDate: formatISO8601(endOfDay),\n  apiKey: apiKey\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-460,-20],"id":"d42fc088-a657-4e58-b0d3-a752112953ce","name":"Format Date"},{"parameters":{"jsCode":"// Funci√≥n para formatear el per√≠odo de fechas\nfunction formatearPeriodo(startDate, endDate) {\n  if (!startDate || !endDate) return \"\";\n  \n  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];\n  \n  const inicio = new Date(startDate);\n  const fin = new Date(endDate);\n  \n  // Si son el mismo d√≠a\n  if (inicio.toDateString() === fin.toDateString()) {\n    return `${inicio.getDate()} de ${meses[inicio.getMonth()]} de ${inicio.getFullYear()}`;\n  } else {\n    return `${inicio.getDate()} de ${meses[inicio.getMonth()]} al ${fin.getDate()} de ${meses[fin.getMonth()]} de ${fin.getFullYear()}`;\n  }\n}\n\n// Versi√≥n con header con degradado azul a magenta e informaci√≥n del periodo\nfunction createEmailSafeHeader(date, startDate, endDate) {\n  const periodText = formatearPeriodo(startDate, endDate);\n  const periodInfo = periodText ? `<p style=\"color: #ffffff; font-size: 14px; margin: 5px 0 0 0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\">Periodo de Consulta: ${periodText}</p>` : '';\n  \n  \n// Usar una imagen de fondo o celdas con colores s√≥lidos en lugar de gradiente\n  // Usar la imagen como fondo con VML para Outlook\n  return `\n  <!--[if gte mso 9]>\n  <v:rect xmlns:v=\"urn:schemas-microsoft-com:vml\" fill=\"true\" stroke=\"false\" style=\"width:800px;height:150px;\">\n    <v:fill type=\"frame\" src=\"https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM\" color=\"#1a237e\" />\n    <v:textbox style=\"mso-fit-shape-to-text:true\" inset=\"0,0,0,0\">\n  <![endif]-->\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" background=\"https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM\" style=\"background-image: url('https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM'); background-size: cover; background-position: right center; margin-bottom: 20px;\">\n    <tr>\n      <td align=\"left\" valign=\"middle\" width=\"120\" style=\"padding: 15px;\">\n        <img src=\"https://github.com/ifxnetworks/Ansible/blob/main/Imagen3.png?raw=true\" alt=\"Logo\" style=\"width: 110px; height: auto;\">\n      </td>\n      <td align=\"left\" valign=\"middle\" style=\"padding: 15px;\">\n        <h1 style=\"color: #ffffff; font-size: 24px; margin: 0; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);\">BOLET√çN DE CIBERSEGURIDAD</h1>\n        <p style=\"color: #ffffff; font-size: 16px; margin: 5px 0 0 0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\">${date}</p>\n        ${periodInfo}\n      </td>\n    </tr>\n    <tr>\n      <td colspan=\"2\" align=\"right\" style=\"padding-right: 15px; padding-bottom: 5px;\">\n        <p style=\"color: #ffffff; font-size: 11px; margin: 0;\">Generated by <i style=\"font-style: italic;\">aifx</i></p>\n      </td>\n    </tr>\n  </table>\n  <!--[if gte mso 9]>\n    </v:textbox>\n  </v:rect>\n  <![endif]-->`\n}\n\n// Funciones auxiliares\nfunction renderStats(vulnerabilidadesPorCriticidad) {\n  const contadores = {\n    'ALTA': vulnerabilidadesPorCriticidad['ALTA'].length,\n    'MEDIA': vulnerabilidadesPorCriticidad['MEDIA'].length,\n    'BAJA': vulnerabilidadesPorCriticidad['BAJA'].length\n  };\n  \n  const totalVulnerabilidades = contadores.ALTA + contadores.MEDIA + contadores.BAJA;\n  \n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n    <tr>\n      <td style=\"padding: 5px;\">\n        <table width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"5\" style=\"background-color: #f8f9fa; border-radius: 5px;\">\n          <tr>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #dc3545; margin-bottom: 5px;\">${contadores.ALTA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Alta Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #ff9933; margin-bottom: 5px;\">${contadores.MEDIA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Media Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 5px;\">${contadores.BAJA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Baja Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #2c67b2; margin-bottom: 5px;\">${totalVulnerabilidades}</div>\n              <div style=\"font-size: 12px; color: #666;\">Total de Vulnerabilidades</div>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>`;\n}\n\nfunction generarHTMLVulnerabilidad(vuln) {\n  let cvssColor;\n  let cvssBackColor;\n  let cvssValue;\n  \n  // Manejar el caso especial de CVSS \"TBD\"\n  if (vuln.cvss === \"TBD\" || vuln.cvss === null || vuln.cvss === undefined) {\n    cvssColor = '#ff9933'; // Naranja\n    cvssBackColor = '#fff5e6';\n    cvssValue = \"Pendiente\";\n  } else {\n    // Manejar valores num√©ricos normales\n    if (vuln.cvss >= 7) {\n      cvssColor = '#dc3545';\n      cvssBackColor = '#ffeaea';\n    } else if (vuln.cvss >= 4) {\n      cvssColor = '#ff9933';\n      cvssBackColor = '#fff5e6';\n    } else {\n      cvssColor = '#28a745';\n      cvssBackColor = '#e6f5e6';\n    }\n    cvssValue = vuln.cvss;\n  }\n  \n  // Generar HTML para acciones recomendadas\n  let accionesHTML = '';\n  if (vuln.acciones_recomendadas && vuln.acciones_recomendadas.length > 0) {\n    accionesHTML = vuln.acciones_recomendadas.map(accion => \n      `<li style=\"margin-bottom: 5px;\">${accion}</li>`\n    ).join('');\n  }\n  \n  // Generar HTML para referencias\n  let referenciasHTML = '';\n  if (vuln.referencias && vuln.referencias.length > 0) {\n    referenciasHTML = vuln.referencias.map(ref => \n      `<a href=\"${ref}\" style=\"color: #2c67b2; font-size: 13px; word-break: break-all; display: block; margin-bottom: 5px;\">${ref}</a>`\n    ).join('');\n  }\n  \n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px; border: 1px solid #eaeaea; border-radius: 5px;\">\n    <tr>\n      <td style=\"padding: 15px 20px;\">\n        <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n          <tr>\n            <td>\n              <div style=\"font-weight: bold; font-size: 18px; color: #2c67b2; margin-bottom: 8px;\">${vuln.fabricante || 'Fabricante no especificado'}</div>\n              <div style=\"font-size: 14px; color: #666; margin-top: 5px;\">\n                <span><strong>CVE:</strong> ${vuln.cve}</span><br>\n                <span><strong>Fecha del Reporte:</strong> ${vuln.fecha_reporte}</span><br>\n                <span><strong>Producto Afectado:</strong> ${vuln.producto}</span><br>\n                <span style=\"display: inline-block; padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 12px; margin-top: 5px; background-color: ${cvssBackColor}; color: ${cvssColor};\">CVSS: ${cvssValue}</span>\n              </div>\n            </td>\n          </tr>\n          <tr>\n            <td style=\"padding-top: 15px;\">\n              <table width=\"100%\" border=\"0\" cellpadding=\"12\" cellspacing=\"0\" style=\"background-color: #f8f9fa; border-radius: 5px; margin: 10px 0;\">\n                <tr>\n                  <td>\n                    <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Descripci√≥n T√©cnica</div>\n                    <p>${vuln.descripcion}</p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <tr>\n            <td style=\"padding-top: 15px;\">\n              <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Acciones Recomendadas</div>\n              <ul style=\"padding-left: 25px; margin-bottom: 15px;\">\n                ${accionesHTML}\n              </ul>\n            </td>\n          </tr>\n          <tr>\n            <td>\n              <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Referencias</div>\n              ${referenciasHTML}\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>`;\n}\n\n// C√≥digo principal para n8n\nconst items = $input.all();\nconst returnItems = [];\n\nfor (const item of items) {\n  try {\n    // Obtener el per√≠odo desde los par√°metros de entrada (si existen)\n    const startDate = item.json.startDate || null;\n    const endDate = item.json.endDate || null;\n    \n    console.log(\"Per√≠odo recibido:\", { startDate, endDate });\n    \n    // Extraer y parsear los datos JSON\n    let securityData;\n    let outputContent = '';\n    \n    // Verificar si hay datos en el campo 'output'\n    if (item.json.output) {\n      outputContent = item.json.output;\n      \n      // Si el output ya es un objeto, usarlo directamente\n      if (typeof outputContent === 'object' && outputContent !== null) {\n        securityData = outputContent;\n      } \n      // Si es un string, procesar adecuadamente\n      else if (typeof outputContent === 'string') {\n        console.log(\"Output original:\", outputContent.substring(0, 100) + \"...\");\n        \n        // Limpiar el string: eliminar marcadores de c√≥digo y caracteres problem√°ticos\n        let cleanedContent = outputContent;\n        \n        // Eliminar ```json o ``` al inicio\n        if (cleanedContent.trim().startsWith('```json')) {\n          cleanedContent = cleanedContent.replace(/^```json\\s*/m, '');\n        } else if (cleanedContent.trim().startsWith('```')) {\n          cleanedContent = cleanedContent.replace(/^```\\s*/m, '');\n        }\n        \n        // Eliminar ``` al final\n        if (cleanedContent.trim().endsWith('```')) {\n          cleanedContent = cleanedContent.replace(/\\s*```$/m, '');\n        }\n        \n        console.log(\"Contenido limpio de marcadores:\", cleanedContent.substring(0, 100) + \"...\");\n        \n        // Intentar crear un objeto JSON v√°lido\n        try {\n          // Si comienza con asteriscos u otros caracteres no JSON, intentar extraer el JSON\n          if (cleanedContent.includes('{')) {\n            // Buscar el primer '{' y √∫ltimo '}'\n            const startIdx = cleanedContent.indexOf('{');\n            const endIdx = cleanedContent.lastIndexOf('}') + 1;\n            \n            if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {\n              const jsonCandidate = cleanedContent.substring(startIdx, endIdx);\n              console.log(\"Extrayendo JSON entre llaves:\", jsonCandidate.substring(0, 100) + \"...\");\n              securityData = JSON.parse(jsonCandidate);\n            } else {\n              throw new Error(\"No se encontr√≥ una estructura JSON v√°lida en el contenido\");\n            }\n          } else {\n            // Intentar parsear directo si no encontramos problemas evidentes\n            securityData = JSON.parse(cleanedContent);\n          }\n        } catch (e) {\n          console.log('Error al parsear JSON:', e);\n          \n          // Intentar crear un objeto de seguridad b√°sico si no podemos parsear el JSON\n          try {\n            // Extraer secciones relevantes del texto\n            console.log(\"Intentando crear estructura manualmente desde el texto\");\n            \n            // Creamos un objeto b√°sico\n            securityData = {\n              metadata: { fuente: \"Extracci√≥n manual del texto\" },\n              vulnerabilidades: [],\n              pautas_generales: []\n            };\n            \n            // Si podemos extraer vulnerabilidades del texto, lo hacemos\n            // Este es un proceso muy simplificado\n            const vulnSections = cleanedContent.split(/(?:\\r?\\n){2,}/);\n            \n            // Buscar secciones que parecen vulnerabilidades\n            for (const section of vulnSections) {\n              if (section.includes(\"CVE-\") || section.includes(\"vulnerabilidad\") || section.includes(\"criticidad\")) {\n                // Determinar criticidad\n                let criticidad = \"MEDIA\"; // Por defecto\n                if (section.toLowerCase().includes(\"alta\") || section.toLowerCase().includes(\"cr√≠tica\")) {\n                  criticidad = \"ALTA\";\n                } else if (section.toLowerCase().includes(\"baja\")) {\n                  criticidad = \"BAJA\";\n                }\n                \n                // Extraer CVE si existe\n                const cveMatch = section.match(/CVE-\\d{4}-\\d{4,}/);\n                const cve = cveMatch ? cveMatch[0] : \"Sin CVE\";\n                \n                // A√±adir vulnerabilidad b√°sica\n                securityData.vulnerabilidades.push({\n                  criticidad: criticidad,\n                  cve: cve,\n                  descripcion: section.substring(0, 500),\n                  producto: \"Extra√≠do del texto\",\n                  fecha_reporte: new Date().toISOString().split('T')[0],\n                  acciones_recomendadas: [\"Contactar al proveedor para m√°s informaci√≥n\"],\n                  referencias: []\n                });\n              }\n            }\n            \n            // Si no encontramos vulnerabilidades, a√±adir una de muestra\n            if (securityData.vulnerabilidades.length === 0) {\n              securityData.vulnerabilidades.push({\n                criticidad: \"MEDIA\",\n                cve: \"Formato-Desconocido\",\n                descripcion: \"No se pudo extraer informaci√≥n estructurada del texto. Por favor, revise el formato de entrada.\",\n                producto: \"Desconocido\",\n                fecha_reporte: new Date().toISOString().split('T')[0],\n                acciones_recomendadas: [\"Revisar el formato de entrada\"],\n                referencias: []\n              });\n            }\n            \n            // A√±adir pauta general\n            securityData.pautas_generales.push(\n              \"Este reporte fue generado desde un texto no estructurado. Se recomienda revisar el formato de entrada.\"\n            );\n            \n            console.log(\"Creada estructura manual con\", securityData.vulnerabilidades.length, \"vulnerabilidades\");\n            \n          } catch (manualError) {\n            console.log(\"Error al crear estructura manual:\", manualError);\n            throw new Error(`No se pudo procesar el formato de entrada: ${e.message}`);\n          }\n        }\n      } else {\n        throw new Error('El formato del output no es reconocible');\n      }\n    } else {\n      throw new Error('No se encontr√≥ campo \"output\" en los datos de entrada');\n    }\n    \n    console.log(\"Estructura procesada:\", JSON.stringify(securityData).substring(0, 100) + \"...\");\n    \n    // Validar la estructura\n    if (!securityData || !securityData.vulnerabilidades || !Array.isArray(securityData.vulnerabilidades)) {\n      throw new Error('Formato JSON inv√°lido: se requiere un array de vulnerabilidades');\n    }\n    \n    // Asegurarse que metadata existe\n    if (!securityData.metadata) {\n      securityData.metadata = {};\n    }\n    \n    // Normalizar criticidad a may√∫sculas\n    securityData.vulnerabilidades.forEach(vuln => {\n      if (vuln.criticidad) {\n        vuln.criticidad = vuln.criticidad.toUpperCase();\n      }\n    });\n    \n    // Clasificar vulnerabilidades por criticidad\n    const vulnerabilidadesPorCriticidad = {\n      'ALTA': [],\n      'MEDIA': [],\n      'BAJA': []\n    };\n\n    // Procesar cada vulnerabilidad \n    securityData.vulnerabilidades.forEach(vuln => {\n      // Convertir a may√∫sculas y normalizar\n      const criticidad = String(vuln.criticidad || '').toUpperCase();\n      \n      // A√±adir a la categor√≠a apropiada si existe\n      if (criticidad === 'ALTA') {\n        vulnerabilidadesPorCriticidad.ALTA.push(vuln);\n      } else if (criticidad === 'MEDIA') {\n        vulnerabilidadesPorCriticidad.MEDIA.push(vuln);\n      } else if (criticidad === 'BAJA') {\n        vulnerabilidadesPorCriticidad.BAJA.push(vuln);\n      }\n    });\n    \n    // Formatear fecha actual\n    const ahora = new Date();\n    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];\n    const fechaFormateada = `${meses[ahora.getMonth()]} ${ahora.getDate()} de ${ahora.getFullYear()}`;\n    \n    // Total de vulnerabilidades\n    const totalVulnerabilidades = securityData.vulnerabilidades.length;\n    \n    // Construir el HTML - usando tablas para compatibilidad con correo\n    let html = `<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Bolet√≠n de Alertas de Ciberseguridad</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f8f9fa; color: #333; font-family: Arial, sans-serif; line-height: 1.6;\">\n    <div style=\"max-width: 800px; margin: 0 auto; background-color: #ffffff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);\">\n        <!-- Cabecera con gradiente y per√≠odo -->\n        ${createEmailSafeHeader(fechaFormateada, startDate, endDate)}\n        \n        <!-- Contenido -->\n        <div style=\"padding: 30px;\">\n            <div style=\"background-color: #f1f5f9; border-left: 4px solid #2c67b2; padding: 12px 20px; margin-bottom: 25px; font-size: 14px;\">\n                <strong>FUENTE DEL REPORTE:</strong> ${securityData.metadata.fuente || 'Fuente no disponible'}\n            </div>\n            \n            <!-- Estad√≠sticas -->\n            ${renderStats(vulnerabilidadesPorCriticidad)}`;\n\n    // Si no hay vulnerabilidades, mostrar mensaje especial\n    if (totalVulnerabilidades === 0) {\n      html += `\n            <div style=\"background-color: #f8f9fa; padding: 30px; margin-bottom: 30px; text-align: center; border-radius: 5px; font-size: 18px;\">\n                <strong>¬°Buenas noticias!</strong><br>No se han detectado vulnerabilidades en el per√≠odo actual.\n            </div>`;\n    } else {\n      // Secci√≥n de Alta Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #dc3545; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD ALTA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['ALTA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['ALTA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n      \n      // Secci√≥n de Media Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #ff9933; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD MEDIA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['MEDIA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['MEDIA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n      \n      // Secci√≥n de Baja Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #28a745; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD BAJA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['BAJA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['BAJA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n    }\n    \n    // Secci√≥n de Pautas Generales\n    html += `\n            <div style=\"background-color: #f1f5f9; border-radius: 5px; padding: 20px; margin-top: 30px;\">\n                <h3 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1a2e4a;\">PAUTAS DE ACCI√ìN GENERALES</h3>\n                <ol style=\"padding-left: 25px;\">`;\n    \n    if (securityData.pautas_generales && securityData.pautas_generales.length > 0) {\n      securityData.pautas_generales.forEach(pauta => {\n        html += `\n                    <li style=\"margin-bottom: 10px;\">${pauta}</li>`;\n      });\n    } else {\n      html += `\n                    <li style=\"margin-bottom: 10px;\">No hay pautas generales disponibles.</li>`;\n    }\n    \n    html += `\n                </ol>\n            </div>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px;\">\n            <img src=\"https://github.com/ifxnetworks/Ansible/blob/main/Imagen1nnlnl.jpg?raw=true\" alt=\"Pie de p√°gina\" style=\"max-width: 100%; height: auto;\">\n        </div>\n    </div>\n</body>\n</html>`;\n\n    // Incluir los datos JSON en un campo oculto del HTML\n    const jsonScriptTag = `<script id=\"security-data\" type=\"application/json\" style=\"display:none;\">${JSON.stringify(securityData)}</script>`;\n    html = html.replace('</body>', `${jsonScriptTag}</body>`);\n\n    // Devolver un √∫nico output\n    returnItems.push({\n      json: {\n        htmlEmail: html\n      }\n    });\n  } catch (error) {\n    console.log('Error:', error);\n    const errorMessage = error instanceof Error \n      ? error.message \n      : 'Error desconocido';\n    returnItems.push({\n      json: {\n        error: `Error al procesar los datos: ${errorMessage}`\n      }\n    });\n  }\n}\n\nreturn returnItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1980,60],"id":"14321334-6c2b-4656-adcf-6e0130fa686c","name":"HTML Create"},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"Boletin de Vulnerabilidades - NVD NIST.GOV","bodyContent":"={{ $json.htmlEmail }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[2180,60],"id":"6c987cea-20f5-4397-bb1c-84d6e2d36c8f","name":"Microsoft Outlook","webhookId":"8d78c886-c815-4b16-af7e-fc137fe9fcfa","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook Mail JPG"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,680],"id":"47da6bad-357d-4f4e-aa71-967794051715","name":"If21"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Ubiquti&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,680],"id":"01336adc-e7b6-4195-bb0a-4d5a4d20a9dc","name":"Ubiquiti"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1580,260],"id":"bb35df83-6173-4afb-88eb-2a31419a8855","name":"Llama 4 Scout","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-680,-20],"id":"6cd9394e-6023-4a91-a3d1-3a6c37b95b83","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=PFSense&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apiKey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,820],"id":"0f5e70b1-9bbe-425d-bef1-97e7c85d17c1","name":"PFSense"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,820],"id":"92631252-cc90-4e7c-8892-a198f33f799c","name":"If22"}],"connections":{"AI Agent":{"main":[[{"node":"HTML Create","type":"main","index":0}]]},"Cisco":{"main":[[{"node":"If5","type":"main","index":0}]]},"Vmware":{"main":[[{"node":"If","type":"main","index":0}]]},"Sophos":{"main":[[{"node":"If1","type":"main","index":0}]]},"HPE":{"main":[[{"node":"If2","type":"main","index":0}]]},"Veeam":{"main":[[{"node":"If3","type":"main","index":0}]]},"Fortinet":{"main":[[{"node":"If4","type":"main","index":0}]]},"Ansible":{"main":[[{"node":"If6","type":"main","index":0}]]},"Kubernetes":{"main":[[{"node":"If7","type":"main","index":0}]]},"SolarWinds":{"main":[[{"node":"If8","type":"main","index":0}]]},"Acronis":{"main":[[{"node":"If9","type":"main","index":0}]]},"Juniper":{"main":[[{"node":"If11","type":"main","index":0}]]},"Huawei":{"main":[[{"node":"If12","type":"main","index":0}]]},"Chrome":{"main":[[{"node":"If13","type":"main","index":0}]]},"Edge":{"main":[[{"node":"If14","type":"main","index":0}]]},"Outlook":{"main":[[{"node":"If15","type":"main","index":0}]]},"Dell":{"main":[[{"node":"If16","type":"main","index":0}]]},"IBM":{"main":[[{"node":"If17","type":"main","index":0}]]},"Hitachi":{"main":[[{"node":"If18","type":"main","index":0}]]},"Pure":{"main":[[{"node":"If19","type":"main","index":0}]]},"Broadcom":{"main":[[{"node":"If20","type":"main","index":0}]]},"Mikrotik":{"main":[[{"node":"If10","type":"main","index":0}]]},"Grupo 1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Grupo 2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Grupo 3":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"If":{"main":[[],[{"node":"Grupo 1","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"Grupo 1","type":"main","index":2}]]},"If2":{"main":[[],[{"node":"Grupo 1","type":"main","index":4}]]},"If3":{"main":[[],[{"node":"Grupo 1","type":"main","index":6}]]},"If4":{"main":[[],[{"node":"Grupo 1","type":"main","index":8}]]},"If5":{"main":[[],[{"node":"Grupo 2","type":"main","index":0}]]},"If6":{"main":[[],[{"node":"Grupo 2","type":"main","index":2}]]},"If7":{"main":[[],[{"node":"Grupo 2","type":"main","index":4}]]},"If8":{"main":[[],[{"node":"Grupo 2","type":"main","index":6}]]},"If9":{"main":[[],[{"node":"Grupo 2","type":"main","index":8}]]},"If10":{"main":[[],[{"node":"Grupo 3","type":"main","index":1}]]},"If11":{"main":[[],[{"node":"Grupo 1","type":"main","index":1}]]},"If12":{"main":[[],[{"node":"Grupo 1","type":"main","index":3}]]},"If13":{"main":[[],[{"node":"Grupo 1","type":"main","index":5}]]},"If14":{"main":[[],[{"node":"Grupo 1","type":"main","index":7}]]},"If15":{"main":[[],[{"node":"Grupo 1","type":"main","index":9}]]},"If16":{"main":[[],[{"node":"Grupo 2","type":"main","index":1}]]},"If17":{"main":[[],[{"node":"Grupo 2","type":"main","index":3}]]},"If18":{"main":[[],[{"node":"Grupo 2","type":"main","index":5}]]},"If19":{"main":[[],[{"node":"Grupo 2","type":"main","index":7}]]},"If20":{"main":[[],[{"node":"Grupo 3","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Summarize","type":"main","index":0}]]},"Summarize":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Format Date":{"main":[[{"node":"Vmware","type":"main","index":0},{"node":"Sophos","type":"main","index":0},{"node":"HPE","type":"main","index":0},{"node":"Veeam","type":"main","index":0},{"node":"Fortinet","type":"main","index":0},{"node":"Cisco","type":"main","index":0},{"node":"Ansible","type":"main","index":0},{"node":"Kubernetes","type":"main","index":0},{"node":"SolarWinds","type":"main","index":0},{"node":"Acronis","type":"main","index":0},{"node":"Mikrotik","type":"main","index":0},{"node":"Juniper","type":"main","index":0},{"node":"Huawei","type":"main","index":0},{"node":"Chrome","type":"main","index":0},{"node":"Edge","type":"main","index":0},{"node":"Outlook","type":"main","index":0},{"node":"Dell","type":"main","index":0},{"node":"IBM","type":"main","index":0},{"node":"Hitachi","type":"main","index":0},{"node":"Pure","type":"main","index":0},{"node":"Broadcom","type":"main","index":0},{"node":"Ubiquiti","type":"main","index":0},{"node":"PFSense","type":"main","index":0}]]},"HTML Create":{"main":[[{"node":"Microsoft Outlook","type":"main","index":0}]]},"Ubiquiti":{"main":[[{"node":"If21","type":"main","index":0}]]},"If21":{"main":[[],[{"node":"Grupo 3","type":"main","index":2}]]},"Llama 4 Scout":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"Format Date","type":"main","index":0}]]},"PFSense":{"main":[[{"node":"If22","type":"main","index":0}]]},"If22":{"main":[[],[{"node":"Grupo 3","type":"main","index":3}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"5e5dd1a0-fba3-4cf6-a27b-3193fbbfd714","triggerCount":2,"tags":[]}