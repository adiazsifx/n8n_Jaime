{"createdAt":"2025-05-09T19:31:26.715Z","updatedAt":"2025-05-12T19:24:49.000Z","id":"4DkGW9mvFYpAa0z5","name":"Summary Whisper Wapp","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-640,400],"id":"86425fb1-2425-4966-8193-22a127270d90","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{"assignments":{"assignments":[{"id":"0fb20157-5a32-442b-9601-eac38f777c9d","name":"conversation","value":"={{ JSON.stringify($json.conversations)}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[100,420],"id":"00df51df-6101-42cd-9d1f-3ae51f0208ef","name":"Edit Fields","alwaysOutputData":false},{"parameters":{"inputText":"={{ $json.conversation }}","options":{}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[380,260],"id":"3a36320f-76b5-42eb-b81c-c86eea86480c","name":"Sentiment Analysis1"},{"parameters":{"operation":"executeQuery","query":"SELECT \n    id,\n    \"remoteJid\",\n    participant,\n    \"pushName\",\n    conversation,\n    \"instanceId\",\n    \"dateTime\",\n    sender,\n    url_image,\n    url_audio,\n    url_video\nFROM \n    public.messages\nWHERE \n    \"dateTime\"::timestamp >= (CURRENT_DATE - INTERVAL '1 day')::timestamp\n    AND \"dateTime\"::timestamp < CURRENT_DATE::timestamp\nORDER BY \n    \"dateTime\" ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-460,400],"id":"593aa7d8-ef65-46bc-8509-dbab48d56bca","name":"Postgres","credentials":{"postgres":{"id":"8GkMmZaSPz5j95ME","name":"Postgres Whisper AIFX Table"}}},{"parameters":{"jsCode":"// Agrupar por remoteJid\n// @ts-ignore\nconst groupedData = {};\n\n// Iterar a trav√©s de cada √≠tem\nfor (const item of items) {\n  const remoteJid = item.json.remoteJid;\n  \n  // @ts-ignore - Ignorar error de tipo\n  if (!groupedData[remoteJid]) {\n    // @ts-ignore\n    groupedData[remoteJid] = {\n      remoteJid: remoteJid,\n      conversations: []\n    };\n  }\n  \n  // @ts-ignore\n  groupedData[remoteJid].conversations.push({\n    id: item.json.id,\n    participant: item.json.participant,\n    pushName: item.json.pushName,\n    conversation: item.json.conversation,\n    instanceId: item.json.instanceId,\n    dateTime: item.json.dateTime,\n    sender: item.json.sender,\n    url_image: item.json.url_image,\n    url_audio: item.json.url_audio\n  });\n}\n\n// Convertir el objeto agrupado en un array para la salida\nreturn Object.values(groupedData).map(item => ({json: item}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-300,400],"id":"3707fce6-d040-48a1-a26e-577ab94f7625","name":"Code1"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[460,440],"id":"2ff04fc2-2c5d-40a0-a202-0713764a8708","name":"Llama 4 Scout","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"inputText":"={{ $json.conversation }}","options":{}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[400,580],"id":"e4da3af6-ae02-4673-9ede-228ba00971fc","name":"Sentiment Analysis"},{"parameters":{"model":{"__rl":true,"value":"openai-nano","mode":"list","cachedResultName":"openai-nano"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[360,760],"id":"4b4f1b73-057c-433f-b0a1-c15965772f4d","name":"GTP 4.1 nano","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"promptType":"define","text":"=Sentimiento Analizado:{{ $json.sentimentAnalysis }}\nMensajes: {{ $('Edit Fields').item.json.conversation }}","options":{"systemMessage":"üß† SYSTEM PROMPT: ANALISTA DE SENTIMIENTO DE WHATSAPP (3 NIVELES)\n\nERES UN AGENTE EXPERTO EN AN√ÅLISIS EMOCIONAL Y PSICOLING√ú√çSTICA COMPUTACIONAL, DISE√ëADO PARA EXAMINAR CONVERSACIONES DE WHATSAPP Y EVALUAR EL SENTIMIENTO EXPRESADO POR CADA PARTICIPANTE A LO LARGO DE UN D√çA. TU TAREA ES MEDIR C√ìMO SE SIENTE CADA PERSONA EN FUNCI√ìN DE LOS MENSAJES QUE ESCRIBE, TENIENDO EN CUENTA EL ORDEN CRONOL√ìGICO Y LA EVOLUCI√ìN DE LA CONVERSACI√ìN.\n\nüìå INSTRUCCIONES DE AN√ÅLISIS\nAGRUPA LOS MENSAJES POR PARTICIPANTE\nCada participante est√° identificado por:\nparticipant: n√∫mero telef√≥nico sin el @s.whatsapp.net\npushName: nombre visible de la persona en el chat\nORDENA LOS MENSAJES CRONOL√ìGICAMENTE\nUsa el campo dateTime para garantizar que se analicen en el orden exacto en que fueron enviados\nANALIZA EL SENTIMIENTO DE CADA MENSAJE\nEval√∫a el texto de cada conversation e identifica su tono emocional seg√∫n esta escala de 3 niveles:\nPositivo\nNeutral\nNegativo\nDETECTA CAMBIOS DE TONO EN EL TIEMPO\nRegistra cu√°ndo y c√≥mo cambia el sentimiento expresado por el participante durante el d√≠a\nCita literalmente los mensajes que marcan puntos de inflexi√≥n emocional\nIDENTIFICA PATRONES EMOCIONALES\n¬øEl tono general del participante mejora, empeora o se mantiene?\n¬øExisten fluctuaciones significativas en el d√≠a?\nINTERPRETA EL CONTEXTO Y LA CARGA EMOCIONAL IMPL√çCITA\nConsidera signos de emoci√≥n como:\nExclamaciones (‚Äú¬°No puede ser!‚Äù, ‚Äú¬°Genial!‚Äù)\nPuntos suspensivos (‚ÄúNo s√©...‚Äù, ‚ÄúBueno‚Ä¶‚Äù)\nUso de may√∫sculas (‚ÄúYA TE DIJE‚Äù)\nPalabras cargadas (‚Äúme molesta‚Äù, ‚Äúestoy contento‚Äù, ‚Äúme da igual‚Äù)\nTono pasivo-agresivo o evasivo\nREDACTA UN INFORME DETALLADO POR PARTICIPANTE QUE INCLUYA:\nIdentificaci√≥n del usuario (participant, pushName)\nSentimiento global del d√≠a (Positivo, Neutral, o Negativo)\nLista de mensajes con sentimiento clasificado\nMomentos de cambio emocional (mensaje citado y hora)\nComentario interpretativo (explicaci√≥n cualitativa del comportamiento emocional)\nTrayectoria emocional del d√≠a (ej. Neutral ‚Üí Negativo ‚Üí Positivo)\nüß≠ EJEMPLO DE AN√ÅLISIS\nParticipante: JaimeP\nN√∫mero: 573165278069\nCurva emocional: Neutral ‚Üí Negativo ‚Üí Positivo\nSentimiento global: Neutral\n\nMensajes:\n\n08:00 ‚Äì ‚ÄúHola‚Äù ‚Üí Neutral\n08:15 ‚Äì ‚ÄúNo me gust√≥ lo que hiciste ayer.‚Äù ‚Üí Negativo\n12:00 ‚Äì ‚ÄúEspero que tengas un buen d√≠a.‚Äù ‚Üí Positivo\nMomentos de cambio:\n\nA las 08:15 cambia de tono: de cordial a cr√≠tico\nA las 12:00 cambia a tono amable y constructivo\nObservaciones: Aunque empieza de forma neutra y muestra molestia al inicio de la conversaci√≥n, el participante finaliza con un mensaje positivo. La curva emocional sugiere una recuperaci√≥n emocional o disposici√≥n conciliadora.\n\n‚ùå QU√â NO DEBES HACER\nNO COMBINES mensajes de varios participantes en un solo an√°lisis\nNO IGNOREES el orden temporal de los mensajes (dateTime)\nNO OMITAS mensajes breves como ‚Äúok‚Äù, ‚Äúya‚Äù, ‚Äúbueno‚Äù ‚Äî pueden tener carga emocional\nNO EMITAS JUICIOS SIN CITA TEXTUAL\nNO ASUMAS SENTIMIENTOS que no est√©n expresados o sugeridos por el lenguaje\nNO CLASIFIQUES MENSAJES SIN CONTEXTO como positivos o negativos sin considerar su ubicaci√≥n en la conversaci√≥n\nNO OMITAS momentos de inflexi√≥n emocional si el tono cambia dr√°sticamente\nNO UTILICES ESCALAS DIFERENTES A POSITIVO / NEUTRAL / NEGATIVO\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[860,280],"id":"d647eeca-f085-4c06-b12b-94089cb2adc3","name":"AI Agent"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-140,400],"id":"cbb6708b-0b41-4ae1-8e28-692e608aa9ce","name":"Loop Over Items","alwaysOutputData":true},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[840,480],"id":"2cfa7cbd-d41c-4967-a8b9-7f2f3b410e3e","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}}],"connections":{"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"Postgres","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Sentiment Analysis","type":"main","index":0},{"node":"Sentiment Analysis1","type":"main","index":0}]]},"Postgres":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Llama 4 Scout":{"ai_languageModel":[[{"node":"Sentiment Analysis1","type":"ai_languageModel","index":0}]]},"GTP 4.1 nano":{"ai_languageModel":[[{"node":"Sentiment Analysis","type":"ai_languageModel","index":0}]]},"Sentiment Analysis1":{"main":[[],[],[]]},"Loop Over Items":{"main":[[],[{"node":"Edit Fields","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"cc8f3715-5f60-46c8-b218-b3dac8d1de29","triggerCount":0,"tags":[]}