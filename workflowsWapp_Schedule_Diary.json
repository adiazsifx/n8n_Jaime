{"createdAt":"2025-05-15T21:13:22.939Z","updatedAt":"2025-05-20T19:04:01.000Z","id":"SfhJJJaH6ImIHMCv","name":"Wapp_Schedule_Diary","active":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-1140,-100],"id":"bd890a89-6e0d-444a-a38c-9fe7ea7c869e","name":"When clicking ‘Test workflow’"},{"parameters":{"operation":"executeQuery","query":"SELECT json_build_object(\n  'data', json_agg(\n    json_build_object(\n      'nombrechat', chat_name,\n      'messages', messages\n    )\n  )\n) AS result\nFROM (\n  SELECT \n    nombrechat AS chat_name,\n    json_agg(\n      json_build_object(\n        'id', id,\n        'dateTime', to_char(\"dateTime\", 'YYYY-MM-DD\"T\"HH24:MI:SS.MS\"Z\"'),\n        'messages', conversation,\n        'pushName', \"pushName\",\n        'participant', participant\n      ) ORDER BY \"dateTime\"\n    ) AS messages\n  FROM messages\n  WHERE \"dateTime\" >= (NOW() - INTERVAL '24 hours')\n  GROUP BY nombrechat\n) subquery;","options":{"connectionTimeout":30,"replaceEmptyStrings":true}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-920,-100],"id":"9353787f-aed9-4cb4-9cc6-9c3e403f9d19","name":"Postgres","credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}}},{"parameters":{"promptType":"define","text":"={{ $json['result.data'] }}","options":{"systemMessage":"=ERES UN ANALISTA LINGÜÍSTICO FORENSE ESPECIALIZADO EN DETECCIÓN DE SENTIMIENTOS NEGATIVOS Y SU CAUSALIDAD EN INTERACCIONES DE CLIENTES. YA SE TE HAN PROPORCIONADO TRES VARIABLES CLAVE QUE DEFINEN EL SENTIMIENTO DETECTADO:\n\n- CATEGORÍA DEL SENTIMIENTO: {{ $json.sentimentAnalysis.category }}\n- INTENSIDAD (FUERZA) DEL SENTIMIENTO: {{ $json.sentimentAnalysis.strength }}\n- CONFIANZA DEL ANÁLISIS: {{ $json.sentimentAnalysis.confidence }}\n\n###TU TAREA###\n\nA PARTIR DE ESTA INFORMACIÓN Y EL CONTENIDO COMPLETO DE LOS MENSAJES, DEBES DETECTAR Y EXTRAER LA(S) CAUSA(S) QUE ORIGINARON EL SENTIMIENTO NEGATIVO. ENCONTRARÁS LOS MENSAJES CLAVE, EVALUARÁS EL CONTEXTO Y GENERARÁS UN JSON CON ESTRUCTURA EXACTA PARA GESTIÓN DE CASOS.\n\n###DEVUELVE EXCLUSIVAMENTE ESTE FORMATO JSON###\n\n[\n  {\n    \"nombrechat\": \"<NOMBRE EXACTO DEL CHAT O INTERACCIÓN>\",\n    \"sentimiento_negativo_detectado\": true,\n    \"negativity_score\": {{ $json.sentimentAnalysis.strength }},\n    \"nivel_gravedad\": \"<leve | moderado | grave>\",\n    \"tipo_de_problema\": \"<CLASIFICACIÓN DEL PROBLEMA, EJ: 'impacto crítico en operación', 'mala atención', 'falta de respuesta', etc.>\",\n    \"mensajes_problema\": [\n      {\n        \"id\": \"<ID O IDENTIFICADOR DEL MENSAJE>\",\n        \"fecha\": \"<FECHA EN FORMATO ISO 8601>\",\n        \"texto\": \"<TEXTO ORIGINAL DEL MENSAJE DETONANTE>\",\n        \"autor\": \"<NOMBRE DE QUIEN ESCRIBIÓ EL MENSAJE>\",\n        \"numero\": \"<IDENTIFICADOR DEL REMITENTE>\"\n      }\n    ],\n    \"comentario_interaccion\": \"<ANÁLISIS BREVE PERO CLARO SOBRE POR QUÉ SURGE EL SENTIMIENTO NEGATIVO SEGÚN EL TEXTO, EL TONO Y LA SITUACIÓN REPORTADA>\"\n  }\n]\n\n###CADENA DE PENSAMIENTO PARA GUIAR TU ANÁLISIS###\n\nENTENDER CONTEXTO Y VARIABLES: INTERPRETA {{ $json.sentimentAnalysis.category }} COMO LA CATEGORÍA GLOBAL DEL SENTIMIENTO, USA {{ $json.sentimentAnalysis.strength }} COMO UNA PISTA DE SU GRAVEDAD, Y CONSIDERA {{ $json.sentimentAnalysis.confidence }} PARA RESPALDAR TUS CONCLUSIONES.\n\nEXTRAER: BUSCA EXPRESIONES CLAVE DE QUEJA, URGENCIA, MOLESTIA O DESCONFORMIDAD.\n\nSELECCIONAR: IDENTIFICA EL MENSAJE O GRUPO DE MENSAJES QUE ORIGINARON EL SENTIMIENTO NEGATIVO. DEBEN ESTAR PRESENTES EN mensajes_problema.\n\nANALIZAR: DETERMINA EL TIPO DE PROBLEMA E IMPACTO (LEVE, MODERADO O GRAVE), SEGÚN LENGUAJE Y CONTEXTO.\n\nSINTETIZAR: REDACTA EN comentario_interaccion UNA EXPLICACIÓN DIRECTA DE LO QUE OCURRIÓ Y CÓMO SE RELACIONA CON EL SENTIMIENTO.\n\nVALIDAR: ASEGÚRATE DE QUE TODOS LOS CAMPOS SE LLENEN CORRECTAMENTE, SIN OMITIR INFORMACIÓN RELEVANTE.\n\n###QUÉ NO HACER (NEGATIVE PROMPT)###\n\nNO GENERES TEXTO FUERA DEL JSON\n\nNO CAMBIES EL NOMBRE NI ORDEN DE LOS CAMPOS JSON\n\nNO INCLUYAS EL SENTIMIENTO COMO CATEGORÍA SI YA ESTÁ EN LA VARIABLE\n\nNO IGNORAR LOS MENSAJES DONDE SE DETONA EL SENTIMIENTO\n\nNO DEJES CAMPOS VACÍOS NI AGREGUES DATOS SUPUESTOS O INVENTADOS\n\nNO OMITAS COMENTARIO NI CIERRES LA RESPUESTA SIN JUSTIFICAR EL SENTIMIENTO"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[160,-40],"id":"94a83e36-a879-4501-a5ba-d69108373580","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[40,200],"id":"b887b076-3904-4b84-be11-cb1d89862f78","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"jsCode":"const rawData = $input.all()[0].json.output;\n\n// El formato del input parece ser un string JSON con comillas al inicio y final\n// Primero limpiamos posibles comillas extras al inicio y final\nlet cleanData = rawData;\nif (typeof rawData === 'string') {\n  // Eliminar comillas dobles al inicio y final si existen\n  cleanData = rawData.trim();\n  if (cleanData.startsWith('\"') && cleanData.endsWith('\"')) {\n    cleanData = cleanData.substring(1, cleanData.length - 1);\n  }\n  \n  // Reemplazar posibles escapes de comillas dobles\n  cleanData = cleanData.replace(/\\\\\"/g, '\"');\n}\n\n// Intentamos parsear el JSON\nlet parsedData;\ntry {\n  parsedData = JSON.parse(cleanData);\n} catch (error) {\n  console.error('Error al parsear JSON:', error);\n  // Si falla, devolvemos un array vacío o manejamos el error según necesidad\n  parsedData = [];\n}\n\n// Aseguramos que tenemos un array para mapear\nconst itemsArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n\nreturn itemsArray.map(item => {\n  // Objeto de resultado con las propiedades requeridas\n  const result = {\n    json: {\n      nombreChat: item.nombrechat || '',\n      sentimientoNegativo: item.sentimiento_negativo_detectado || false,\n      puntuacionNegatividad: item.negativity_score || 0,\n      nivelGravedad: item.nivel_gravedad || '',\n      tipoProblema: item.tipo_de_problema || '',\n      mensajesProblema: item.mensajes_problema || [],\n      comentarioInteraccion: item.comentario_interaccion || '',\n      \n      // Extraemos los detalles de todos los mensajes\n      mensajesDetalle: (item.mensajes_problema || []).map(mensaje => ({\n        id: mensaje.id || '',\n        fecha: mensaje.dateTime || '', // Notamos que ahora usa 'dateTime' en lugar de 'fecha'\n        texto: mensaje.texto || '',\n        autor: mensaje.autor || '',\n        numero: mensaje.numero || ''\n      }))\n    }\n  };\n  \n  return result;\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[520,-40],"id":"b0242d5c-d51f-4630-8f7b-9b7aa30a7699","name":"Code","alwaysOutputData":true},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Alerta de Sentimientos Negativos</title>\n    <style>\n        /* Estilos generales compatibles con Outlook */\n        body {\n            font-family: 'Segoe UI', Arial, sans-serif;\n            color: #333333;\n            margin: 0;\n            padding: 0;\n            background-color: #f0f5fa;\n        }\n        table {\n            border-collapse: collapse;\n            mso-table-lspace: 0pt;\n            mso-table-rspace: 0pt;\n        }\n        td {\n            vertical-align: top;\n            padding: 0;\n        }\n        .container {\n            width: 100%;\n            max-width: 650px;\n            margin: 0 auto;\n            background-color: #ffffff;\n        }\n        .header {\n            background-color: #003366;\n            color: white;\n            padding: 20px;\n            text-align: center;\n        }\n        .title {\n            font-size: 24px;\n            font-weight: bold;\n            margin: 0;\n        }\n        .subtitle {\n            font-size: 16px;\n            margin-top: 5px;\n            color: #b3d1ff;\n        }\n        .alerts-header {\n            background-color: #003366;\n            color: white;\n            padding: 10px 15px;\n            font-size: 16px;\n            font-weight: bold;\n        }\n        .cliente-header {\n            background-color: #1a4f8a;\n            color: white;\n            padding: 10px 15px;\n        }\n        .cliente-title {\n            font-size: 18px;\n            font-weight: bold;\n        }\n        .severity-grave {\n            background-color: #a83c3c;\n            color: white;\n            padding: 4px 8px;\n            border-radius: 3px;\n            font-size: 12px;\n            font-weight: bold;\n            text-transform: uppercase;\n        }\n        .severity-moderado {\n            background-color: #d68c45;\n            color: white;\n            padding: 4px 8px;\n            border-radius: 3px;\n            font-size: 12px;\n            font-weight: bold;\n            text-transform: uppercase;\n        }\n        .severity-leve {\n            background-color: #d6be45;\n            color: #333333;\n            padding: 4px 8px;\n            border-radius: 3px;\n            font-size: 12px;\n            font-weight: bold;\n            text-transform: uppercase;\n        }\n        .info-table {\n            width: 100%;\n            border: 0;\n        }\n        .info-table td {\n            padding: 8px;\n            border-bottom: 1px solid #e6eff7;\n        }\n        .info-label {\n            width: 30%;\n            font-weight: bold;\n            color: #1a4f8a;\n        }\n        .info-value {\n            width: 70%;\n        }\n        .negativity-cell {\n            padding: 12px 8px;\n            background-color: #e6eff7;\n        }\n        .negativity-level {\n            text-align: center;\n            font-weight: bold;\n            padding: 8px 0;\n            border-radius: 3px;\n            color: white;\n            margin: 0 auto;\n            width: 90%;\n            max-width: 400px;\n        }\n        .negativity-high {\n            background-color: rgba(168, 60, 60, 0.8);\n        }\n        .negativity-medium {\n            background-color: rgba(214, 140, 69, 0.8);\n        }\n        .negativity-low {\n            background-color: rgba(214, 190, 69, 0.7);\n            color: #333;\n        }\n        .messages-header {\n            padding: 10px 8px;\n            background-color: #1a4f8a;\n            color: white;\n            font-weight: bold;\n        }\n        .message-table {\n            width: 100%;\n            border: 0;\n            margin-bottom: 10px;\n        }\n        .message-header-row {\n            background-color: #e6eff7;\n        }\n        .message-author {\n            padding: 8px;\n            font-weight: bold;\n            color: #1a4f8a;\n            width: 50%;\n        }\n        .message-time {\n            padding: 8px;\n            color: #666666;\n            font-size: 12px;\n            text-align: right;\n            width: 50%;\n        }\n        .message-text {\n            padding: 10px 8px;\n            line-height: 1.4;\n            white-space: pre-line;\n        }\n        .footer {\n            background-color: #003366;\n            padding: 15px;\n            text-align: center;\n            color: #b3d1ff;\n            font-size: 12px;\n        }\n    </style>\n</head>\n<body>\n  <table class=\"container\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"650\">\n    <tr>\n      <td class=\"header\">\n        <h1 class=\"title\">Alerta de Sentimientos Negativos</h1>\n        <div class=\"subtitle\">Detección de interacciones negativas en chats de soporte</div>\n      </td>\n    </tr>\n\n    <tr>\n      <td style=\"padding:20px;\">\n        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin-bottom:15px;\">\n          <tr>\n            <td class=\"alerts-header\">\n              Alertas detectadas: {{ $json.length }}\n            </td>\n          </tr>\n        </table>\n\n        {{ each($json) }}\n        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"\n          style=\"margin-bottom:15px; border:1px solid #ccddf2;\">\n          <tr>\n            <td class=\"cliente-header\">\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                <tr>\n                  <td width=\"70%\" class=\"cliente-title\">{{ $json[$index].nombreChat }}</td>\n                  <td width=\"30%\" align=\"right\">\n                    <span class=\"severity-{{ $json[$index].nivelGravedad }}\">{{ $json[$index].nivelGravedad }}</span>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <tr>\n            <td>\n              <table class=\"info-table\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                <tr>\n                  <td class=\"info-label\">Tipo de problema:</td>\n                  <td class=\"info-value\">{{ $json.tipoProblema }}</td>\n                </tr>\n                <tr>\n                  <td class=\"info-label\">Comentario:</td>\n                  <td class=\"info-value\">{{ $json.comentarioInteraccion }}</td>\n                </tr>\n                <tr>\n                  <td colspan=\"2\" class=\"negativity-cell\">\n                    <div style=\"text-align:center;\">\n                      {{ ($json.puntuacionNegatividad >= 0.8) }}\n                      <div class=\"negativity-level negativity-high\">\n                        Nivel de negatividad: {{ $json.puntuacionNegatividad }} - ALTO\n                      </div>\n                      {{ ($json.puntuacionNegatividad >= 0.6) }}\n                      <div class=\"negativity-level negativity-medium\">\n                        Nivel de negatividad: {{ $json.puntuacionNegatividad }} - MEDIO\n                      </div>\n                       <div class=\"negativity-level negativity-low\">\n                        Nivel de negatividad: {{ $json.puntuacionNegatividad }} - BAJO\n                      </div>\n                     </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <tr>\n            <td class=\"messages-header\">\n              Mensajes detectados:\n            </td>\n          </tr>\n\n          <tr>\n            <td style=\"padding:10px;\">\n              {{ ($json.mensajesDetalle) }}\n              <table class=\"message-table\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"border:1px solid #e6eff7;\">\n                <tr class=\"message-header-row\">\n                  <td class=\"message-author\">{{ $json.mensajesDetalle[0].autor }}</td>\n                  <td class=\"message-time\">{{ $json.mensajesDetalle[0].fecha }}</td>\n                </tr>\n                <tr>\n                  <td colspan=\"2\" class=\"message-text\">{{ $json.mensajesDetalle[0].texto }}</td>\n                </tr>\n              </table>\n              <div style=\"height:10px;\"></div>\n             </td>\n          </tr>\n        </table>\n       </tr>\n\n    <tr>\n      <td class=\"footer\">\n        Sistema de Análisis de Sentimientos | © 2025 IFX\n        <br>\n        Esta alerta ha sido generada automáticamente.\n      </td>\n    </tr>\n  </table>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[740,-40],"id":"a5957c17-ab9c-4242-ae8b-9bdc2e4334e2","name":"HTML"},{"parameters":{"inputText":"={{ $json['result.data'].messages[0].messages }}","options":{"categories":"Positive, Neutral, Negative","systemPromptTemplate":"You are highly intelligent and accurate sentiment analyzer. Analyze the sentiment of the provided text. Categorize it into one of the following: {categories}. Use the provided formatting instructions. Only output the JSON.","includeDetailedResults":true,"enableAutoFixing":true}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[-240,-140],"id":"4616587f-1b3f-4c09-9a78-a3a42ca3efec","name":"Sentiment Analysis"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-500,-180],"id":"f4d0d486-69e6-41d7-a12c-50d3b882f26e","name":"Loop Over Items"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-360,40],"id":"a45f0dba-5f7f-463c-bbe9-a4f17b4d1253","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"fieldToSplitOut":"result.data","include":"allOtherFields","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-700,-100],"id":"993f5888-6f79-4e94-b273-c7d1adb0cc50","name":"Split Out"},{"parameters":{"fromEmail":"sadian88@gmail.com","toEmail":"sadian88@gmail.com","subject":"Email Test WorkFlow","html":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[1040,-40],"id":"f8e29bf5-5a4f-4b7f-9ac4-b1eeabe2948f","name":"Send Email","webhookId":"6ce0be94-2a5e-4615-952f-ebe4285e2c36","credentials":{"smtp":{"id":"K7Y8XXXqNwyqSCdz","name":"SMTP account 2"}}}],"connections":{"When clicking ‘Test workflow’":{"main":[[{"node":"Postgres","type":"main","index":0}]]},"Postgres":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"HTML","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Sentiment Analysis","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Sentiment Analysis","type":"ai_languageModel","index":0}]]},"Split Out":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Sentiment Analysis":{"main":[[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}]]},"HTML":{"main":[[{"node":"Send Email","type":"main","index":0}]]},"Send Email":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"844bcdae-cfe7-44e0-8156-94c68c439a96","triggerCount":0,"tags":[]}