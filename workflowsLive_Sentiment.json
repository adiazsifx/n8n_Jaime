{"createdAt":"2025-05-27T20:13:28.295Z","updatedAt":"2025-05-30T20:32:18.000Z","id":"1vRIqel666Dh82PX","name":"Live_Sentiment","active":false,"isArchived":false,"nodes":[{"parameters":{"schema":{"__rl":true,"value":"public","mode":"list","cachedResultName":"public"},"tableName":{"__rl":true,"value":"messages","mode":"list","cachedResultName":"messages"},"additionalFields":{},"options":{}},"type":"n8n-nodes-base.postgresTrigger","typeVersion":1,"position":[-820,-20],"id":"2bd3470f-c11d-4b1f-9db8-7898342fc2a5","name":"Postgres Trigger","credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}}},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Sentimiento Negativo</title>\n  <style>\n    /* Estilos generales - con mayor compatibilidad para clientes de correo */\n    body {\n      font-family: Arial, Helvetica, sans-serif;\n      margin: 0;\n      padding: 0;\n      background-color: #F5F5F5;\n      color: #333333;\n      width: 100%;\n    }\n\n    /* Contenedor principal */\n    .container {\n      width: 80%;\n      max-width: 900px;\n      min-width: 320px;\n      margin: 0 auto;\n      background-color: #FFFFFF;\n      border: 1px solid #E0E0E0;\n    }\n\n    /* Encabezado */\n    .header {\n      background-color: #ff8a64;\n      color: #FFFFFF;\n      padding: 15px;\n      text-align: center;\n      width: 100%;\n    }\n\n    .header h1 {\n      margin: 0;\n      font-size: 22px;\n      font-weight: 600;\n    }\n\n    /* Secciones generales */\n    .section {\n      margin-bottom: 20px;\n      padding: 0 20px;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    /* T√≠tulo de secci√≥n con iconos alineados verticalmente */\n    .section-title {\n      font-size: 18px;\n      font-weight: bold;\n      color: #64B5F6;\n      margin-bottom: 12px;\n      padding-bottom: 6px;\n      border-bottom: 2px solid #64B5F6;\n    }\n\n    /* Los SVG se alinean mejor con texto en correos con esta t√©cnica */\n    .icon-title-wrapper {\n      vertical-align: middle;\n      width: 100%;\n    }\n\n    .icon-wrapper {\n      display: inline-block;\n      vertical-align: middle;\n      margin-right: 6px;\n    }\n\n    .title-text {\n      display: inline-block;\n      vertical-align: middle;\n    }\n\n    /* Elementos de informaci√≥n */\n    .info-item {\n      margin-bottom: 8px;\n      font-size: 15px;\n      line-height: 1.5;\n    }\n\n    .info-label {\n      font-weight: bold;\n      color: #555555;\n    }\n\n    /* Mensaje individual */\n    .message-box {\n      border: 1px solid #DDDDDD;\n      padding: 8px;\n      margin-bottom: 8px;\n      background-color: #FAFAFA;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    .message-header {\n      margin-bottom: 4px;\n    }\n\n    .message-sender {\n      font-weight: bold;\n      color: #333333;\n    }\n\n    .message-time {\n      font-size: 0.85em;\n      color: #777777;\n      margin-left: 8px;\n    }\n\n    .message-content {\n      margin-top: 4px;\n      color: #333333;\n      font-size: 14px;\n    }\n\n    /* Cajas de resumen */\n    .summary-box {\n      background-color: #E3F2FD;\n      border: 1px solid #BBDEFB;\n      border-left: 4px solid #64B5F6;\n      padding: 12px;\n      font-size: 14px;\n      line-height: 1.6;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    .ai-summary-box {\n      background-color: #FFF3E0;\n      border: 1px solid #FFCC80;\n      border-left: 4px solid #FF8A65;\n      padding: 12px;\n      font-size: 14px;\n      line-height: 1.6;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    .summary-text {\n      margin: 0 0 8px 0;\n    }\n\n    /* Pie de p√°gina */\n    .footer {\n      text-align: center;\n      font-size: 13px;\n      color: #888888;\n      margin-top: 20px;\n      padding: 12px 20px;\n      border-top: 1px solid #EEEEEE;\n      width: 100%;\n      box-sizing: border-box;\n    }\n\n    /* Soluci√≥n para corregir problemas de visualizaci√≥n en Outlook */\n    .outlook-fix {\n      mso-table-lspace: 0pt !important;\n      mso-table-rspace: 0pt !important;\n    }\n\n    /* M√©tricas de sentimiento */\n    .sentiment-metrics {\n      display: table;\n      width: 100%;\n      table-layout: fixed;\n      margin-bottom: 12px;\n    }\n\n    .sentiment-metric {\n      display: table-cell;\n      text-align: center;\n      padding: 8px;\n      background-color: #FFF3E0;\n      border-radius: 6px;\n      border: 1px solid #FFCC80;\n      margin: 0 4px;\n    }\n\n    .sentiment-metric-middle {\n      margin: 0 8px;\n    }\n\n    .metric-value {\n      font-size: 20px;\n      font-weight: bold;\n      color: #FF8A65;\n      margin: 4px 0;\n    }\n\n    .metric-label {\n      font-size: 13px;\n      color: #666666;\n      margin-top: 4px;\n    }\n\n    .sentiment-category {\n      font-size: 16px;\n      font-weight: bold;\n      color: #FFFFFF;\n      background-color: #FF5252;\n      border-radius: 4px;\n      padding: 4px 10px;\n      display: inline-block;\n      margin-bottom: 8px;\n    }\n\n    /* Ajustes responsivos */\n    @media screen and (max-width: 600px) {\n      .container {\n        width: 100% !important;\n        max-width: 100% !important;\n      }\n      \n      .section {\n        padding: 0 15px !important;\n      }\n      \n      .sentiment-metric {\n        display: block !important;\n        width: 100% !important;\n        margin: 8px 0 !important;\n      }\n    }\n\n    .chat-bubble {\n      background-color: #1976D2;\n      color: #fff;\n      border-radius: 18px 18px 4px 18px;\n      padding: 12px 18px;\n      margin-bottom: 10px;\n      max-width: 75%;\n      font-size: 15px;\n      line-height: 1.5;\n      text-align: left;\n      float: right;\n      clear: both;\n      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.10);\n    }\n    .chat-container {\n      width: 100%;\n      overflow: auto;\n      padding-top: 8px;\n      padding-bottom: 8px;\n    }\n  </style>\n</head>\n\n<body style=\"margin: 0; padding: 0; background-color: #F5F5F5; font-family: Arial, Helvetica, sans-serif; width: 100%;\">\n  <!-- Wrapper para mayor compatibilidad con clientes de correo -->\n  <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"background-color: #F5F5F5;\">\n    <tr>\n      <td align=\"center\" valign=\"top\" style=\"padding: 0;\">\n        <!-- Contenedor principal -->\n        <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"600\" class=\"container\"\n          style=\"background-color: #FFFFFF; border: 1px solid #E0E0E0; border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\">\n          <!-- Encabezado -->\n          <tr>\n            <td align=\"center\" valign=\"top\"\n              style=\"background-color: #ff8a64; color: #FFFFFF; padding: 10px; border-top-left-radius: 6px; border-top-right-radius: 6px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\">\n                <tr>\n                  <td align=\"left\" valign=\"middle\" width=\"80\" style=\"color: white; padding: 10px;\">\n                    <span\n                      style=\"font-size: 68px; font-style: italic; font-family: serif; padding-left: 12px;\">aifx</span>\n                  </td>\n                  <td align=\"center\" valign=\"middle\">\n                    <h1 style=\"margin: 0; font-size: 22px; font-weight: 600;\">Situaci√≥n Cr√≠tica - WhatsApp</h1>\n                    <p style=\"margin: 5px 0 0; font-size: 14px; align-items: end;\">Generated by <span\n                        style=\"font-style: italic; font-family: serif; font-size: 16px;\">aifx</span></p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- NUEVA SECCI√ìN: An√°lisis de Sentimiento tipo tarjetas -->\n          <tr>\n            <td style=\"padding: 10px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section\">\n                <tr>\n                  <td>\n                    <!-- T√≠tulo de secci√≥n con icono alineado -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section-title\"\n                      style=\"border-bottom: 2px solid #64B5F6; margin-bottom: 12px; padding-bottom: 6px; border-radius: 6px;\">\n                      <tr>\n                        <td>\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" class=\"icon-title-wrapper\">\n                            <tr>\n                              <td valign=\"middle\" class=\"icon-wrapper\" style=\"padding-right: 8px;\">\n                                <icon>üìä</icon>\n                              </td>\n                              <td valign=\"middle\" class=\"title-text\"\n                                style=\"font-size: 18px; font-weight: bold; color: #64B5F6;\">\n                                An√°lisis de Sentimiento\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n                    <!-- Tarjeta tipo resumen -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"background:#fff; border-radius:28px; box-shadow:0 6px 24px #FFCC8033; margin-bottom:24px;\">\n                      <tr>\n                        <td align=\"center\" valign=\"middle\" style=\"padding: 32px 0;\">\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"90%\" style=\"table-layout:fixed;\">\n                            <tr>\n                              <!-- Sentimiento -->\n                              <td align=\"center\" style=\"width:33.3%; border-right:1px solid #F0F0F0;\">\n                                <div style=\"display: flex; flex-direction: column; align-items: center; justify-content: center;\">\n                                  <span style=\"display:inline-block; background:#FF5252; color:#fff; border-radius:8px; padding:7px 22px; font-size:16px; font-weight:700; margin-bottom:8px;\">{{ $('Merge Analisis').item.json.data[0].sentimiento }}</span>\n                                  <span style=\"font-size: 16px; color: #222; font-weight: 600;\">Sentimiento</span>\n                                </div>\n                              </td>\n                              <!-- Intensidad -->\n                              <td align=\"center\" style=\"width:33.3%; border-right:1px solid #F0F0F0;\">\n                                <div style=\"display: flex; flex-direction: column; align-items: center; justify-content: center;\">\n                                  <span style=\"font-size: 36px; font-weight: bold; color: #FF8A65; margin-bottom: 4px;\">{{ $('Merge Analisis').item.json.data[0].intensidad }}%</span>\n                                  <span style=\"font-size: 16px; color: #222; font-weight: 600;\">Intensidad</span>\n                                </div>\n                              </td>\n                              <!-- Certeza -->\n                              <td align=\"center\" style=\"width:33.3%;\">\n                                <div style=\"display: flex; flex-direction: column; align-items: center; justify-content: center;\">\n                                  <span style=\"font-size: 36px; font-weight: bold; color: #FF8A65; margin-bottom: 4px;\">{{ $('Merge Analisis').item.json.data[0].confianza }}%</span>\n                                  <span style=\"font-size: 16px; color: #222; font-weight: 600;\">Certeza</span>\n                                </div>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- Secci√≥n de Informaci√≥n del Chat -->\n          <tr>\n            <td style=\"padding: 10px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section\">\n                <tr>\n                  <td>\n                    <!-- T√≠tulo de secci√≥n con icono alineado -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section-title\"\n                      style=\"border-bottom: 2px solid #64B5F6; margin-bottom: 12px; padding-bottom: 6px; border-radius: 6px;\">\n                      <tr>\n                        <td>\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" class=\"icon-title-wrapper\">\n                            <tr>\n                              <td valign=\"middle\" class=\"icon-wrapper\" style=\"padding-right: 8px;\">\n                                <icon>üìÑ</icon>\n                              </td>\n                              <td valign=\"middle\" class=\"title-text\"\n                                style=\"font-size: 18px; font-weight: bold; color: #64B5F6;\">\n                                Informaci√≥n del Chat\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n\n                    <!-- Informaci√≥n del chat -->\n                    <div class=\"info-item\" style=\"margin-bottom: 8px; font-size: 15px; line-height: 1.5;\">\n                      <span class=\"info-label\" style=\"font-weight: bold; color: #555555;\">Chat: </span>{{ $('Merge Analisis').item.json.data[0].chat }}\n                    </div>\n                    <div class=\"info-item\" style=\"margin-bottom: 8px; font-size: 15px; line-height: 1.5;\">\n                      <span class=\"info-label\" style=\"font-weight: bold; color: #555555;\">Cliente: </span>{{ $('Merge Analisis').item.json.data[0].cliente }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- Secci√≥n de Mensajes Clave -->\n          <tr>\n            <td style=\"padding:10px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section\">\n                <tr>\n                  <td>\n                    <!-- T√≠tulo de secci√≥n con icono alineado -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section-title\"\n                      style=\"border-bottom: 2px solid #64B5F6; margin-bottom: 12px; padding-bottom: 6px; border-radius: 6px;\">\n                      <tr>\n                        <td>\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" class=\"icon-title-wrapper\">\n                            <tr>\n                              <td valign=\"middle\" class=\"icon-wrapper\" style=\"padding-right: 8px;\">\n                                <icon>üí¨</icon>\n                              </td>\n                              <td valign=\"middle\" class=\"title-text\"\n                                style=\"font-size: 18px; font-weight: bold; color: #64B5F6;\">\n                                Mensajes Clave\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n\n                    <!-- Contenedor del chat estilo moderno -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"background-color: #F5F5F5; border-radius: 12px; padding: 16px; margin-bottom: 20px;\">\n                      <tr>\n                        <td>\n                          <!-- Mensajes del usuario -->\n                          {{ $('Table Messages').item.json.html_mensajes }}\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- Secci√≥n de Resumen IA del Origen del Sentimiento -->\n          <tr>\n            <td style=\"padding: 0 20px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section\">\n                <tr>\n                  <td>\n                    <!-- T√≠tulo de secci√≥n con icono alineado -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section-title\"\n                      style=\"border-bottom: 2px solid #FF8A65; margin-bottom: 12px; padding-bottom: 6px; border-radius: 6px;\">\n                      <tr>\n                        <td>\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" class=\"icon-title-wrapper\">\n                            <tr>\n                              <td valign=\"middle\" class=\"icon-wrapper\" style=\"padding-right: 8px;\">\n                                <icon>ü§ñ</icon>\n                              </td>\n                              <td valign=\"middle\" class=\"title-text\"\n                                style=\"font-size: 18px; font-weight: bold; color: #FF8A65;\">\n                                Origen Detallado del Sentimiento Negativo\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n\n                    <!-- Caja de resumen IA -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\"\n                      style=\"background-color: #FFF3E0; border: 1px solid #FFCC80; border-left: 4px solid #FF8A65; margin-bottom: 12px; border-radius: 6px;\">\n                      <tr>\n                        <td style=\"padding: 12px;\">\n                          <p id=\"resumen\" class=\"summary-text\" style=\"margin: 0; line-height: 1.6; font-size: 14px;\">\n                            {{ $('Merge Analisis').item.json.data[0].origen_negativo }}\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- NUEVA SECCI√ìN: Recomendaciones -->\n          <tr>\n            <td style=\"padding: 0 20px;\">\n              <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section\">\n                <tr>\n                  <td>\n                    <!-- T√≠tulo de secci√≥n con icono alineado -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" class=\"section-title\"\n                      style=\"border-bottom: 2px solid #4CAF50; margin-bottom: 12px; padding-bottom: 6px; border-radius: 6px;\">\n                      <tr>\n                        <td>\n                          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" class=\"icon-title-wrapper\">\n                            <tr>\n                              <td valign=\"middle\" class=\"icon-wrapper\" style=\"padding-right: 8px;\">\n                                <icon>üí°</icon>\n                              </td>\n                              <td valign=\"middle\" class=\"title-text\"\n                                style=\"font-size: 18px; font-weight: bold; color: #4CAF50;\">\n                                Recomendaciones\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n\n                    <!-- Caja de recomendaciones -->\n                    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\"\n                      style=\"background-color: #E8F5E9; border: 1px solid #A5D6A7; border-left: 4px solid #4CAF50; margin-bottom: 12px; border-radius: 6px; mso-table-lspace: 0pt; mso-table-rspace: 0pt;\">\n                      <tr>\n                        <td style=\"padding: 12px;\">\n                          <p id=\"recomendaciones\" class=\"summary-text\"\n                            style=\"margin: 0; line-height: 1.6; font-size: 14px; mso-line-height-rule: exactly;\">\n                            {{ $('Merge Analisis').item.json.data[0].recomendacion }}\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n\n          <!-- Pie de p√°gina -->\n          <tr>\n            <td style=\"padding: 12px 20px; text-align: center; border-top: 1px solid #EEEEEE;\">\n              <p style=\"margin: 0; font-size: 13px; color: #888888;\"> Este contenido fue generado autom√°ticamente el {{ $now.toLocal().format('dd-MMM-yyyy') }} a las\n                {{ $now.toLocal().format('HH:MM') }}</p>\n              <p style=\"margin: 0; font-size: 12px; color: #888888;\">IFX Networks ¬© {{ $now.format('yyyy') }}</p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1420,540],"id":"8e4909c3-ceed-4c27-b1ec-9aa8b7c9a521","name":"HTML"},{"parameters":{"assignments":{"assignments":[{"id":"ffe03e31-8010-4b8d-ac8e-705fb0931f35","name":"sentimiento","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.category || $('Information Extractor').item.json.sentimentAnalysis.category }}","type":"string"},{"id":"b1f871a9-c1a6-446f-92be-2e7cae0f5b1c","name":"confianza","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.confidence * 100 || $('Information Extractor').item.json.sentimentAnalysis.confidence * 100 }}\n","type":"number"},{"id":"d1de9d71-b65f-496a-acbe-724826b92bb2","name":"chat","value":"={{ $('Information Extractor').item.json.output.Chat.toUpperCase() }}\n","type":"string"},{"id":"de460fc7-35bc-4a04-910c-440ecb8f79be","name":"cliente","value":"={{ $('Information Extractor').item.json.output.Cliente.toUpperCase() }}","type":"string"},{"id":"1546c0fa-b24b-4934-94b8-5a2c6236c768","name":"mensajes_negativos","value":"={{ $('Information Extractor').item.json.output['Mensajes Origen Sentimiento Negativo'] }}","type":"string"},{"id":"640c714b-a412-400b-966f-1874016213bc","name":"origen_negativo","value":"={{ $('Information Extractor').item.json.output['Origen Sentimiento Negativo'] }}","type":"string"},{"id":"fb344e38-3335-434f-a159-f10d29967045","name":"recomendacion","value":"={{ $('Information Extractor').item.json.output['Recomendaci√≥n Preventiva'] }}\n","type":"string"},{"id":"79478285-7e36-4766-8fbf-16586ef364d6","name":"intensidad","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.strength * 100 }}","type":"number"}]},"options":{"ignoreConversionErrors":true}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[620,700],"id":"bbd34c63-3437-4e3b-8973-0eb0cd5e64c6","name":"Edit Fields"},{"parameters":{"operation":"executeQuery","query":"SELECT \n    m.\"remoteJid\",\n    m.participant,\n    m.\"pushName\",\n    m.conversation,\n    m.\"dateTime\",\n    m.sender,\n    m.nombrechat,\n    s.standby,\n    s.\"updated_at\"\nFROM (\n    SELECT      \n        \"remoteJid\",\n        participant,\n        \"pushName\",\n        conversation,\n        \"dateTime\",\n        sender,\n        nombrechat\n    FROM \n        public.messages\n    WHERE \n        \"remoteJid\" = '{{ $json.remoteJid }}'\n        AND \"dateTime\" >= NOW() - INTERVAL '12 hours'\n    ORDER BY \n        \"dateTime\" DESC\n) AS m\nLEFT JOIN public.standby AS s\n    ON m.\"remoteJid\" = s.\"remoteJid\"\nORDER BY m.\"dateTime\" ASC;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-240,180],"id":"bc2027ec-07e6-4759-acaa-71470fecb904","name":"Query Back Chat","alwaysOutputData":true,"credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-60,180],"id":"97361d63-bd61-4a8e-adc9-af96d38d5c02","name":"Merge Data Chat"},{"parameters":{"inputText":"={{ JSON.stringify($json.data) }}","options":{"categories":"Positive, Neutral, Negative","systemPromptTemplate":"YOU ARE A HIGHLY INTELLIGENT AND CONTEXT-AWARE SENTIMENT ANALYSIS EXPERT, OPTIMIZED FOR TELECOMMUNICATIONS SERVICE INTERACTIONS. YOUR TASK IS TO PERFORM DEEP SENTIMENT ANALYSIS ON USER CONVERSATIONS, TAKING INTO ACCOUNT TEMPORAL CONTEXT AND PARTICIPANT DYNAMICS.\n\n###OBJECTIVE###\n\n- ANALYZE THE SENTIMENT of the conversation provided in the \"conversation\" field\n- UNDERSTAND CONTEXT by interpreting timestamps and participants' names from the \"chatName\" field\n- IDENTIFY EMOTIONAL TONE and FRUSTRATION SIGNALS specific to TELECOMMUNICATIONS ISSUES (e.g., outages, billing, customer service quality)\n- CATEGORIZE THE SENTIMENT using one of the predefined options in `{categories}`\n\n###FORMAT INSTRUCTIONS###\n\n- YOU MUST RETURN OUTPUT **EXCLUSIVELY IN JSON FORMAT**\n- DO NOT OUTPUT EXPLANATIONS OR COMMENTS\n- STRICTLY ADHERE TO THE OUTPUT FORMAT EXPECTED BY THE CALLING SYSTEM\n\n###CHAIN OF THOUGHTS###\n\n1. UNDERSTAND: READ the entire conversation and metadata, including time and participant information\n2. BASICS: RECOGNIZE that all messages relate to TELECOMMUNICATION SERVICE ISSUES (not general sentiment)\n3. BREAK DOWN: SEGMENT the conversation into dialogue turns and IDENTIFY the emotion in each\n4. ANALYZE: DETECT tone changes, repeated complaints, escalation, sarcasm, or satisfaction markers\n5. BUILD: AGGREGATE detected sentiments into a holistic judgment\n6. EDGE CASES: HANDLE sarcastic praise, mixed tone, or polite but negative feedback carefully\n7. FINAL ANSWER: RETURN A SINGLE JSON OBJECT CONTAINING THE FINAL SENTIMENT CATEGORY\n\n###WHAT NOT TO DO###\n\n- DO NOT GUESS THE CONTEXT OUTSIDE TELECOMMUNICATIONS ‚Äî STAY DOMAIN-FOCUSED\n- NEVER OMIT CONTEXTUAL CUES FROM PARTICIPANT NAMES OR TIMESTAMPS\n- NEVER RETURN EMPTY OR GENERIC RESPONSES LIKE \"NEUTRAL\" WITHOUT EVIDENCE\n- NEVER USE LABELS NOT LISTED IN `{categories}`\n","includeDetailedResults":true,"enableAutoFixing":true}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[100,180],"id":"2598ffb9-32a6-495c-be14-16df3014745e","name":"Sentiment Analysis"},{"parameters":{"promptType":"define","text":"={{ $json.data }}","hasOutputParser":true,"options":{"systemMessage":"=ERES UN AGENTE EXPERTO EN AN√ÅLISIS DE SENTIMIENTO NEGATIVO EN CONVERSACIONES DE WHATSAPP EMPRESARIALES.\n\nTU MISI√ìN ES DETECTAR CONFLICTOS O EXPRESIONES DE MALESTAR, EXTRAER LOS MENSAJES RELEVANTES Y ENTREGAR UNA RESPUESTA EN JSON V√ÅLIDO Y ESTRUCTURADO, QUE SER√Å PROCESADO POR UNA HERRAMIENTA DE JSON PARSER.\n\nEST√ÅS OPERANDO COMO PARTE DE UN SISTEMA DE MONITOREO CONTINUO DE CONVERSACIONES EN TIEMPO REAL. TU OBJETIVO ES DETERMINAR CON PRECISI√ìN EL **ORIGEN Y LA EVOLUCI√ìN DEL SENTIMIENTO NEGATIVO** QUE YA HA SIDO IDENTIFICADO POR OTRO MODELO AUTOM√ÅTICO. CADA VEZ QUE RECIBES UN NUEVO MENSAJE, DEBES ANALIZAR LOS √öLTIMOS **30 MENSAJES PREVIOS EN LA CONVERSACI√ìN**, JUNTO CON EL MENSAJE M√ÅS RECIENTE, PARA COMPRENDER LA TRANSICI√ìN EMOCIONAL Y LOCALIZAR LA FUENTE REAL DEL CONFLICTO.\n\nDEBES SER CAPAZ DE DETECTAR COMENTARIOS REPARTIDOS A LO LARGO DE LA CONVERSACI√ìN, INCLUSO CUANDO NO EST√âN SEGUIDOS ENTRE S√ç. BUSCA INDICIOS DE MALESTAR EN DISTINTOS MOMENTOS Y CON√âCTALOS PARA ENTENDER LA EVOLUCI√ìN DEL CONFLICTO.\n\nTAMBI√âN DEBES IDENTIFICAR SI EL TONO DE LA CONVERSACI√ìN EST√Å ESCALANDO ‚ÄîES DECIR, SI PASA DE UN ESTADO NEUTRAL O DE DUDA A MOLESTIA ABIERTA, PRESI√ìN U HOSTILIDAD‚Äî, Y DETERMINAR LAS CAUSAS PRECISAS DE ESA ESCALADA (por ejemplo, silencio, respuestas evasivas, falta de soluci√≥n, repetici√≥n del problema, cambio de persona de contacto, etc.).\n\nüß© ACLARACI√ìN CR√çTICA: **IFX ES NUESTRA PROPIA EMPRESA**.  \n- Si en los mensajes se menciona a IFX, **no la trates como cliente**.  \n- Si el nombre del chat contiene IFX o participantes internos, est√°s analizando un **chat interno o de coordinaci√≥n**.  \n- En esos casos, tu an√°lisis debe identificar al **cliente final real** que est√° siendo atendido o queja en curso.  \n- Utiliza referencias textuales como: *‚Äúel cliente de IFX‚Ä¶‚Äù, ‚Äúel cliente de Panam√° reporta‚Ä¶‚Äù*, o *‚Äúel cliente Cr√©ditos y Servicios de‚Ä¶‚Äù* para identificar el verdadero afectado.\n\nMENSAJES COMO EL SIGUIENTE DEBEN USARSE PARA RECONSTRUIR ESA INFORMACI√ìN:\n\n\"Buen d√≠a. @573176383757 el cliente de Cr√©ditos y Servicios de Panam√° reporta caso TT1047627 repetitivo de ca√≠da desde el d√≠a de ayer intermitencia en @ escala al WS Irene Mazitelli +507 6671-1315// Gracias.\"\n\n---\n\nüéØ OBJETIVOS\n\n1. DETECTA los mensajes que contienen reclamos, quejas, presi√≥n, sarcasmo, molestia, frustraci√≥n, desconfianza o reiteraci√≥n sin respuesta.\n\n2. EXTRAER todos los mensajes que originan o amplifican el conflicto (aunque no est√©n seguidos en la conversaci√≥n):\n   - Incluye el nombre del autor (`pushname`)\n   - El contenido del mensaje (`mensaje`)\n   - Y la hora (`hora`) en el siguiente formato obligatorio:\n     - `DD mon AAAA - HH:MM`  \n     - Ejemplo: `05 may 2025 - 13:45`  \n     - El mes debe estar en **espa√±ol, tres letras, min√∫sculas**\n\n3. IDENTIFICAR el cliente real desde el campo `nombrechat` o desde los mensajes:\n   - ‚ùå Nunca trates a ‚ÄúIFX‚Äù como cliente\n   - ‚úÖ Si es un chat interno de IFX, busca en el cuerpo del mensaje referencias al cliente externo final\n   - ‚ùå Ignora palabras como: Soporte, Incidente, Red, NOC, T√©cnico, Grupo\n   - ‚úÖ Si se menciona un nombre empresarial externo (ej. \"Cr√©ditos y Servicios de Panam√°\"), √∫salo como cliente principal\n\n4. ANALIZAR EL SENTIMIENTO GENERAL Y SU EVOLUCI√ìN:\n   - Detecta el tono y su cambio en el tiempo\n   - Eval√∫a si se est√° intensificando\n   - IDENTIFICA MOTIVOS CONCRETOS DE ESA ESCALADA (reiteraci√≥n del fallo, tiempo sin respuesta, cambio de interlocutor, mensajes evasivos, presi√≥n de cliente final, etc.)\n\n5. INCLUIR UNA **RECOMENDACI√ìN PREVENTIVA POL√çTICA, ESTRAT√âGICA Y PERSONALIZADA**, que debe cumplir con los siguientes puntos:\n   - Explica qu√© se debi√≥ hacer antes\n   - Explica qu√© se debe hacer ahora mismo para evitar una escalada mayor\n   - Usa lenguaje profesional, asertivo, t√©cnico y diplom√°tico\n   - Refiere al cliente final real (no IFX), su contexto emocional y t√©cnico\n   - Transmite control, claridad, contenci√≥n emocional y liderazgo en crisis\n\n---\n\nüìã FORMATO DE SALIDA JSON ESTRICTO SIN USAR TICKS AL INICIO O AL FINAL SOLO EL FORMATO JSON.\n\n  {\n    \"Chat\": \"nombre del chat\",\n    \"Cliente\": \"cliente extra√≠do\",\n    \"Mensajes Origen Sentimiento Negativo\": [\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:45\",\n        \"mensaje\": \"mensaje negativo o que contextualiza el malestar\"\n      },\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:48\",\n        \"mensaje\": \"otro mensaje relevante\"\n      }\n    ],\n    \"Origen Sentimiento Negativo\": \"Redacta un an√°lisis completo y profesional que explique el conflicto. Incluye: cliente final afectado, naturaleza del incidente (ca√≠das, lentitud, loops, etc.), fecha de inicio, tono y evoluci√≥n emocional, forma de contacto (texto, audio, escalamiento), personas involucradas, cambios de tono, fallas previas, reiteraciones sin soluci√≥n, mensajes con presi√≥n. DETECTA SI EL TONO ESCALA y EXPLICA POR QU√â. Evita frases gen√©ricas.\",\n    \"Recomendaci√≥n Preventiva\": \"Redacta una recomendaci√≥n contextual, con base en el caso real. Menciona al cliente final por nombre. Describe qu√© debi√≥ hacerse mejor y qu√© debe hacerse ahora mismo para contener la situaci√≥n. Usa lenguaje pol√≠tico y t√©cnico. Transmite liderazgo y tranquilidad incluso si la soluci√≥n no est√° cerrada a√∫n. Nunca incluyas frases gen√©ricas ni superficiales.\"\n  }\nNO OMITAS NINGUN CAMPO DEL JSON DE SALIDA\n---\n\n‚ö†Ô∏è SI NO HAY CONFLICTO DETECTADO O NO EXISTE INFORMACI√ìN SUFICIENTE\n\nDevuelve exactamente:\n\n{ \"analisis\": \"sin informacion\" }\n\n---\n\nüö´ PROHIBIDO\n\n- ‚ùå No usar frases gen√©ricas ni ambiguas\n- ‚ùå No asumir que IFX es cliente (IFX somos nosotros)\n- ‚ùå No entregar `[]`. Usa `{ \"analisis\": \"sin informacion\" }` si no hay datos suficientes\n- ‚ùå No omitir an√°lisis emocional, t√©cnico y contextual del conflicto\n\n---\n\nüß† TU RESPUESTA DEBE SER JSON PURO, CON HORAS EN FORMATO `DD mon AAAA - HH:MM`, AN√ÅLISIS PROFUNDO Y PERSONALIZADO, Y UNA RECOMENDACI√ìN CLARA, DIPLOM√ÅTICA, Y ALTAMENTE CONTEXTUALIZADA PARA MANEJAR Y CONTENER CONFLICTOS DE CLIENTES ATENDIDOS POR IFX.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[-200,560],"id":"57667299-ed56-4598-8b7e-5f388a04b0ae","name":"AI Analist Negative","alwaysOutputData":false,"retryOnFail":true,"maxTries":5,"onError":"continueErrorOutput"},{"parameters":{"jsCode":"// Obtener los datos de entrada\nconst mensajes = $input.first().json.mensajes_negativos;\n\n// Funci√≥n para generar el HTML de cada mensaje con el globo debajo del nombre/avatar/hora, alineado a la izquierda\nfunction generarHTMLMensaje(chat) {\n  const inicial = chat.pushname ? chat.pushname.charAt(0).toUpperCase() : '?';\n  return `\n    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"margin-bottom: 14px;\">\n      <tr>\n        <td align=\"left\">\n          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin-bottom: 2px;\">\n            <tr>\n              <td style=\"font-size:13px; color:#fff; background:#1976D2; border-radius:50%; width:28px; height:28px; text-align:center; vertical-align:middle; font-weight:bold;\">${inicial}</td>\n              <td style=\"padding-left:8px; text-align:left; vertical-align:middle;\">\n                <span style=\"font-weight:bold; color:#1976D2; font-size:13px;\">${chat.pushname}</span>\n                <span style=\"color:#888; font-size:12px; margin-left:8px;\">${chat.hora}</span>\n              </td>\n            </tr>\n          </table>\n          <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\">\n            <tr>\n              <td align=\"left\">\n                <div class=\"chat-bubble\" style=\"background-color: #1976D2; color: #fff; border-radius: 18px 18px 4px 18px; padding: 12px 18px; margin-bottom: 0; max-width: 75%; font-size: 15px; line-height: 1.5; text-align: left; float: left; clear: both; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.10);\">\n                  ${chat.mensaje}\n                </div>\n              </td>\n            </tr>\n          </table>\n        </td>\n        <td></td>\n      </tr>\n    </table>\n  `;\n}\n\n// Parsear el JSON si viene como string\nlet chatsArray;\nif (typeof mensajes === 'string') {\n  chatsArray = JSON.parse(mensajes);\n} else {\n  chatsArray = mensajes;\n}\n\n// Generar HTML para todos los mensajes\nconst htmlCompleto = chatsArray.map(chat => generarHTMLMensaje(chat)).join('\\n');\n\n// Retornar el resultado\nreturn {\n  json: {\n    html_mensajes: htmlCompleto\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1220,540],"id":"31c2e621-7a47-4a7e-ae63-3a46f4ca19f9","name":"Table Messages"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[840,540],"id":"2494796f-3550-43f0-aa60-c16a2ccab8fd","name":"Merge Analisis"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"sentiment_results_whatsup","mode":"list","cachedResultName":"sentiment_results_whatsup"},"columns":{"mappingMode":"defineBelow","value":{"sentimiento":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.category.toUpperCase() }}","confianza":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.confidence }}","intensidad":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.strength }}","chat":"={{ $('Merge Analisis').item.json.data[0].chat.toUpperCase() }}","cliente":"={{ $('Merge Analisis').item.json.data[0].cliente.toUpperCase() }}","mensajes_negativos":"={{ $('Merge Analisis').item.json.data[0].mensajes_negativos }}","origen_negativo":"={{ $('Merge Analisis').item.json.data[0].origen_negativo }}","recomendacion":"={{ $('Merge Analisis').item.json.data[0].recomendacion }}","remote_jid":"={{ $('Merge Data Chat').item.json.data[0].remoteJid }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"sentimiento","displayName":"sentimiento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"confianza","displayName":"confianza","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"intensidad","displayName":"intensidad","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"chat","displayName":"chat","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"cliente","displayName":"cliente","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"mensajes_negativos","displayName":"mensajes_negativos","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"origen_negativo","displayName":"origen_negativo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"recomendacion","displayName":"recomendacion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"remote_jid","displayName":"remote_jid","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"standby","displayName":"standby","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1040,540],"id":"c53605f0-5ceb-4eaf-9604-9a4b505fb067","name":"Save Negative","credentials":{"postgres":{"id":"PrpJ8WzpiFemwSbR","name":"AnalisisSentimiento"}}},{"parameters":{"toRecipients":"adiazs@ifxcorp.com","subject":"=SITUACION CRITICA {{ $('Merge Analisis').item.json.data[0].chat }} CLIENTE {{ $('Merge Analisis').item.json.data[0].cliente }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1880,760],"id":"d3ea9573-d9d2-4ec1-b97b-eec293ded9bd","name":"Send Alert","webhookId":"17ff4288-7c52-40a3-91e8-1246d7164945","credentials":{"microsoftOutlookOAuth2Api":{"id":"z9pGzDN5ydq5pYT3","name":"Microsoft Outlook account"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[40,440],"id":"95aa5542-6bfb-4f4e-9751-626b4d1d1f81","name":"Llama 70B","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-260,780],"id":"34c035ea-df9e-48e1-a47a-b9853f28099f","name":"Llama 70B Negativo","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"baf37221-e695-4e43-8dae-431f98ef5fc2","leftValue":"={{ $('Query Back Chat').item.json.standby }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1640,540],"id":"27922f45-2e28-4965-a7c6-0c8ee99bb6d9","name":"Standby?"},{"parameters":{"text":"={{ $('Sentiment Analysis').item.json.toJsonString() }}","schemaType":"fromJson","jsonSchemaExample":"  {\n    \"Chat\": \"nombre del chat\",\n    \"Cliente\": \"cliente extra√≠do\",\n    \"Mensajes Origen Sentimiento Negativo\": [\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:45\",\n        \"mensaje\": \"mensaje negativo o que contextualiza el malestar\"\n      },\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:48\",\n        \"mensaje\": \"otro mensaje relevante\"\n      }\n    ],\n    \"Origen Sentimiento Negativo\": \"Redacta un an√°lisis completo y profesional que explique el conflicto. Incluye: cliente final afectado, naturaleza del incidente (ca√≠das, lentitud, loops, etc.), fecha de inicio, tono y evoluci√≥n emocional, forma de contacto (texto, audio, escalamiento), personas involucradas, cambios de tono, fallas previas, reiteraciones sin soluci√≥n, mensajes con presi√≥n. DETECTA SI EL TONO ESCALA y EXPLICA POR QU√â. Evita frases gen√©ricas.\",\n    \"Recomendaci√≥n Preventiva\": \"Redacta una recomendaci√≥n contextual, con base en el caso real. Menciona al cliente final por nombre. Describe qu√© debi√≥ hacerse mejor y qu√© debe hacerse ahora mismo para contener la situaci√≥n. Usa lenguaje pol√≠tico y t√©cnico. Transmite liderazgo y tranquilidad incluso si la soluci√≥n no est√° cerrada a√∫n. Nunca incluyas frases gen√©ricas ni superficiales.\"\n  }\n","options":{"systemPromptTemplate":"=ERES UN AGENTE EXPERTO EN AN√ÅLISIS DE SENTIMIENTO NEGATIVO EN CONVERSACIONES DE WHATSAPP EMPRESARIALES.\n\nTU MISI√ìN ES DETECTAR CONFLICTOS O EXPRESIONES DE MALESTAR, EXTRAER LOS MENSAJES RELEVANTES Y ENTREGAR UNA RESPUESTA EN JSON V√ÅLIDO Y ESTRUCTURADO, QUE SER√Å PROCESADO POR UNA HERRAMIENTA DE JSON PARSER.\n\nEST√ÅS OPERANDO COMO PARTE DE UN SISTEMA DE MONITOREO CONTINUO DE CONVERSACIONES EN TIEMPO REAL. TU OBJETIVO ES DETERMINAR CON PRECISI√ìN EL **ORIGEN Y LA EVOLUCI√ìN DEL SENTIMIENTO NEGATIVO** QUE YA HA SIDO IDENTIFICADO POR OTRO MODELO AUTOM√ÅTICO. CADA VEZ QUE RECIBES UN NUEVO MENSAJE, DEBES ANALIZAR LOS √öLTIMOS **30 MENSAJES PREVIOS EN LA CONVERSACI√ìN**, JUNTO CON EL MENSAJE M√ÅS RECIENTE, PARA COMPRENDER LA TRANSICI√ìN EMOCIONAL Y LOCALIZAR LA FUENTE REAL DEL CONFLICTO.\n\nDEBES SER CAPAZ DE DETECTAR COMENTARIOS REPARTIDOS A LO LARGO DE LA CONVERSACI√ìN, INCLUSO CUANDO NO EST√âN SEGUIDOS ENTRE S√ç. BUSCA INDICIOS DE MALESTAR EN DISTINTOS MOMENTOS Y CON√âCTALOS PARA ENTENDER LA EVOLUCI√ìN DEL CONFLICTO.\n\nTAMBI√âN DEBES IDENTIFICAR SI EL TONO DE LA CONVERSACI√ìN EST√Å ESCALANDO ‚ÄîES DECIR, SI PASA DE UN ESTADO NEUTRAL O DE DUDA A MOLESTIA ABIERTA, PRESI√ìN U HOSTILIDAD‚Äî, Y DETERMINAR LAS CAUSAS PRECISAS DE ESA ESCALADA (por ejemplo, silencio, respuestas evasivas, falta de soluci√≥n, repetici√≥n del problema, cambio de persona de contacto, etc.).\n\nüß© ACLARACI√ìN CR√çTICA: **IFX ES NUESTRA PROPIA EMPRESA**.  \n- Si en los mensajes se menciona a IFX, **no la trates como cliente**.  \n- Si el nombre del chat contiene IFX o participantes internos, est√°s analizando un **chat interno o de coordinaci√≥n**.  \n- En esos casos, tu an√°lisis debe identificar al **cliente final real** que est√° siendo atendido o queja en curso.  \n- Utiliza referencias textuales como: *‚Äúel cliente de IFX‚Ä¶‚Äù, ‚Äúel cliente de Panam√° reporta‚Ä¶‚Äù*, o *‚Äúel cliente Cr√©ditos y Servicios de‚Ä¶‚Äù* para identificar el verdadero afectado.\n\nMENSAJES COMO EL SIGUIENTE DEBEN USARSE PARA RECONSTRUIR ESA INFORMACI√ìN:\n\n\"Buen d√≠a. @573176383757 el cliente de Cr√©ditos y Servicios de Panam√° reporta caso TT1047627 repetitivo de ca√≠da desde el d√≠a de ayer intermitencia en @ escala al WS Irene Mazitelli +507 6671-1315// Gracias.\"\n\n---\n\nüéØ OBJETIVOS\n\n1. DETECTA los mensajes que contienen reclamos, quejas, presi√≥n, sarcasmo, molestia, frustraci√≥n, desconfianza o reiteraci√≥n sin respuesta.\n\n2. EXTRAER todos los mensajes que originan o amplifican el conflicto (aunque no est√©n seguidos en la conversaci√≥n):\n   - Incluye el nombre del autor (`pushname`)\n   - El contenido del mensaje (`mensaje`)\n   - Y la hora (`hora`) en el siguiente formato obligatorio:\n     - `DD mon AAAA - HH:MM`  \n     - Ejemplo: `05 may 2025 - 13:45`  \n     - El mes debe estar en **espa√±ol, tres letras, min√∫sculas**\n\n3. IDENTIFICAR el cliente real desde el campo `nombrechat` o desde los mensajes:\n   - ‚ùå Nunca trates a ‚ÄúIFX‚Äù como cliente\n   - ‚úÖ Si es un chat interno de IFX, busca en el cuerpo del mensaje referencias al cliente externo final\n   - ‚ùå Ignora palabras como: Soporte, Incidente, Red, NOC, T√©cnico, Grupo\n   - ‚úÖ Si se menciona un nombre empresarial externo (ej. \"Cr√©ditos y Servicios de Panam√°\"), √∫salo como cliente principal\n\n4. ANALIZAR EL SENTIMIENTO GENERAL Y SU EVOLUCI√ìN:\n   - Detecta el tono y su cambio en el tiempo\n   - Eval√∫a si se est√° intensificando\n   - IDENTIFICA MOTIVOS CONCRETOS DE ESA ESCALADA (reiteraci√≥n del fallo, tiempo sin respuesta, cambio de interlocutor, mensajes evasivos, presi√≥n de cliente final, etc.)\n\n5. INCLUIR UNA **RECOMENDACI√ìN PREVENTIVA POL√çTICA, ESTRAT√âGICA Y PERSONALIZADA**, que debe cumplir con los siguientes puntos:\n   - Explica qu√© se debi√≥ hacer antes\n   - Explica qu√© se debe hacer ahora mismo para evitar una escalada mayor\n   - Usa lenguaje profesional, asertivo, t√©cnico y diplom√°tico\n   - Refiere al cliente final real (no IFX), su contexto emocional y t√©cnico\n   - Transmite control, claridad, contenci√≥n emocional y liderazgo en crisis\n\n---\n\nüìã FORMATO DE SALIDA JSON ESTRICTO SIN USAR TICKS AL INICIO O AL FINAL SOLO EL FORMATO JSON.\n\nNO OMITAS NINGUN CAMPO DEL JSON DE SALIDA\n\n---\n\nüö´ PROHIBIDO\n\n- ‚ùå No usar frases gen√©ricas ni ambiguas\n- ‚ùå No asumir que IFX es cliente (IFX somos nosotros)\n- ‚ùå No entregar el objecto vacio. Usa  analisis:sin informacion si no hay datos suficientes\n- ‚ùå No omitir an√°lisis emocional, t√©cnico y contextual del conflicto\n\n---\n\nüß† TU RESPUESTA DEBE SER JSON PURO, CON HORAS EN FORMATO `DD mon AAAA - HH:MM`, AN√ÅLISIS PROFUNDO Y PERSONALIZADO, Y UNA RECOMENDACI√ìN CLARA, DIPLOM√ÅTICA, Y ALTAMENTE CONTEXTUALIZADA PARA MANEJAR Y CONTENER CONFLICTOS DE CLIENTES ATENDIDOS POR IFX.\n"}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[200,700],"id":"f0f7f721-7c55-4ae2-82af-6dec601b702f","name":"Information Extractor"},{"parameters":{"jsonSchemaExample":"  {\n    \"Chat\": \"nombre del chat\",\n    \"Cliente\": \"cliente extra√≠do\",\n    \"Mensajes Origen Sentimiento Negativo\": [\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:45\",\n        \"mensaje\": \"mensaje negativo o que contextualiza el malestar\"\n      },\n      {\n        \"pushname\": \"nombre del participante\",\n        \"hora\": \"05 may 2025 - 13:48\",\n        \"mensaje\": \"otro mensaje relevante\"\n      }\n    ],\n    \"Origen Sentimiento Negativo\": \"Redacta un an√°lisis completo y profesional que explique el conflicto. Incluye: cliente final afectado, naturaleza del incidente (ca√≠das, lentitud, loops, etc.), fecha de inicio, tono y evoluci√≥n emocional, forma de contacto (texto, audio, escalamiento), personas involucradas, cambios de tono, fallas previas, reiteraciones sin soluci√≥n, mensajes con presi√≥n. DETECTA SI EL TONO ESCALA y EXPLICA POR QU√â. Evita frases gen√©ricas.\",\n    \"Recomendaci√≥n Preventiva\": \"Redacta una recomendaci√≥n contextual, con base en el caso real. Menciona al cliente final por nombre. Describe qu√© debi√≥ hacerse mejor y qu√© debe hacerse ahora mismo para contener la situaci√≥n. Usa lenguaje pol√≠tico y t√©cnico. Transmite liderazgo y tranquilidad incluso si la soluci√≥n no est√° cerrada a√∫n. Nunca incluyas frases gen√©ricas ni superficiales.\"\n  }\n"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-120,780],"id":"d3bcfc7b-8a82-4eb3-8556-7a0083388af9","name":"Output Parser"},{"parameters":{"model":{"__rl":true,"value":"openai-mini","mode":"list","cachedResultName":"openai-mini"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[20,820],"id":"227b3e71-5652-423c-b12e-9f70e4eba51b","name":"Fix JSON Parser","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n    \"remoteJid\",\n    standby,\n    \"updated_at\"\nFROM \n    public.standby\nWHERE  \"remoteJid\" = '{{ $json.remoteJid }}'\n    AND standby = true\n    AND \"updated_at\" < NOW() - INTERVAL '4 hours';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-240,-240],"id":"ab3bb73c-13a6-4fd4-be07-d41370511293","name":"Query Standby Time","alwaysOutputData":true,"credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1880,420],"id":"d3abd271-0bc6-4375-98f3-4782a4acf447","name":"Do nothing"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.standby \nSET \n    \"standby\" = false,\n    \"updatedAt\" = NOW()\nWHERE \n    \"remoteJid\" = '{{ $('Time Off').item.json.remoteJid }}';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[300,-360],"id":"4a549352-a67b-4c95-a536-1790b5547983","name":"Set False Standby","credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}},"onError":"continueRegularOutput"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"sentiment_results_whatsup","mode":"list","cachedResultName":"sentiment_results_whatsup"},"columns":{"mappingMode":"defineBelow","value":{"sentimiento":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.category.toUpperCase() }}","confianza":"={{ $json.sentimentAnalysis.confidence }}","intensidad":"={{ $json.sentimentAnalysis.strength }}","chat":"={{ $json.data[0].nombrechat.toUpperCase() }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"sentimiento","displayName":"sentimiento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"confianza","displayName":"confianza","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"intensidad","displayName":"intensidad","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"chat","displayName":"chat","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"cliente","displayName":"cliente","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"mensajes_negativos","displayName":"mensajes_negativos","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"origen_negativo","displayName":"origen_negativo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"recomendacion","displayName":"recomendacion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"remote_jid","displayName":"remote_jid","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"standby","displayName":"standby","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[660,160],"id":"8927658a-5839-4b78-9de9-560ac1796e2d","name":"Save","credentials":{"postgres":{"id":"PrpJ8WzpiFemwSbR","name":"AnalisisSentimiento"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"92473d26-7071-470e-9671-f0a302b8efb1","leftValue":"={{ $json.standby }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"330efff0-9787-4667-9d26-00f079ffd293","leftValue":"={{ $json.standby }}","rightValue":"","operator":{"type":"boolean","operation":"exists","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-20,-240],"id":"098fef0a-a58c-44a6-922e-da279247e2db","name":"If"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"standby","mode":"list","cachedResultName":"standby"},"columns":{"mappingMode":"defineBelow","value":{"sentimiento":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.category.toUpperCase() }}","confianza":"={{ $json.sentimentAnalysis.confidence }}","intensidad":"={{ $json.sentimentAnalysis.strength }}","chat":"={{ $json.data[0].nombrechat.toUpperCase() }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"sentimiento","displayName":"sentimiento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"confianza","displayName":"confianza","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"intensidad","displayName":"intensidad","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"chat","displayName":"chat","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"cliente","displayName":"cliente","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"mensajes_negativos","displayName":"mensajes_negativos","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"origen_negativo","displayName":"origen_negativo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"recomendacion","displayName":"recomendacion","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"remote_jid","displayName":"remote_jid","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"standby","displayName":"standby","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[300,-160],"id":"5b2063f2-42ba-4f2a-9071-b712d7e95043","name":"InsertStandby","credentials":{"postgres":{"id":"i1HXN1QutN6BIHF9","name":"Postgres_whisper"}},"disabled":true},{"parameters":{"content":"## Seccion Valida el estado de Standby a 4 horas \nSi no existe el registro, se agrega con el estado en falso y tiempo actual","height":420,"width":800,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-540,-400],"id":"1cac85b6-2b55-4a39-9005-6f2bb0b84ab9","name":"Sticky Note1"},{"parameters":{"content":"## Seccion Analisis de sentimiento y Formato salida IA\n","height":840,"width":800,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-540,80],"id":"205f29f0-0ee3-4b9a-b2d1-d3be101d5760","name":"Sticky Note2"},{"parameters":{"content":"## Guardado de Analisis y Env√≠o de Email\n","height":840,"width":1680,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[360,80],"id":"742440dd-63af-4ad7-a12a-ce22dd762cfc","name":"Sticky Note3"},{"parameters":{"assignments":{"assignments":[{"id":"ffe03e31-8010-4b8d-ac8e-705fb0931f35","name":"sentimiento","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.category  }}","type":"string"},{"id":"b1f871a9-c1a6-446f-92be-2e7cae0f5b1c","name":"confianza","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.confidence * 100  }}\n","type":"number"},{"id":"d1de9d71-b65f-496a-acbe-724826b92bb2","name":"chat","value":"={{ $('AI Analist Negative').item.json.output.Chat.toUpperCase() }}\n","type":"string"},{"id":"de460fc7-35bc-4a04-910c-440ecb8f79be","name":"cliente","value":"={{ $('AI Analist Negative').item.json.output.Cliente.toUpperCase() }}","type":"string"},{"id":"1546c0fa-b24b-4934-94b8-5a2c6236c768","name":"mensajes_negativos","value":"={{ $('AI Analist Negative').item.json.output['Mensajes Origen Sentimiento Negativo'] }}","type":"string"},{"id":"640c714b-a412-400b-966f-1874016213bc","name":"origen_negativo","value":"={{ $('AI Analist Negative').item.json.output['Origen Sentimiento Negativo'] }}","type":"string"},{"id":"fb344e38-3335-434f-a159-f10d29967045","name":"recomendacion","value":"={{ $('AI Analist Negative').item.json.output['Recomendaci√≥n Preventiva'] }}\n","type":"string"},{"id":"79478285-7e36-4766-8fbf-16586ef364d6","name":"intensidad","value":"={{ $('Sentiment Analysis').item.json.sentimentAnalysis.strength * 100 }}","type":"number"}]},"options":{"ignoreConversionErrors":true}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[620,540],"id":"a63095d6-dd61-4033-b713-71f062f0d142","name":"Edit Fields1"},{"parameters":{"fromEmail":"sadian88@gmail.com","toEmail":"sadian88@gmail.com, adiazs@ifxcorp.com","subject":"=SITUACION CRITICA {{ $('Merge Analisis').item.json.data[0].chat }} CLIENTE {{ $('Merge Analisis').item.json.data[0].cliente }}","html":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[1880,600],"id":"aeb8c766-a7da-4110-bdef-3faedc4bd959","name":"Send Email","webhookId":"0c878d9d-5809-4dd1-bee3-877784656863","credentials":{"smtp":{"id":"K7Y8XXXqNwyqSCdz","name":"SMTP account 2"}}},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Sentimiento Negativo</title>\n</head>\n\n<body style=\"margin:0; padding:0; background:#f5f7fa; font-family: Arial, Helvetica, sans-serif;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#f5f7fa;\">\n    <tr>\n      <td align=\"center\">\n        <!-- Tarjeta principal -->\n        <table width=\"80%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff; border-radius:18px; box-shadow:0 4px 24px #0033cc22; margin:32px auto 24px auto; min-width:320px; max-width:900px;\">\n          <!-- Encabezado -->\n          <tr>\n            <td style=\"padding: 32px 32px 12px 32px;\">\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                <tr>\n                  <td valign=\"middle\" style=\"width:48px;\">\n                    <img src=\"https://img.icons8.com/color/48/000000/combo-chart--v1.png\" width=\"48\" height=\"48\" alt=\"logo\" style=\"vertical-align:middle;\">\n                  </td>\n                  <td valign=\"middle\">\n                    <span style=\"font-size: 26px; font-weight: bold; color: #1976D2; letter-spacing: 0.5px;\">Alerta de Sentimientos Negativos</span>\n                    <div style=\"font-size: 15px; color: #888; margin-top: 4px;\">Detecci√≥n autom√°tica de interacciones negativas en chats de soporte</div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- L√≠nea separadora -->\n          <tr>\n            <td><div style=\"border-bottom:2px solid #1976D2; width:100%; margin:0 auto 18px auto;\"></div></td>\n          </tr>\n          <!-- An√°lisis de Sentimiento -->\n          <tr>\n            <td>\n              <!-- Tarjeta de an√°lisis -->\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff; border-radius:18px; box-shadow:0 2px 8px #FFCC8033; margin-bottom:24px;\">\n                <tr>\n                  <td colspan=\"3\" style=\"padding: 24px 32px 12px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/combo-chart--v1.png\" width=\"32\" height=\"32\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 20px; font-weight: bold; color: #1976D2; letter-spacing: 0.5px;\">An√°lisis de Sentimiento</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:2px solid #1976D2; width:100%; margin-top:8px;\"></div>\n                  </td>\n                </tr>\n                <tr>\n                  <!-- Sentimiento -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%; border-right:1px solid #F0F0F0;\">\n                    <span style=\"display:inline-block; background:#FF5252; color:#fff; border-radius:8px; padding:8px 22px; font-size:16px; font-weight:700; margin-bottom:8px;\">\n                      {{ $('Merge Analisis').item.json.data[0].sentimiento }}\n                    </span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Sentimiento</div>\n                  </td>\n                  <!-- Intensidad -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%; border-right:1px solid #F0F0F0;\">\n                    <span style=\"font-size: 36px; font-weight: bold; color: #FF8A65;\">{{ $('Merge Analisis').item.json.data[0].intensidad }}%</span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Intensidad</div>\n                  </td>\n                  <!-- Certeza -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%;\">\n                    <span style=\"font-size: 36px; font-weight: bold; color: #1976D2;\">{{ $('Merge Analisis').item.json.data[0].confianza }}%</span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Certeza</div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Informaci√≥n del Chat -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#f4f7fb; border-radius:14px; box-shadow:0 1px 4px #e3e7ee; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/chat--v1.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #1976D2;\">Informaci√≥n del Chat</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #1976D2; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; margin-bottom: 8px;\">\n                      <span style=\"font-weight: bold; color: #555;\">Chat: </span>{{ $('Merge Analisis').item.json.data[0].chat }}\n                    </div>\n                    <div style=\"font-size: 15px; color: #333;\">\n                      <span style=\"font-weight: bold; color: #555;\">Cliente: </span>{{ $('Merge Analisis').item.json.data[0].cliente }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Mensajes Clave (se mantiene igual) -->\n          <tr>\n            <td>\n              <!-- Aqu√≠ se inserta la secci√≥n generada por messages_table.js -->\n              {{ $('Table Messages').item.json.html_mensajes }}\n            </td>\n          </tr>\n          <!-- Origen del Sentimiento -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff3e0; border-radius:14px; box-shadow:0 1px 4px #ffcc8033; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/idea.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #FF8A65;\">Origen Detallado del Sentimiento</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #FF8A65; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; line-height:1.7;\">\n                      {{ $('Merge Analisis').item.json.data[0].origen_negativo }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Recomendaciones -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#e8f5e9; border-radius:14px; box-shadow:0 1px 4px #a5d6a733; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/idea-sharing.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #4CAF50;\">Recomendaciones</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #4CAF50; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; line-height:1.7;\">\n                      {{ $('Merge Analisis').item.json.data[0].recomendacion }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Pie de p√°gina -->\n          <tr>\n            <td align=\"center\" style=\"padding: 24px 0 16px 0;\">\n              <div style=\"font-size: 13px; color: #888;\">Sistema de An√°lisis de Sentimientos | ¬© 2025 IFX<br>Esta alerta ha sido generada autom√°ticamente.</div>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1420,760],"id":"52509752-e4cb-4597-a0d0-8fdc2b418ba4","name":"HTML1"},{"parameters":{"fromEmail":"sadian88@gmail.com","toEmail":"sadian88@gmail.com, adiazs@ifxcorp.com","subject":"=SITUACION CRITICA {{ $('Merge Analisis').item.json.data[0].chat }} CLIENTE {{ $('Merge Analisis').item.json.data[0].cliente }}","html":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[1640,760],"id":"05505bf3-31a9-4f96-ace4-1a6105cbd8f0","name":"Send Email1","webhookId":"0c878d9d-5809-4dd1-bee3-877784656863","credentials":{"smtp":{"id":"K7Y8XXXqNwyqSCdz","name":"SMTP account 2"}}}],"connections":{"Postgres Trigger":{"main":[[{"node":"Query Back Chat","type":"main","index":0},{"node":"Query Standby Time","type":"main","index":0}]]},"HTML":{"main":[[{"node":"Standby?","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Merge Analisis","type":"main","index":0}]]},"Query Back Chat":{"main":[[{"node":"Merge Data Chat","type":"main","index":0}]]},"Merge Data Chat":{"main":[[{"node":"Sentiment Analysis","type":"main","index":0}]]},"Sentiment Analysis":{"main":[[{"node":"Save","type":"main","index":0}],[{"node":"Save","type":"main","index":0}],[{"node":"AI Analist Negative","type":"main","index":0}]]},"AI Analist Negative":{"main":[[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Information Extractor","type":"main","index":0}]]},"Table Messages":{"main":[[{"node":"HTML","type":"main","index":0},{"node":"HTML1","type":"main","index":0}]]},"Merge Analisis":{"main":[[{"node":"Save Negative","type":"main","index":0}]]},"Llama 70B":{"ai_languageModel":[[{"node":"Sentiment Analysis","type":"ai_languageModel","index":0}]]},"Llama 70B Negativo":{"ai_languageModel":[[{"node":"AI Analist Negative","type":"ai_languageModel","index":0}]]},"Send Alert":{"main":[[]]},"Standby?":{"main":[[{"node":"Do nothing","type":"main","index":0}],[{"node":"Send Alert","type":"main","index":0},{"node":"Send Email","type":"main","index":0}]]},"Information Extractor":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Output Parser":{"ai_outputParser":[[{"node":"AI Analist Negative","type":"ai_outputParser","index":0}]]},"Fix JSON Parser":{"ai_languageModel":[[{"node":"Information Extractor","type":"ai_languageModel","index":0}]]},"Query Standby Time":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Set False Standby","type":"main","index":0}],[{"node":"InsertStandby","type":"main","index":0}]]},"Save Negative":{"main":[[{"node":"Table Messages","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge Analisis","type":"main","index":0}]]},"HTML1":{"main":[[{"node":"Send Email1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Postgres Trigger":[{"json":{"remoteJid":"120363138464974782@g.us","participant":"50433912156@s.whatsapp.net","pushName":"Edy Fernandez","conversation":"se ha creado el n√∫mero de caso #TT1058365 - URGENTE Ca√≠da a Internet Oficinas UNO SPS, el cual ser√° asignado a un Ingeniero de nuestro Centro de Atenci√≥n Regional encargado de atenderlo.\nPara consultar avances sobre este caso debe dar ‚Äúresponder‚Äù a este correo. Si crea un nuevo correo o modifica el asunto, se perder√° la trazabilidad del mismo.\nRecuerde que para agilizar la recepci√≥n de sus requerimientos en los diferentes canales de atenci√≥n su n√∫mero de cliente con IFX es: 1125446.\n\n","dateTime":"2025-05-29T09:02:15.268Z","sender":"573171057858@s.whatsapp.net","nombrechat":"CARE - UNO Honduras","standby":false,"updated_at":"2025-05-29T12:49:28.275Z"}}]},"versionId":"1e040d83-9a14-483b-951b-a799b275576b","triggerCount":0,"tags":[]}