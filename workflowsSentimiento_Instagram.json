{"createdAt":"2025-06-04T14:37:47.022Z","updatedAt":"2025-06-04T20:28:34.000Z","id":"U8Iz7knkVJPuUMBQ","name":"Sentimiento_Instagram","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"insta","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1940,-820],"id":"9e68f4d0-4137-45d0-91bd-05e49d0aef3f","name":"EndpointInstagram","webhookId":"ced1cb68-aaea-426c-9007-58ae7453b239","disabled":true},{"parameters":{"respondWith":"text","responseBody":"={{ $json.query['hub.challenge'] }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.3,"position":[-1720,-820],"id":"3bbfbf43-7064-49f6-afa4-9a5a0d07b021","name":"Respond to Webhook","disabled":true},{"parameters":{"httpMethod":"POST","path":"insta","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1340,-600],"id":"238d2d90-a644-4a20-9533-0782a0370dd7","name":"EndpointInstagram_comentarios","webhookId":"ced1cb68-aaea-426c-9007-58ae7453b239"},{"parameters":{"url":"=https://graph.instagram.com/v23.0/{{ $json.body.entry[0].changes[0].value.media.id }}","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"id,caption,permalink"},{"name":"access_token","value":"IGAARnpvFSXHZABZAE1QLUs5Q2xieUtNUXlFN3JHaEdZANVpaTTdIQ2xVNDE5ak1BZAGVjX0hMcXVVSTdZAWF9UTXg0c3JQVW41bWpUVmhiTmhrLTc1WE9FSzE3YzBsVXhpUkRWNUlXRVdqazBYT1o5Y2VPSEhhWXljTTdPZAGg2YnZArRQZDZD"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1100,-600],"id":"3aafda89-fa51-4674-96da-c587b90665f6","name":"HTTP Request"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Sentimiento Negativo</title>\n</head>\n\n<body style=\"margin:0; padding:0; background:#f5f7fa; font-family: Arial, Helvetica, sans-serif;\">\n  <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#f5f7fa;\">\n    <tr>\n      <td align=\"center\">\n        <!-- Tarjeta principal -->\n        <table width=\"80%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff; border-radius:18px; box-shadow:0 4px 24px #0033cc22; margin:32px auto 24px auto; min-width:320px; max-width:900px;\">\n          <!-- Encabezado -->\n          <tr>\n            <td style=\"padding: 32px 32px 12px 32px;\">\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                <tr>\n                  <td valign=\"middle\" style=\"width:48px;\">\n                    <img src=\"https://img.icons8.com/color/48/000000/combo-chart--v1.png\" width=\"48\" height=\"48\" alt=\"logo\" style=\"vertical-align:middle;\">\n                  </td>\n                  <td valign=\"middle\">\n                    <span style=\"font-size: 26px; font-weight: bold; color: #1976D2; letter-spacing: 0.5px;\">Alerta de Sentimientos Negativos</span>\n                    <div style=\"font-size: 15px; color: #888; margin-top: 4px;\">Detección automática de interacciones negativas en chats de soporte</div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Línea separadora -->\n          <tr>\n            <td><div style=\"border-bottom:2px solid #1976D2; width:100%; margin:0 auto 18px auto;\"></div></td>\n          </tr>\n          <!-- Análisis de Sentimiento -->\n          <tr>\n            <td>\n              <!-- Tarjeta de análisis -->\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff; border-radius:18px; box-shadow:0 2px 8px #FFCC8033; margin-bottom:24px;\">\n                <tr>\n                  <td colspan=\"3\" style=\"padding: 24px 32px 12px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/combo-chart--v1.png\" width=\"32\" height=\"32\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 20px; font-weight: bold; color: #1976D2; letter-spacing: 0.5px;\">Análisis de Sentimiento</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:2px solid #1976D2; width:100%; margin-top:8px;\"></div>\n                  </td>\n                </tr>\n                <tr>\n                  <!-- Sentimiento -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%; border-right:1px solid #F0F0F0;\">\n                    <span style=\"display:inline-block; background:#FF5252; color:#fff; border-radius:8px; padding:8px 22px; font-size:16px; font-weight:700; margin-bottom:8px;\">\n                      {{ $('Merge Analisis').item.json.data[0].sentimiento }}\n                    </span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Sentimiento</div>\n                  </td>\n                  <!-- Intensidad -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%; border-right:1px solid #F0F0F0;\">\n                    <span style=\"font-size: 36px; font-weight: bold; color: #FF8A65;\">{{ $('Merge Analisis').item.json.data[0].intensidad }}%</span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Intensidad</div>\n                  </td>\n                  <!-- Certeza -->\n                  <td align=\"center\" style=\"padding: 24px 0 24px 0; width:33.3%;\">\n                    <span style=\"font-size: 36px; font-weight: bold; color: #1976D2;\">{{ $('Merge Analisis').item.json.data[0].confianza }}%</span>\n                    <div style=\"font-size: 15px; color: #222; font-weight: 600; margin-top:8px;\">Certeza</div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Información del Chat -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#f4f7fb; border-radius:14px; box-shadow:0 1px 4px #e3e7ee; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/chat--v1.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #1976D2;\">Información del Chat</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #1976D2; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; margin-bottom: 8px;\">\n                      <span style=\"font-weight: bold; color: #555;\">Chat: </span>{{ $('Merge Analisis').item.json.data[0].chat }}\n                    </div>\n                    <div style=\"font-size: 15px; color: #333;\">\n                      <span style=\"font-weight: bold; color: #555;\">Cliente: </span>{{ $('Merge Analisis').item.json.data[0].cliente }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Mensajes Clave (se mantiene igual) -->\n          <tr>\n            <td>\n              <!-- Aquí se inserta la sección generada por messages_table.js -->\n              {{ $('Table Messages').item.json.html_mensajes }}\n            </td>\n          </tr>\n          <!-- Origen del Sentimiento -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#fff3e0; border-radius:14px; box-shadow:0 1px 4px #ffcc8033; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/idea.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #FF8A65;\">Origen Detallado del Sentimiento</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #FF8A65; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; line-height:1.7;\">\n                      {{ $('Merge Analisis').item.json.data[0].origen_negativo }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Recomendaciones -->\n          <tr>\n            <td>\n              <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background:#e8f5e9; border-radius:14px; box-shadow:0 1px 4px #a5d6a733; margin-bottom:24px;\">\n                <tr>\n                  <td style=\"padding: 24px 32px;\">\n                    <table width=\"100%\">\n                      <tr>\n                        <td valign=\"middle\" style=\"width:36px;\">\n                          <img src=\"https://img.icons8.com/color/48/000000/idea-sharing.png\" width=\"28\" height=\"28\" alt=\"icono\" style=\"vertical-align:middle;\">\n                        </td>\n                        <td valign=\"middle\">\n                          <span style=\"font-size: 18px; font-weight: bold; color: #4CAF50;\">Recomendaciones</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <div style=\"border-bottom:1px solid #4CAF50; width:100%; margin-top:8px; margin-bottom:16px;\"></div>\n                    <div style=\"font-size: 15px; color: #333; line-height:1.7;\">\n                      {{ $('Merge Analisis').item.json.data[0].recomendacion }}\n                    </div>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <!-- Pie de página -->\n          <tr>\n            <td align=\"center\" style=\"padding: 24px 0 16px 0;\">\n              <div style=\"font-size: 13px; color: #888;\">Sistema de Análisis de Sentimientos | © 2025 IFX<br>Esta alerta ha sido generada automáticamente.</div>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-220,-680],"id":"a81256d5-2aef-43bc-b8d9-1c2328d11060","name":"HTML"},{"parameters":{"inputText":"={{ $('EndpointInstagram_comentarios').item.json.body.entry[0].changes[0].value.text }}","options":{"categories":"POSITIVE, NEUTRAL, NEGATIVE","systemPromptTemplate":"You are a highly intelligent and context-aware sentiment analyzer, specialized in customer interactions for telecommunications services.\n \nYour task is to analyze the sentiment of the full conversation provided, considering the emotional evolution over time. You must:\n \n- DETECT how the sentiment CHANGES throughout the conversation\n- EVALUATE whether frustration builds progressively (e.g., repeated complaints, lack of resolution, tone escalation)\n- PRIORITIZE the FINAL MESSAGE as a potential emotional trigger\n- CATEGORIZE the overall sentiment of the conversation based on its complete flow and timing\n- RETURN only one of the following categories: {{categories}}\n \n###OUTPUT FORMAT###\n \nYou MUST ALWAYS return ONLY a valid JSON object with a single field \"sentiment\", using EXACTLY ONE of the following values: {{categories}}.\n \nThe JSON MUST BE IN A SINGLE LINE, WITHOUT LINE BREAKS, COMMENTS, OR FORMATTING.\n \nExample output:\n{{\"sentiment\":\"sentiment\"}}\n \nDO NOT include any explanation, formatting, or line breaks.","includeDetailedResults":true,"enableAutoFixing":true}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1.1,"position":[-820,-440],"id":"a706520a-7a07-4998-8434-53d825fa948e","name":"Sentiment Analysis"},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"responseFormat":"json_object","temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-960,-200],"id":"0dc771d9-8636-443c-a848-a3049a230223","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"lu44hoWfCkZALmQk","name":"Api Sentinel"}}}],"connections":{"EndpointInstagram":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"EndpointInstagram_comentarios":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Sentiment Analysis","type":"main","index":0}]]},"Sentiment Analysis":{"main":[[{"node":"HTML","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Sentiment Analysis","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1","saveDataSuccessExecution":"all","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"EndpointInstagram_comentarios":[{"json":{"headers":{"host":"n8n.aifx.com.co","x-real-ip":"69.171.251.114","x-forwarded-for":"69.171.251.114","x-forwarded-proto":"https","connection":"upgrade","content-length":"321","x-hub-signature":"sha1=03a2b08b35667283af93dde240fc6c9e1a3ba5d2","x-hub-signature-256":"sha256=650bb56d94e4f00c2cce067ee2c53263ed2d9c07dec0b9d7ab539e2a68011516","content-type":"application/json","user-agent":"Webhooks/1.0 (https://fb.me/webhooks)","accept":"*/*"},"params":{},"query":{},"body":{"entry":[{"id":"17841470402200103","time":1749056875,"changes":[{"value":{"from":{"id":"1295320142203826","username":"sadian88"},"media":{"id":"17953621157823119","media_product_type":"FEED"},"id":"18048238478430879","text":"Hoy ha sido un día increíble. Recibí buenas noticias, logré avanzar en mis proyectos y además pude compartir tiempo con personas que valoro mucho. Me siento agradecido y motivado para seguir dando lo mejor de mí cada día."},"field":"comments"}]}],"object":"instagram"},"webhookUrl":"https://n8n.aifx.com.co/webhook/insta","executionMode":"production"}}]},"versionId":"1047d18c-4c99-4ef0-acbd-3da753edb604","triggerCount":1,"tags":[]}