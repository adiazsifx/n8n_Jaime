{"createdAt":"2025-04-20T19:05:59.937Z","updatedAt":"2025-04-21T12:52:07.000Z","id":"JyANAGcMTsIOWf75","name":"Testing Account Plan","active":false,"isArchived":false,"nodes":[{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"15hwXkYBxXrnLi4WfLfKcJs4r6rXGLthl","mode":"list","cachedResultName":"Comercial","cachedResultUrl":"https://drive.google.com/drive/folders/15hwXkYBxXrnLi4WfLfKcJs4r6rXGLthl"},"event":"fileCreated","options":{}},"type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[0,0],"id":"4a9f3984-abf1-424a-b501-24739ac04e65","name":"Google Drive Trigger","credentials":{"googleDriveOAuth2Api":{"id":"KeJeYvddxw0ubE33","name":"Google Drive JPG"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[220,0],"id":"2e58af98-5794-455e-9ef5-0f6630dcedb1","name":"Google Drive","credentials":{"googleDriveOAuth2Api":{"id":"KeJeYvddxw0ubE33","name":"Google Drive JPG"}}},{"parameters":{"method":"POST","url":"https://api.cloud.llamaindex.ai/api/parsing/upload","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[460,0],"id":"923d4399-30a9-4120-85d2-ed692386a8a2","name":"Parser Documento","credentials":{"httpHeaderAuth":{"id":"rDHcHgP5GNq3qUHB","name":"API Llamaindex"}}},{"parameters":{"url":"=https://api.cloud.llamaindex.ai/api/v1/parsing/job/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[700,0],"id":"2a362be2-8e40-4c2b-95c1-71d066f3e8a3","name":"GET Parser Document","credentials":{"httpHeaderAuth":{"id":"rDHcHgP5GNq3qUHB","name":"API Llamaindex"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6b32d09d-aca1-4ac2-add0-08fddb408eef","leftValue":"={{ $json.status }}","rightValue":"ERROR","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ERROR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"728cff21-b861-4c35-a66f-1159958560fb","leftValue":"={{ $json.status }}","rightValue":"CANCELED","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CANCELED"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.status }}","rightValue":"SUCCESS","operator":{"type":"string","operation":"equals"},"id":"1ca170e5-f79b-45d0-bf06-8817aaa91020"}],"combinator":"and"},"renameOutput":true,"outputKey":"SUCCESS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8ed9a7f3-a77b-4541-a2c5-1ec659349c4c","leftValue":"={{ $json.status }}","rightValue":"PENDING","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PENDING"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[940,-20],"id":"d036cb9d-0c5b-4aaa-8579-4938dd0ae4ed","name":"Status Process"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1100,140],"id":"3f90868a-0e51-4ce4-bcd4-9386f271604a","name":"Wait","webhookId":"6e349bdd-c897-4d81-9050-47e4aaf3a4d1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1140,-200],"id":"a7774195-55f4-487a-b308-36ea03798bc9","name":"No Operation, do nothing"},{"parameters":{"url":"=https://api.cloud.llamaindex.ai/api/v1/parsing/job/{{ $json.id }}/result/markdown","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1200,-20],"id":"f8a783ea-7cb8-4d1c-a273-f663573a7f5a","name":"Success Document","credentials":{"httpHeaderAuth":{"id":"rDHcHgP5GNq3qUHB","name":"API Llamaindex"}}},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{"temperature":0.4}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1420,160],"id":"a24a9078-7dd7-4432-bdaf-62e1c9e2fc9d","name":"GPT 4.1 Nano","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"jsCode":"// Código para el nodo Code de n8n que genera HTML para reportes de clientes\n\n// Procesar cada item\nreturn items.map(item => {\n  // Intentar extraer los datos de diferentes posibles ubicaciones\n  let clienteData;\n  \n  // Verificar si los datos vienen directamente en el item\n  if (item.json && item.json.cliente) {\n    clienteData = item.json;\n  } \n  // Verificar si los datos vienen en un campo output\n  else if (item.json && item.json.output && typeof item.json.output === 'string') {\n    try {\n      // Intentar parsear el string JSON que podría estar en output\n      const parsed = JSON.parse(item.json.output);\n      if (parsed && parsed.cliente) {\n        clienteData = parsed;\n      }\n    } catch (e) {\n      // Si hay un error al parsear, buscar si el string contiene la palabra cliente\n      const outputStr = item.json.output;\n      if (outputStr.includes('\"cliente\"') || outputStr.includes('\"nombre\"')) {\n        // Intentar extraer el JSON manualmente (caso de JSON incompleto o malformado)\n        const startIndex = outputStr.indexOf('{');\n        if (startIndex !== -1) {\n          try {\n            // Intentar recuperar el JSON desde el primer '{'\n            const jsonStr = outputStr.substring(startIndex);\n            const fixedJson = jsonStr.replace(/```json|```/g, '').trim();\n            const parsed = JSON.parse(fixedJson);\n            if (parsed && parsed.cliente) {\n              clienteData = parsed;\n            }\n          } catch (e) {\n            console.log(\"Error al parsear JSON recortado:\", e);\n          }\n        }\n      }\n    }\n  }\n  \n  // Si no se encontró información de cliente, usar un objeto vacío\n  if (!clienteData) {\n    console.log(\"No se encontraron datos de cliente. Usando plantilla vacía.\");\n    clienteData = { cliente: {} };\n  }\n  \n  // Extraer los datos del cliente\n  const cliente = clienteData.cliente || {};\n  \n  // Obtener contactos clave\n  const contactosClave = cliente.contactos_clave || [];\n  \n  // Presupuestos\n  const presupuestos = cliente.presupuesto_telecom || {};\n  \n  // Proyectos\n  const proyectos = cliente.proyectos || [];\n  \n  // Competencia\n  const competencia = cliente.competencia || [];\n  \n  // Generar HTML para contactos clave\n  const contactosHTML = contactosClave.map((contacto, index) => {\n    // Determinar si es el inicio de una nueva fila\n    const isEven = index % 2 === 0;\n    const startRow = isEven ? '<div class=\"contact-grid\">' : '';\n    const endRow = !isEven || index === contactosClave.length - 1 ? '</div>' : '';\n    \n    return `${startRow}\n        <div class=\"contact-card\">\n            <div class=\"card\">\n                <h3>${contacto.nombre || ''}</h3>\n                <p><strong>Cargo:</strong> ${contacto.cargo || ''}</p>\n                ${contacto.telefono ? `<p><strong>Teléfono:</strong> ${Array.isArray(contacto.telefono) ? contacto.telefono.join(' / ') : contacto.telefono}</p>` : ''}\n                ${contacto.rol ? `<p><strong>Rol:</strong> ${Array.isArray(contacto.rol) ? contacto.rol.join(', ') : contacto.rol}</p>` : ''}\n            </div>\n        </div>\n    ${endRow}`;\n  }).join('');\n  \n  // Generar HTML para proyectos\n  const proyectosHTML = proyectos.map(proyecto => {\n    return `<tr>\n        <td>${proyecto.nombre || ''}</td>\n        <td>${proyecto.categoria || ''}</td>\n        <td>${Array.isArray(proyecto.decision_maker) ? proyecto.decision_maker.join(' / ') : proyecto.decision_maker || ''}</td>\n        <td>${proyecto.presupuesto || ''}</td>\n        <td>${proyecto.valor_contrato || ''}</td>\n    </tr>`;\n  }).join('');\n  \n  // Generar HTML para competidores\n  const competidoresHTML = competencia.map(competidor => {\n    return `<div class=\"card\">\n        <h3>${competidor.nombre || ''}</h3>\n        ${competidor.fortalezas ? `<p><strong>Fortalezas:</strong> ${Array.isArray(competidor.fortalezas) ? competidor.fortalezas.join(', ') : competidor.fortalezas}</p>` : ''}\n        ${competidor.debilidades ? `<p><strong>Debilidades:</strong> ${Array.isArray(competidor.debilidades) ? competidor.debilidades.join(', ') : competidor.debilidades}</p>` : ''}\n    </div>`;\n  }).join('');\n  \n  // Generar la fecha actual para el footer\n  const hoy = new Date();\n  const fechaFooter = hoy.toLocaleDateString('es-ES', { \n    day: 'numeric', \n    month: 'long', \n    year: 'numeric' \n  });\n  \n  // Generar el HTML completo\n  const html = `<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Informe de Cliente - ${cliente.nombre || 'Cliente'}</title>\n    <style>\n        /* Estilos generales compatibles con clientes de correo */\n        body {\n            font-family: Arial, Helvetica, sans-serif;\n            line-height: 1.6;\n            color: #333333;\n            margin: 0;\n            padding: 0;\n            background-color: #f5f5f5;\n        }\n        .container {\n            max-width: 800px;\n            margin: 0 auto;\n            background-color: #ffffff;\n            padding: 20px;\n        }\n        .header {\n            background-color: #00008B; /* Azul rey */\n            color: white;\n            padding: 20px;\n            text-align: center;\n            margin-bottom: 20px;\n        }\n        .section {\n            margin-bottom: 30px;\n            padding: 15px;\n            border-radius: 5px;\n            background-color: #f9f9f9;\n            border-left: 5px solid #0071ce;\n        }\n        h1, h2, h3 {\n            color: #0071ce;\n            margin-top: 0;\n        }\n        .header h1, .header h2, .header p {\n            color: white;\n        }\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-bottom: 15px;\n        }\n        th, td {\n            border: 1px solid #ddd;\n            padding: 8px;\n            text-align: left;\n        }\n        th {\n            background-color: #f2f2f2;\n        }\n        .card {\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            padding: 15px;\n            margin-bottom: 10px;\n            background-color: white;\n        }\n        .tag {\n            display: inline-block;\n            background-color: #e3f2fd;\n            color: #0071ce;\n            padding: 3px 8px;\n            border-radius: 3px;\n            margin-right: 5px;\n            margin-bottom: 5px;\n            font-size: 12px;\n        }\n        .contact-grid {\n            display: table;\n            width: 100%;\n        }\n        .contact-card {\n            display: table-cell;\n            width: 50%;\n            padding-right: 10px;\n            padding-bottom: 15px;\n            vertical-align: top;\n        }\n        .progress-container {\n            background-color: #f1f1f1;\n            border-radius: 10px;\n            margin-bottom: 10px;\n        }\n        .progress-bar {\n            background-color: #0071ce;\n            color: white;\n            padding: 3px 10px;\n            border-radius: 10px;\n            text-align: center;\n        }\n        .footer {\n            margin-top: 30px;\n            padding: 15px;\n            background-color: #f9f9f9;\n            text-align: center;\n            font-size: 12px;\n            color: #777;\n        }\n        ul, ol {\n            margin-top: 5px;\n            padding-left: 20px;\n        }\n        li {\n            margin-bottom: 5px;\n        }\n        @media only screen and (max-width: 600px) {\n            .contact-grid, .contact-card {\n                display: block;\n                width: 100%;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1><i style=\"font-size: 24px; font-style: italic; font-family: sans-serif;\">IFX NETWORKS</i></h1>\n            <h2>Resumen Cliente ${cliente.nombre || 'XYZ'}</h2>\n            <p style=\"font-size: 14px; margin-top: 5px;\">Generated by <i style=\"font-style: italic; font-family: sans-serif; color: #ff00ff;\">aifx</i></p>\n        </div>\n\n        <!-- Información General del Cliente -->\n        <div class=\"section\">\n            <h2>Información General</h2>\n            <div class=\"card\">\n                <h3>${cliente.nombre || 'Cliente'}</h3>\n                <p>Grupo Empresarial: <strong>${cliente.grupo_empresarial || ''}</strong></p>\n                <p>Propuesta de Valor: ${cliente.propuesta_valor_cliente || ''}</p>\n            </div>\n            \n            <table>\n                <tr>\n                    <th colspan=\"2\">Datos Clave</th>\n                </tr>\n                ${cliente.ingresos_anuales?.centroamerica ? `\n                <tr>\n                    <td>Ingresos Anuales Centroamérica</td>\n                    <td>${cliente.ingresos_anuales.centroamerica}</td>\n                </tr>` : ''}\n                ${cliente.ingresos_anuales?.costa_rica ? `\n                <tr>\n                    <td>Ingresos Anuales Costa Rica</td>\n                    <td>${cliente.ingresos_anuales.costa_rica}</td>\n                </tr>` : ''}\n                ${cliente.empleados?.costa_rica ? `\n                <tr>\n                    <td>Empleados Costa Rica</td>\n                    <td>${cliente.empleados.costa_rica}</td>\n                </tr>` : ''}\n                ${cliente.empleados?.cam ? `\n                <tr>\n                    <td>Empleados Centroamérica</td>\n                    <td>${cliente.empleados.cam}</td>\n                </tr>` : ''}\n                ${cliente.sitios?.CR ? `\n                <tr>\n                    <td>Sitios Costa Rica</td>\n                    <td>${cliente.sitios.CR}</td>\n                </tr>` : ''}\n                ${cliente.sitios?.CAM ? `\n                <tr>\n                    <td>Sitios Centroamérica</td>\n                    <td>${cliente.sitios.CAM}</td>\n                </tr>` : ''}\n                ${cliente.arpa ? `\n                <tr>\n                    <td>ARPA</td>\n                    <td>${cliente.arpa}</td>\n                </tr>` : ''}\n            </table>\n            \n            ${cliente.modelo_negocio && cliente.modelo_negocio.length > 0 ? `\n            <div>\n                <p><strong>Modelo de Negocio:</strong></p>\n                ${cliente.modelo_negocio.map(modelo => `<span class=\"tag\">${modelo}</span>`).join('')}\n            </div>` : ''}\n            \n            <div>\n                <p><strong>Presupuesto de Tecnología:</strong></p>\n                <table>\n                    <tr>\n                        <th>Categoría</th>\n                        <th>Monto</th>\n                    </tr>\n                    ${cliente.presupuesto_tecnologia?.CR ? `\n                    <tr>\n                        <td>Costa Rica</td>\n                        <td>${cliente.presupuesto_tecnologia.CR}</td>\n                    </tr>` : ''}\n                    ${cliente.presupuesto_tecnologia?.CAM ? `\n                    <tr>\n                        <td>Centroamérica</td>\n                        <td>${cliente.presupuesto_tecnologia.CAM}</td>\n                    </tr>` : ''}\n                    ${presupuestos.conectividad ? `\n                    <tr>\n                        <td>Conectividad</td>\n                        <td>${presupuestos.conectividad}</td>\n                    </tr>` : ''}\n                    ${presupuestos.cloud ? `\n                    <tr>\n                        <td>Cloud</td>\n                        <td>${presupuestos.cloud}</td>\n                    </tr>` : ''}\n                    ${presupuestos.servicios_administrados ? `\n                    <tr>\n                        <td>Servicios Administrados</td>\n                        <td>${presupuestos.servicios_administrados}</td>\n                    </tr>` : ''}\n                    ${presupuestos.hardware ? `\n                    <tr>\n                        <td>Hardware</td>\n                        <td>${presupuestos.hardware}</td>\n                    </tr>` : ''}\n                </table>\n            </div>\n        </div>\n\n        <!-- Servicios Actuales IFX -->\n        <div class=\"section\">\n            <h2>Servicios Actuales IFX</h2>\n            <table>\n                <tr>\n                    <th>Categoría</th>\n                    <th>MRR</th>\n                    <th>TCV</th>\n                </tr>\n                ${cliente.servicios_actuales_ifx?.conectividad ? `\n                <tr>\n                    <td>Conectividad</td>\n                    <td>${cliente.servicios_actuales_ifx.conectividad.mrr || '-'}</td>\n                    <td>${cliente.servicios_actuales_ifx.conectividad.tcv || '-'}</td>\n                </tr>` : ''}\n                ${cliente.servicios_actuales_ifx?.equipamiento ? `\n                <tr>\n                    <td>Equipamiento</td>\n                    <td>${cliente.servicios_actuales_ifx.equipamiento.mrr || '-'}</td>\n                    <td>${cliente.servicios_actuales_ifx.equipamiento.tcv || '-'}</td>\n                </tr>` : ''}\n            </table>\n        </div>\n\n        <!-- Contactos Clave -->\n        <div class=\"section\">\n            <h2>Contactos Clave</h2>\n            ${contactosHTML || '<div class=\"card\"><p>No hay contactos registrados.</p></div>'}\n        </div>\n\n        <!-- Proyectos -->\n        <div class=\"section\">\n            <h2>Proyectos Clave</h2>\n            ${proyectos.length > 0 ? `\n            <table>\n                <tr>\n                    <th>Nombre</th>\n                    <th>Categoría</th>\n                    <th>Decisor</th>\n                    <th>Presupuesto</th>\n                    <th>Valor Contrato</th>\n                </tr>\n                ${proyectosHTML}\n            </table>` : '<div class=\"card\"><p>No hay proyectos registrados.</p></div>'}\n        </div>\n\n        <!-- Competencia -->\n        <div class=\"section\">\n            <h2>Análisis de Competencia</h2>\n            ${competidoresHTML || '<div class=\"card\"><p>No hay competidores registrados.</p></div>'}\n        </div>\n\n        <!-- Países de Operación -->\n        ${cliente.pais_operacion && cliente.pais_operacion.length > 0 ? `\n        <div class=\"section\">\n            <h2>Países de Operación</h2>\n            <div class=\"card\">\n                ${cliente.pais_operacion.map(pais => `<span class=\"tag\">${pais}</span>`).join('')}\n            </div>\n        </div>` : ''}\n\n        <div class=\"footer\">\n            <p>© ${new Date().getFullYear()} Reporte Confidencial de Cliente - ${cliente.grupo_empresarial || cliente.nombre || ''}</p>\n            <p>Generado el ${fechaFooter}</p>\n        </div>\n    </div>\n</body>\n</html>`;\n\n  // Retornar el item con el HTML generado\n  return {\n    json: {\n      ...item.json,\n      htmlReport: html\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1840,-20],"id":"a48637d8-e4eb-4291-825c-fe3bdcf96fe8","name":"Code"},{"parameters":{"promptType":"define","text":"={{ $json.markdown }}","options":{"systemMessage":"ERES UN ANALISTA COMERCIAL EXPERTO EN TELECOMUNICACIONES ESPECIALIZADO EN INTELIGENCIA DE CLIENTES. TU TAREA ES LEER DETENIDAMENTE UN DOCUMENTO COMERCIAL DE UNA CUENTA CLAVE Y EXTRAER TODA LA INFORMACIÓN RELEVANTE DEL CLIENTE EN FORMATO JSON ESTRUCTURADO. TU OBJETIVO ES PREPARAR UN PERFIL COMPLETO Y REPRESENTATIVO DEL CLIENTE PARA LA CREACIÓN DE PROPUESTAS DE SERVICIOS DE TELECOMUNICACIONES.\n\n### CADENA DE PENSAMIENTO (CHAIN OF THOUGHTS) USA LA HERRAMIENTA `think` PARA ENRIQUECER LA CADENA DE PENSAMIENTO\n\n1. **ENTENDER**: LEE EL DOCUMENTO Y COMPRENDE SU ESTRUCTURA Y PROPÓSITO  \n2. **IDENTIFICAR LO BÁSICO**: EXTRAER LOS ELEMENTOS FUNDAMENTALES COMO NOMBRE DE CLIENTE, PAÍSES DE OPERACIÓN, NÚMERO DE EMPLEADOS, INGRESOS, PRESENCIA TECNOLÓGICA, ETC.  \n3. **DESCOMPONER**: SEPARA LA INFORMACIÓN EN BLOQUES CLAVE: DATOS CORPORATIVOS, PERFIL DE NEGOCIO, PRESENCIA TÉCNICA, CONTACTOS CLAVE, PRESUPUESTOS, COMPETIDORES, PROYECTOS ACTUALES  \n4. **ANALIZAR**: SELECCIONA SOLO LO MÁS REPRESENTATIVO QUE CONTRIBUYA A DEFINIR UNA PROPUESTA DE VALOR COMERCIAL  \n5. **CONSTRUIR**: ESTRUCTURA LA SALIDA EN FORMATO JSON CON CAMPOS CLAROS Y ORGANIZADOS  \n6. **CONSIDERAR CASOS LÍMITE**: SI FALTAN DATOS, INCLUYE `\"null\"` O `\"no especificado\"` DE FORMA EXPLÍCITA  \n7. **RESPONDER**: GENERA LA SALIDA FINAL EXCLUSIVAMENTE EN FORMATO JSON  \n\n### FORMATO JSON DE SALIDA (EJEMPLO):\n\n```json\n{\n  \"cliente\": {\n    \"nombre\": \"Corporación de Supermercados Unidos\",\n    \"grupo_empresarial\": \"Walmart México y Centroamérica\",\n    \"ingresos_anuales\": {\n      \"centroamerica\": \"$4.5MM\",\n      \"costa_rica\": \"$500M-$1B\"\n    },\n    \"pais_operacion\": [\"Costa Rica\", \"Guatemala\", \"El Salvador\", \"Honduras\", \"Nicaragua\", \"Panamá\"],\n    \"empleados\": {\n      \"costa_rica\": 3000,\n      \"cam\": 12000\n    },\n    \"sitios\": {\n      \"CR\": 267,\n      \"CAM\": 829\n    },\n    \"modelo_negocio\": [\"B2B\", \"B2C\"],\n    \"arpa\": \"$19K\",\n    \"presupuesto_tecnologia\": {\n      \"CR\": \"$2.5M\",\n      \"CAM\": \"$12M\"\n    },\n    \"contactos_clave\": [\n      {\n        \"nombre\": \"Byron Paz\",\n        \"cargo\": \"Gerente divisional de infraestructura CAM\",\n        \"rol\": [\"Tomador de decisiones\", \"Encargado de aprobación\"],\n        \"telefono\": \"(502) 3042-7942\"\n      },\n      {\n        \"nombre\": \"Julio Vargas\",\n        \"cargo\": \"Comprador Regional Infraestructura\",\n        \"rol\": [\"Firmante de contratos\", \"Evaluador\"],\n        \"telefono\": \"(506) 8990-0892\"\n      }\n    ],\n    \"propuesta_valor_cliente\": \"Mejores precios, buen servicio, rapidez en las implementaciones, SLA de servicio.\",\n    \"competencia\": [\n      {\n        \"nombre\": \"Claro\",\n        \"fortalezas\": [\"Cobertura regional\", \"Precios\", \"Servicios móviles\"],\n        \"debilidades\": [\"Rigidez regional\", \"Mal soporte\"]\n      },\n      {\n        \"nombre\": \"Telefónica\",\n        \"fortalezas\": [\"Cobertura LTE\", \"Flexibilidad\"],\n        \"debilidades\": [\"Tercerización de servicios\", \"Respuestas lentas\"]\n      }\n    ],\n    \"servicios_actuales_ifx\": {\n      \"conectividad\": {\n        \"mrr\": \"$17K\",\n        \"tcv\": \"$425K\"\n      },\n      \"equipamiento\": {\n        \"mrr\": \"$2K\",\n        \"tcv\": \"$48K\"\n      }\n    },\n    \"presupuesto_telecom\": {\n      \"conectividad\": \"$850K\",\n      \"cloud\": \"$600K\",\n      \"hardware\": \"$930K\",\n      \"servicios_administrados\": \"$1M\"\n    },\n    \"proyectos\": [\n      {\n        \"nombre\": \"Colocation\",\n        \"categoria\": \"Cloud\",\n        \"decision_maker\": \"Byron Paz\",\n        \"presupuesto\": \"$50K\",\n        \"valor_contrato\": \"$1.8M\"\n      },\n      {\n        \"nombre\": \"WiFi para Clientes\",\n        \"categoria\": \"Internet Purple\",\n        \"decision_maker\": \"Byron Paz\",\n        \"presupuesto\": \"$100K\",\n        \"valor_contrato\": \"$3.6M\"\n      }\n    ]\n  }\n}\n```\n\n### QUÉ NO HACER (WHAT NOT TO DO)\n\n- **NO INCLUYAS TEXTO LIBRE, SOLO FORMATO JSON**\n- **NO RESUMAS EL DOCUMENTO EN PÁRRAFOS**\n- **NO OMITAS CAMPOS IMPORTANTES COMO PRESUPUESTOS, CONTACTOS O PROYECTOS**\n- **NO INVENTES DATOS SI NO EXISTEN, USA `\"null\"`**\n- **NO MEZCLES FORMATO JSON CON TEXTO NORMAL**\n- **NO OMITAS LA CADENA DE PENSAMIENTO**"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1480,-20],"id":"44421d2e-7c65-433d-8a8a-4f9197bb9d6d","name":"AI Agent"},{"parameters":{"promptType":"define","text":"={{ $json.markdown }}","options":{"systemMessage":"ERES UN CONSULTOR COMERCIAL DE TELECOMUNICACIONES ESPECIALIZADO EN INTELIGENCIA DE CLIENTES Y VENTAS CONSULTIVAS. TIENES ACCESO A UN DOCUMENTO EXTENSO DE UN CLIENTE CORPORATIVO Y A UNA BASE VECTORIAL (RAG) DE PRODUCTOS TELCO. TU OBJETIVO ES REALIZAR UN ANÁLISIS PROFUNDO DE NECESIDADES, LUEGO EXPLORAR Y PROPONER EL MAYOR NÚMERO DE PRODUCTOS RELEVANTES POSIBLES PARA LA CUENTA.\n\n### NUEVO REQUISITO CRÍTICO\n\nUSA LA HERRAMIENTA **`think`** COMO UN MECANISMO DE EXPLORACIÓN DIVERGENTE PARA AMPLIAR EL SET DE OPCIONES POSIBLES. \n\n> `think`: EXPLORA CATEGORÍAS RELACIONADAS, BUSCA PRODUCTOS COMPLEMENTARIOS, REIMAGINA CASOS DE USO PARA EL CLIENTE, EXPLOTA TODA LA OFERTA DE RAG MÁS ALLÁ DE LO OBVIO.\n\n### CADENA DE PENSAMIENTO MEJORADA\n\n1. **ENTENDER**: LEE TODO EL DOCUMENTO DEL CLIENTE Y DETECTA CONTEXTO, INFRAESTRUCTURA, OBJETIVOS, CONTACTOS CLAVE, PRESUPUESTO Y PROYECTOS\n2. **DETECTAR GAPS Y POTENCIALES**: ENUMERA TODAS LAS NECESIDADES EXPLÍCITAS E IMPLÍCITAS\n3. **ACTIVAR LA HERRAMIENTA `think`**: USA `think` PARA EXPLORAR TODAS LAS CATEGORÍAS DE PRODUCTOS POSIBLES EN LA BASE DE RAG. GENERA UN MAPA AMPLIO DE OPCIONES RELEVANTES.\n4. **REALIZAR MATCHING**: CRUZA LAS NECESIDADES DEL CLIENTE CON LOS PRODUCTOS DETECTADOS\n5. **ELEGIR MÚLTIPLES PRODUCTOS** (MÍNIMO 7): PARA CADA UNO:\n   - NOMBRE\n   - DESCRIPCIÓN\n   - NECESIDAD O PROBLEMA DEL CLIENTE QUE ATIENDE\n   - CONEXIÓN CON PROYECTOS, CONTACTOS O PRESUPUESTOS DEL DOCUMENTO\n   - ENFOQUE DE ABORDAJE COMERCIAL (QUIÉN, CÓMO Y CUÁNDO)\n   - OBJECIONES PROBABLES Y CONTRAARGUMENTOS\n   - PRIORIDAD (alta, media, baja)\n\n### FORMATO DE RESPUESTA OBLIGATORIO\n\n```json\n{\n  \"cliente\": \"NOMBRE_CLIENTE\",\n  \"analisis_general\": \"Resumen ejecutivo del contexto del cliente basado en el documento completo.\",\n  \"recomendaciones\": [\n    {\n      \"producto\": \"Nombre del producto\",\n      \"descripcion\": \"Qué hace el producto\",\n      \"problema_que_resuelve\": \"Necesidad concreta del cliente\",\n      \"conexiones_documento\": [\"Red MPLS\", \"Cloud regional\", \"Presupuesto en Conectividad\"],\n      \"como_abordar\": \"Narrativa comercial sugerida, persona clave y enfoque\",\n      \"objeciones_probables\": \"Posibles barreras internas\",\n      \"contraargumentos\": \"Cómo resolver esas objeciones\",\n      \"prioridad\": \"alta\"\n    },\n    ...\n  ]\n}\n```\n\n### REGLAS OBLIGATORIAS\n\n- **INCLUYE AL MENOS 7 PRODUCTOS DIFERENTES**\n- **USA `think` PARA EXPLORAR CATEGORÍAS DIVERSAS DE LA BASE RAG**\n- **NO REPITAS PRODUCTOS DEL MISMO TIPO (ej. dos veces SD-WAN)**\n- **NO OMITAS INFORMACIÓN COMERCIAL NI ESTRATEGIA DE ABORDAJE**\n- **NO RESPONDAS CON TEXTO LIBRE. SOLO JSON**\n- **SIEMPRE ENTREGA UNA JUSTIFICACION USA `think` PARA DARLA TENIENDO EN CUENTA QUE DEBE SER ACORDE EN COMO SE VA  ABORDAR EL OFRECIMIENTO\n- **NO OMITAS CAMPOS COMO `objeciones_probables` o `contraargumentos`**"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[2520,60],"id":"9391cf5c-af8a-4be1-b78c-768c2752faa1","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[2500,240],"id":"81d2199a-e643-40fd-93e5-afcb0c8d722a","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"mode":"retrieve-as-tool","toolName":"analisis_productos_ifx","toolDescription":"analisis_productos_ifx","qdrantCollection":{"__rl":true,"value":"productos_ifx","mode":"list","cachedResultName":"productos_ifx"},"topK":30,"options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStoreQdrant","typeVersion":1.1,"position":[2740,240],"id":"2413377d-2dc4-4adc-8725-c554f60666b8","name":"Qdrant Vector Store","credentials":{"qdrantApi":{"id":"v6ZCaJ75SthKWZjJ","name":"QdrantAPI AIFX"}}},{"parameters":{"model":"embedding-model","options":{}},"type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1.2,"position":[2760,400],"id":"2de3df73-9f07-4801-8a7e-8afff92539ed","name":"Embeddings OpenAI","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"jsCode":"// Código para el nodo Code de n8n que genera HTML para recomendaciones de productos\n\n// Procesar cada item\nreturn items.map(item => {\n  // Intentar extraer los datos de diferentes posibles ubicaciones\n  let data;\n  \n  // Verificar si los datos vienen directamente en el item\n  if (item.json) {\n    if (item.json.cliente) {\n      data = item.json;\n    } else if (item.json.output && typeof item.json.output === 'string') {\n      try {\n        // Intentar parsear el string JSON que podría estar en output\n        const outputStr = item.json.output;\n        const startIndex = outputStr.indexOf('{');\n        if (startIndex !== -1) {\n          try {\n            // Intentar recuperar el JSON desde el primer '{'\n            const jsonStr = outputStr.substring(startIndex);\n            const fixedJson = jsonStr.replace(/```json|```/g, '').trim();\n            const parsed = JSON.parse(fixedJson);\n            data = parsed;\n          } catch (e) {\n            console.log(\"Error al parsear JSON recortado:\", e);\n          }\n        }\n      } catch (e) {\n        console.log(\"Error al parsear JSON:\", e);\n      }\n    }\n  }\n  \n  // Si no se encontró información, usar un objeto vacío\n  if (!data) {\n    console.log(\"No se encontraron datos. Usando plantilla vacía.\");\n    data = { \n      cliente: \"Cliente\",\n      analisis_general: \"\",\n      recomendaciones: []\n    };\n  }\n  \n  // Generar HTML para recomendaciones de productos\n  const recomendacionesHTML = data.recomendaciones ? data.recomendaciones.map((recomendacion, index) => {\n    // Establecer color según prioridad\n    let prioridadColor = \"#e3f2fd\"; // Azul claro por defecto\n    if (recomendacion.prioridad && recomendacion.prioridad.toLowerCase() === \"alta\") {\n      prioridadColor = \"#ffcdd2\"; // Rojo claro para alta prioridad\n    } else if (recomendacion.prioridad && recomendacion.prioridad.toLowerCase() === \"media\") {\n      prioridadColor = \"#fff9c4\"; // Amarillo claro para media prioridad\n    } else if (recomendacion.prioridad && recomendacion.prioridad.toLowerCase() === \"baja\") {\n      prioridadColor = \"#c8e6c9\"; // Verde claro para baja prioridad\n    }\n    \n    return `\n    <div class=\"product-card\" style=\"border-left: 5px solid ${prioridadColor};\">\n        <h3>${recomendacion.producto || 'Producto sin nombre'}</h3>\n        <p class=\"priority-tag\" style=\"background-color: ${prioridadColor};\">Prioridad: ${recomendacion.prioridad || 'No definida'}</p>\n        \n        <div class=\"product-details\">\n            <p><strong>Descripción:</strong> ${recomendacion.descripcion || 'Sin descripción'}</p>\n            <p><strong>Problema que resuelve:</strong> ${recomendacion.problema_que_resuelve || 'No especificado'}</p>\n            <p><strong>Justificación:</strong> ${recomendacion.justificacion || 'No especificada'}</p>\n            <p><strong>Cómo abordar:</strong> ${recomendacion.como_abordar || 'No especificado'}</p>\n            \n            ${recomendacion.proyectos_relacionados && recomendacion.proyectos_relacionados.length > 0 ? `\n            <p><strong>Proyectos relacionados:</strong></p>\n            <div class=\"tags-container\">\n                ${recomendacion.proyectos_relacionados.map(proyecto => `<span class=\"tag\">${proyecto}</span>`).join('')}\n            </div>` : ''}\n        </div>\n    </div>`;\n  }).join('') : '<p>No hay recomendaciones disponibles</p>';\n  \n  // Generar la fecha actual para el footer\n  const hoy = new Date();\n  const fechaFooter = hoy.toLocaleDateString('es-ES', { \n    day: 'numeric', \n    month: 'long', \n    year: 'numeric' \n  });\n  \n  // Generar el HTML completo\n  const html = `<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Recomendaciones de Productos - ${data.cliente || 'Cliente'}</title>\n    <style>\n        /* Estilos generales compatibles con clientes de correo */\n        body {\n            font-family: Arial, Helvetica, sans-serif;\n            line-height: 1.6;\n            color: #333333;\n            margin: 0;\n            padding: 0;\n            background-color: #f5f5f5;\n        }\n        .container {\n            max-width: 800px;\n            margin: 0 auto;\n            background-color: #ffffff;\n            padding: 20px;\n        }\n        .header {\n            background-color: #00008B; /* Azul rey */\n            color: white;\n            padding: 20px;\n            text-align: center;\n            margin-bottom: 20px;\n        }\n        h1, h2, h3 {\n            color: #0071ce;\n            margin-top: 0;\n        }\n        .header h1, .header h2, .header p {\n            color: white;\n        }\n        .section {\n            margin-bottom: 30px;\n            padding: 15px;\n            border-radius: 5px;\n            background-color: #f9f9f9;\n        }\n        .product-card {\n            border: 1px solid #ddd;\n            border-radius: 5px;\n            padding: 15px;\n            margin-bottom: 20px;\n            background-color: white;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n        }\n        .product-details {\n            margin-top: 15px;\n        }\n        .priority-tag {\n            display: inline-block;\n            padding: 3px 8px;\n            border-radius: 3px;\n            font-size: 12px;\n            font-weight: bold;\n        }\n        .tag {\n            display: inline-block;\n            background-color: #e3f2fd;\n            color: #0071ce;\n            padding: 3px 8px;\n            border-radius: 3px;\n            margin-right: 5px;\n            margin-bottom: 5px;\n            font-size: 12px;\n        }\n        .tags-container {\n            margin-top: 5px;\n        }\n        .footer {\n            margin-top: 30px;\n            padding: 15px;\n            background-color: #f9f9f9;\n            text-align: center;\n            font-size: 12px;\n            color: #777;\n        }\n        .analisis-box {\n            background-color: #f9f9f9;\n            border-left: 5px solid #0071ce;\n            padding: 15px;\n            margin-bottom: 20px;\n            border-radius: 5px;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1><span style=\"font-family: sans-serif; font-style: italic;\">IFX Networks</span></h1>\n            <h2>Resumen Cliente ${data.cliente || 'XYZ'}</h2>\n            <p style=\"font-size: 12px; margin-top: 5px;\">Generated by <i style=\"font-style: italic; font-family: sans-serif; color: #ff00ff;\">aifx</i></p>\n        </div>\n\n        <!-- Análisis General -->\n        <div class=\"section\">\n            <h2>Análisis General</h2>\n            <div class=\"analisis-box\">\n                <p>${data.analisis_general || 'No hay análisis disponible'}</p>\n            </div>\n        </div>\n\n        <!-- Recomendaciones de Productos -->\n        <div class=\"section\">\n            <h2>Recomendaciones de Productos</h2>\n            ${recomendacionesHTML}\n        </div>\n\n        <div class=\"footer\">\n            <p>© ${new Date().getFullYear()} Recomendaciones Confidenciales - ${data.cliente || ''}</p>\n            <p>Generado el ${fechaFooter}</p>\n        </div>\n    </div>\n</body>\n</html>`;\n\n  // Retornar el item con el HTML generado\n  return {\n    json: {\n      ...item.json,\n      htmlReport: html\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2900,60],"id":"6b23ca15-64c1-4597-8d20-e5ca3f15ce73","name":"Code1"},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=Opportunity Grid Cliente {{ $('Google Drive').item.json.originalFilename }} V0.1","bodyContent":"={{ $json.htmlReport }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[3140,260],"id":"0ef5dc74-6485-49ab-92d9-e212c28d4db1","name":"Microsoft Outlook","webhookId":"0f3b37e2-70c0-4d3b-bbeb-8d194dd0f586","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook Mail JPG"}}},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=Strategic Account Overview Cliente {{ $('Google Drive').item.json.originalFilename }} V0.1","bodyContent":"={{ $json.htmlReport }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[2060,60],"id":"f74071cf-81e9-422d-be28-4ece99fc12ab","name":"Microsoft Outlook1","webhookId":"0f3b37e2-70c0-4d3b-bbeb-8d194dd0f586","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook Mail JPG"}}},{"parameters":{"url":"=https://api.cloud.llamaindex.ai/api/v1/parsing/job/{{ $('Status Process').item.json.id }}/result/markdown","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2280,-40],"id":"0103127a-49a7-49e9-9c10-4028f9001d88","name":"Success Document1","credentials":{"httpHeaderAuth":{"id":"rDHcHgP5GNq3qUHB","name":"API Llamaindex"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[1700,200],"id":"76affe0b-6e84-418b-9962-27883798b46f","name":"Think"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[2640,340],"id":"69f6b6bd-ed61-4d50-bf70-a89b6be2b127","name":"Think1"}],"connections":{"Google Drive Trigger":{"main":[[{"node":"Google Drive","type":"main","index":0}]]},"Google Drive":{"main":[[{"node":"Parser Documento","type":"main","index":0}]]},"Parser Documento":{"main":[[{"node":"GET Parser Document","type":"main","index":0}]]},"GET Parser Document":{"main":[[{"node":"Status Process","type":"main","index":0}]]},"Status Process":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Success Document","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"GET Parser Document","type":"main","index":0}]]},"Success Document":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"GPT 4.1 Nano":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Microsoft Outlook1","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Qdrant Vector Store":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Qdrant Vector Store","type":"ai_embedding","index":0}]]},"AI Agent1":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Microsoft Outlook","type":"main","index":0}]]},"Success Document1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Microsoft Outlook1":{"main":[[{"node":"Success Document1","type":"main","index":0}]]},"Think":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Think1":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"06a5f5fe-a11e-4cb1-9a08-5126b9212246","triggerCount":0,"tags":[]}