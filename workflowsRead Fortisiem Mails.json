{"createdAt":"2025-05-24T15:26:52.421Z","updatedAt":"2025-05-26T18:13:20.000Z","id":"mXMdnFx62r5nfBcF","name":"Read Fortisiem Mails","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"move","messageId":{"__rl":true,"value":"={{ $('New Email Trigger').item.json.id }}","mode":"id"},"folderId":{"__rl":true,"value":"AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA=","mode":"list","cachedResultName":"Fortisiem Ready","cachedResultUrl":"https://outlook.office365.com/mail/AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C%2FOf%2FSaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA%3D"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1600,300],"id":"5cedf8d1-6b76-4ee8-82be-c17ece572bcf","name":"Moves Message","webhookId":"7ab5105a-a19d-412a-8c38-0647a7ca659f","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"html":"={{ $json.body.content }}","options":{}},"type":"n8n-nodes-base.markdown","typeVersion":1,"position":[1200,320],"id":"22c1d915-08b2-49ed-a957-a3aa24eed11c","name":"Markdown"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1400,320],"id":"c9fada68-3510-4004-ac7a-37adaa4f1bf1","name":"Loop Over Items"},{"parameters":{"text":"={{ $json.data }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"customer\": \"TPA\",\n  \"mainTitle\": \"[New] TPADC03:Windows User Account Disabled (TPA)\",\n  \"incidentTitle\": \"Excessive Denied Connections from Philippines\",\n  \"incidentID\": \"85555\",\n  \"firstOccurrenceTime\": \"13 may 2025, 11:58:45 AM\",\n  \"lastOccurrenceTime\": \"13 may 2025, 11:08:30 AM\",\n  \"severity\": \"MEDIO (7)\",\n  \"severityType\":\"severity-medium\",\n  \"incidentCount\": \"1\",\n  \"incidentCategory\": \"Cambio/Persistencia\",\n  \"notificationPolicyID\": \"1707853\",\n  \"ruleName\": \"Windows User Account Disabled\",\n  \"ruleDescription\": \"Detecta que una cuenta de usuario de Windows fue deshabilitada en un servidor\",\n  \"sourceCountry\": \"Filipinas\",\n  \"hostName\": \"TPADC03\",\n  \"user\": \"administrator\",\n  \"targetUser\": \"mmendez\",\n  \"targetUserGroup\": \"IIS_IUSRS\",\n  \"domain\": \"TPA\",\n  \"triggeredEventCount\": \"511\",\n  \"rawEvents\": \"N/A\"\n}","options":{"systemPromptTemplate":"ERES UN AGENTE EXTRACTOR DE DATOS AVANZADO, ENTRENADO PARA LEER CORREOS ELECTRÓNICOS Y ORGANIZAR SU CONTENIDO EN UNA ESTRUCTURA DE CLAVES Y VALORES ANIDADOS, TODO EN UNA SOLA LÍNEA. HAS SIDO OPTIMIZADO PARA FUNCIONAR CON LLAMA 3.3 70B Y DEBES RESPONDER DE FORMA FORMATEADA Y LIMPIA, SIN INTRODUCIR SALTOS DE LÍNEA, SANGRÍAS, COMENTARIOS NI MARCADORES.\n\n###INSTRUCCIONES###\n\n- ANALIZA TODO EL CONTENIDO DEL CORREO ELECTRÓNICO DETENIDAMENTE  \n- EXTRAE LA INFORMACIÓN CLAVE QUE CORRESPONDE A CADA CLAVE DE LA ESTRUCTURA QUE SE MUESTRA  \n- ORDENA LA INFORMACIÓN SEGÚN EL ESQUEMA DEFINIDO, RESPETANDO LA JERARQUÍA DE CLAVES Y SUBCLAVES  \n- TODOS LOS VALORES DEBEN ESTAR EN ESPAÑOL LATINOAMERICANO, SALVO LOS TÉRMINOS TÉCNICOS QUE DEBEN CONSERVARSE EN INGLÉS  \n- FORMATEA LAS FECHAS AL ESTILO \"30 abr 2025, 01:16:45 PM\"  \n- EXTRAE EL NOMBRE DEL CLIENTE DESDE EL `Subject`, BUSCANDO **EXCLUSIVAMENTE EL TEXTO QUE APARECE DENTRO DEL PARÉNTESIS FINAL**. POR EJEMPLO, SI EL SUBJECT ES: `[New] TPADC03:Windows User Account Disabled (TPA)`, EL NOMBRE DEL CLIENTE ES `\"TPA\"`  \n- LA SALIDA DEBE SER ENTREGADA **COMPLETAMENTE EN UNA SOLA LÍNEA**, SIN SALTOS DE LÍNEA, NI RETORNOS, NI ESPACIOS INNECESARIOS ENTRE CLAVES  \n- SI ALGÚN DATO NO ESTÁ PRESENTE EN EL CORREO, DEBES ESCRIBIR EL VALOR `\"N/A\"` PARA ESA CLAVE  \n\n###REGLAS PARA CAMPOS `user`, `targetUser`, `domain`, `hostname`###\n\n\n-  EN EL JSON DE SALIDA `\"hostname\"` DEBE CONTENER EL VALOR DEL CAMPO \"Hostname\" O QUIEN GENERA LA ACCIÓN EN EL INCIDENTE \n-  EN EL JSON DE SALIDA `\"user\"` DEBE CONTENER EL VALOR DEL CAMPO \"User\" O QUIEN GENERA LA ACCIÓN EN EL INCIDENTE \n-  EN EL JSON DE SALIDA `\"targetUser\"` DEBE CONTENER EL VALOR DEL CAMPO \"Target User\", QUIEN RECIBE O SUFRE LA ACCIÓN  \n-  EN EL JSON DE SALIDA `\"domain\"` DEBE TOMARSE EXCLUSIVAMENTE DEL CAMPO \"Domain\" SI EXISTE; DE LO CONTRARIO, COLOCAR `\"N/A\"`  \n- SI EL CORREO INCLUYE `\"User: administrator\"` Y `\"Target User: mmendez\"` → `\"user\":\"administrator\"` Y `\"targetUser\":\"mmendez\"`  \n- NO INTERCAMBIAR NI REEMPLAZAR LOS VALORES ENTRE ESTOS CAMPOS\n- SI EN EL CORREO NO ENCUENTRAS LA INFORMACION O EL CAMPO DEVUELVE \"N/A\"\n\n###REGLAS PARA SEVERITY Y SEVERITYTYPE###\n\n- `\"severity\"` DEBE CONTENER **EL VALOR COMPLETO EXACTO DEL CAMPO \"Event Severity\"**, INCLUYENDO NÚMEROS ENTRE PARÉNTESIS (ej. `\"MEDIUM (7)\"`)\n- `\"severityType\"` DEBE SER UNA VERSIÓN **NORMALIZADA Y DERIVADA EXCLUSIVAMENTE DEL TEXTO PRINCIPAL DE \"Event Severity\"**, IGNORANDO CUALQUIER PARÉNTESIS U OTROS DETALLES.  \n  - SI CONTIENE `\"LOW\"` → `\"severity-low\"`  \n  - SI CONTIENE `\"MEDIUM\"` → `\"severity-medium\"`  \n  - SI CONTIENE `\"HIGH\"` → `\"severity-high\"`  \n  - CUALQUIER OTRO VALOR → `\"severity-unknown\"`  \n- ESTÁ **TERMINANTEMENTE PROHIBIDO** COPIAR DIRECTAMENTE EL VALOR DE `\"severity\"` EN `\"severityType\"`\n\n###CADENA DE RAZONAMIENTO###\n\n1. ENTENDER: INTERPRETA EL CORREO COMPLETO PARA COMPRENDER EL CONTEXTO DEL INCIDENTE  \n2. DETECTAR: UBICA TODAS LAS PIEZAS DE INFORMACIÓN NECESARIAS  \n3. ORGANIZAR: ALINEA CADA DATO EXTRAÍDO CON SU CLAVE CORRESPONDIENTE EN LA ESTRUCTURA  \n4. AJUSTAR: TRADUCE VALORES, NORMALIZA FORMATO DE FECHAS Y NOMBRES  \n5. EXTRAER CLIENTE: DETECTA EL `Subject`, BUSCA LOS PARÉNTESIS AL FINAL Y EXTRAE **EXACTAMENTE EL TEXTO ENTRE PARÉNTESIS** COMO VALOR DE `\"customer\"`  \n6. COMPLETAR VACÍOS: SI FALTA ALGÚN DATO, COLOCA `\"N/A\"` COMO VALOR  \n7. DERIVAR `severityType`: ANALIZA EXCLUSIVAMENTE LA SECCIÓN TEXTUAL ANTES DEL PARÉNTESIS EN `\"Event Severity\"`, Y GENERA `\"severityType\"` COMO `\"severity-<nivel>\"`  \n8. CONSTRUIR: GENERA UNA ESTRUCTURA ANIDADA CON TODA LA INFORMACIÓN EN UNA SOLA LÍNEA  \n9. VALIDAR: VERIFICA QUE NO HAYA SALTOS DE LÍNEA, COMENTARIOS NI CAMPOS VACÍOS  \n\n###PROHIBIDO###\n\n- NO USAR SALTOS DE LÍNEA (\\n), NI ESPACIOS INNECESARIOS  \n- NO USAR COMILLAS INVERTIDAS, NI ETIQUETAS DE CÓDIGO  \n- NO INCLUIR COMENTARIOS, EXPLICACIONES, NI TEXTO FUERA DE LA ESTRUCTURA  \n- NO INVENTAR CAMPOS, NI DUPLICAR CLAVES  \n- NO OMITIR CAMPOS; SI NO EXISTE UN DATO, USA \"N/A\"  \n- **NO COPIAR TEXTUALMENTE EL VALOR DE \"Event Severity\" EN EL CAMPO \"severityType\"**  \n  - ❌ INCORRECTO: `\"severity\":\"MEDIUM (7)\", \"severityType\":\"MEDIUM (7)\"`  \n  - ❌ INCORRECTO: `\"severity\":\"HIGH (9)\", \"severityType\":\"HIGH (9)\"`  \n  - ✅ CORRECTO: `\"severity\":\"HIGH (9)\", \"severityType\":\"severity-high\"`  \n- **NO ASIGNAR ERRÓNEAMENTE `user`, `targetUser` O `domain` SI EL NOMBRE DEL CAMPO ES EXPLÍCITO**  \n  - ❌ INCORRECTO: `\"targetUser\":\"administrator\", \"user\":\"mmendez\"`  \n  - ✅ CORRECTO: `\"user\":\"administrator\", \"targetUser\":\"mmendez\"`\n\n###EJEMPLO DE ENTRADA###\n\nSubject: [New] TPADC03:Windows User Account Disabled (TPA)  \nIncident Title: Excessive Denied Connections from Philippines  \nIncidentID: 85555  \nIncident First Occurrence Time: May 13 2025, 11:58:45 AM  \nIncident Last Occurrence Time: May 13 2025, 11:08:30 AM  \nEvent Severity: MEDIUM (7)  \nIncident Count: 1  \nIncident Category: Change/Persistence  \nNotification Policy ID: 1707853  \nRule Name: Windows User Account Disabled  \nRemediation: Make sure it is an authorized change  \nRule Description: Detects Windows user account disabled on a server  \nSource Country: Philippines  \nHost Name: TPADC03  \nUser: administrator  \nTarget User: mmendez\nTarget User Group:  IIS_IUSRS\nDomain: TPA  \nTriggered Event Count: 511\n"}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[800,560],"id":"371ed217-71b4-472a-b669-c8db79dbb3b8","name":"Extractor Mail Fields"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1200,560],"id":"b6860116-2dfa-4468-ba91-d6d6409a822c","name":"Merge"},{"parameters":{"assignments":{"assignments":[{"id":"05a1a813-ca14-4d73-813d-8cd5478f317a","name":"customer","value":"={{ $json.output.customer }}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1420,560],"id":"d7ebcfb2-70dc-4ce5-88ec-6375efa05567","name":"Edit Fields"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"=fortisiem_incidents","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"customer":"={{ $('Aggregate Information').first().json.data.first().customer }}","main_title":"={{ $('Aggregate Information').first().json.data.first().output.mainTitle }}","incident_title":"={{ $('Aggregate Information').first().json.data.first().output.incidentTitle }}","incident_id":"={{ $('Aggregate Information').first().json.data.first().output.incidentID }}","first_occurrence_time":"={{ $json.firstOccurrenceTime_converted }}","last_occurrence_time":"={{ $json.lastOccurrenceTime_converted }}","incident_count":"={{ $('Aggregate Information').first().json.data.first().output.incidentCount }}","notification_policy_id":"={{ $('Aggregate Information').first().json.data.first().output.notificationPolicyID }}","triggered_event_count":"={{ $('Aggregate Information').first().json.data.first().output.triggeredEventCount }}","severity":"={{ $('Aggregate Information').first().json.data.first().output.severity }}","severity_type":"={{ $('Aggregate Information').first().json.data.first().output.severityType }}","incident_category":"={{ $('Aggregate Information').first().json.data.first().output.incidentCategory }}","rule_name":"={{ $('Aggregate Information').first().json.data.first().output.ruleName }}","rule_description":"={{ $('Aggregate Information').first().json.data.first().output.ruleDescription }}","source_country":"={{ $('Aggregate Information').first().json.data.first().output.sourceCountry }}","host_name":"={{ $('Aggregate Information').first().json.data.first().output.hostName }}","user_account":"={{ $('Aggregate Information').first().json.data.first().output.user }}","target_user":"={{ $('Aggregate Information').first().json.data.first().output.targetUser }}","domain":"={{ $('Aggregate Information').first().json.data.first().output.domain }}","raw_events":"={{ $('Aggregate Information').first().json.data.first().output.rawEvents }}","analysis_output":"={{ $('Aggregate Information').first().json.data.last().output }}","target_user_group":"={{ $('Aggregate Information').first().json.data.first().output.targetUserGroup }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"tt_number","displayName":"tt_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"customer","displayName":"customer","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"main_title","displayName":"main_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_title","displayName":"incident_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_id","displayName":"incident_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"first_occurrence_time","displayName":"first_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"last_occurrence_time","displayName":"last_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"severity","displayName":"severity","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"severity_type","displayName":"severity_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_count","displayName":"incident_count","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_category","displayName":"incident_category","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"notification_policy_id","displayName":"notification_policy_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"rule_name","displayName":"rule_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"rule_description","displayName":"rule_description","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"source_country","displayName":"source_country","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"host_name","displayName":"host_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"user_account","displayName":"user_account","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"target_user","displayName":"target_user","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"domain","displayName":"domain","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"triggered_event_count","displayName":"triggered_event_count","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"raw_events","displayName":"raw_events","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"analysis_output","displayName":"analysis_output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"target_user_group","displayName":"target_user_group","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1840,700],"id":"46e5724e-b8f5-46b1-8011-c78c7a797f3d","name":"Insert Event DB","credentials":{"postgres":{"id":"NfJHLM3V8jbiKzoD","name":"Postgres DB SOC"}}},{"parameters":{"promptType":"define","text":"={{ $json.output.rawEvents }}","options":{"systemMessage":"ERES UN AGENTE DE CIBERSEGURIDAD DE NIVEL ÉLITE ESPECIALIZADO EN ANÁLISIS AUTOMÁTICO DE LOGS GENERADOS POR FORTISIEM. TU MISIÓN ES INTERPRETAR LOS “RAW EVENTS” DE CADA ALERTA Y PROPORCIONAR DOS RESPUESTAS:\n\n###RESPUESTA 1: HTML FORMATADA###\n\nDEVUELVE UNA RESPUESTA DENTRO DE UNA ETIQUETA `<div>` QUE INCLUYA:\n\n- UNA EXPLICACIÓN CLARA DEL INCIDENTE DETECTADO  \n- UNA RECOMENDACIÓN DE REMEDIACIÓN BASADA EN ESTÁNDARES (NIST, MITRE ATT&CK, CIS, OWASP, ETC.)  \n- ENLACES HIPERVINCULADOS USANDO `<a href=\"URL\">URL</a>` — **LA URL DEBE SER VISIBLE Y CLICABLE, NO DEBE ESTAR ENTRE CORCHETES NI COMILLAS**  \n- USA SOLO LAS SIGUIENTES ETIQUETAS HTML: `<div>`, `<br>`, `<a>`, `<code>`  \n- EVITA CUALQUIER ESTILO CSS, ETIQUETAS ADICIONALES O BLOQUES HTML EXTERNOS  \n- SEPARA IDEAS CON `<br>` PARA MEJOR LEGIBILIDAD  \n\n###RESPUESTA 2: CONSULTA SERPAPI###\n\nGENERA UNA CONSULTA EN FORMATO JSON OPTIMIZADA PARA LA TOOL SERPAPI CUANDO HAY IOCS (IP, PUERTOS, URL, CVEs, ETC.). ESTA CONSULTA DEBE ESTAR:\n\n- FORMULADA EN LENGUAJE NATURAL TÉCNICO COMO LO HARÍA UN ANALISTA CTI/OSINT  \n- ENRIQUECIDA CON CONTEXTO (IP, país, servicio, tipo de intento, endpoint)  \n- ENFOCADA EN UNO O MÁS DE LOS SIGUIENTES EJES:\n  - Reputación y comportamiento malicioso de IPs\n  - Tácticas, técnicas y procedimientos MITRE\n  - Herramientas ofensivas utilizadas (Masscan, ZMap, etc.)\n  - Puertos o servicios vulnerables\n  - Recomendaciones prácticas (CVE patches, hardening, detección)\n\n###CADENA DE RAZONAMIENTO (CHAIN OF THOUGHTS)###\n\n1. **UNDERSTAND**: EXTRAER del “RAW EVENTS” todos los datos clave (IP, puertos, rutas, protocolos, geolocalización, user-agent, etc.)\n2. **BASICS**: IDENTIFICAR IOCS, técnicas MITRE, patrones conocidos o CVEs\n3. **BREAK DOWN**: CLASIFICAR roles (origen/destino), servicios implicados, tecnología expuesta\n4. **ANALYZE**: EVALUAR severidad, posible explotación y relación con campañas conocidas\n5. **SEARCH QUERY**: FORMULAR UNA CONSULTA DETALLADA PARA SERPAPI (JSON)\n6. **BUILD**: REDACTAR UN BLOQUE `<div>` CON LA EXPLICACIÓN + RESULTADO DE LA CONSULTA + RECOMENDACIONES ENRIQUECIDAS CON LINKS\n7. **FINAL OUTPUT**: DEVOLVER DOS BLOQUES:\n   - `<div>` CON TEXTO, IOCS Y LINKS CORRECTAMENTE FORMATEADOS\n   - BLOQUE JSON CON LA CONSULTA SERPAPI\n\n###QUÉ NO HACER (WHAT NOT TO DO)###\n\n- **NUNCA FORMATEES ENLACES COMO**:\n  - [\"https://...\"]https://...\n  - [\"texto\"](https://...)\n  - \"[https://url]\"\n  - <a href=\"https://url\">texto personalizado</a>\n- **SIEMPRE USA**: <a href=\"https://url\">https://url</a>\n  - EL CONTENIDO DEL ENLACE DEBE SER IGUAL AL VALOR DE `href`, POR POLÍTICAS DE SEGURIDAD Y TRAZABILIDAD\n\n- **NUNCA OMITAS LA CONSULTA SERPAPI CUANDO HAY IOCS**\n- **NUNCA INVENTES UNA TÉCNICA MITRE COMO T1190 POR DEFECTO**\n- **NUNCA USES ETIQUETAS HTML DIFERENTES A `<div>`, `<br>`, `<a>`, `<code>`**\n- **NUNCA INCLUYAS ENLACES A LAS PÁGINAS PRINCIPALES DE MARCOS DE SEGURIDAD** — USA LINKS DIRECTOS A LA SECCIÓN O CONTROL APLICABLE\n- **NUNCA OMITAS LA RECOMENDACIÓN DE ACCIÓN ESPECÍFICA Y REFERENCIADA**\n- **⚠️ NUNCA COPIES, REUTILICES NI REPITAS LOS DATOS, FRASES O EJEMPLOS QUE APARECEN EN ESTE PROMPT DEL SISTEMA**\n  - **CADA SALIDA DEBE ESTAR BASADA EXCLUSIVAMENTE EN EL EVENTO “RAW EVENTS” ACTUAL**\n  - **ESTÁ TERMINANTEMENTE PROHIBIDO USAR COMO RESPUESTA LOS MISMOS DATOS DEL FEW-SHOT**\n\n###FEW-SHOT EXAMPLE###\n\n**INPUT:**\nRaw Events: srcip=89.45.67.123 dstip=172.16.0.20 dstport=5985 protocol=TCP action=connection_failed country_src=Russia\n\n**OUTPUT:**\n<div>\nSe detectó un intento de conexión fallida desde la IP 89.45.67.123 (Rusia) hacia el host interno 172.16.0.20 sobre el puerto 5985/TCP, utilizado por WinRM.<br>\nEste comportamiento podría indicar un intento de escaneo o acceso no autorizado a interfaces administrativas.<br>\nSegún fuentes OSINT, esta IP está asociada a escaneos automatizados dirigidos a servicios WinRM expuestos.<br>\nSe recomienda aplicar restricciones a servicios administrativos, monitoreo con reglas específicas y bloqueo de IP maliciosas.<br>\nRevisar reputación de IP: <a href=\"https://www.abuseipdb.com/check/89.45.67.123\">https://www.abuseipdb.com/check/89.45.67.123</a><br>\nTécnica MITRE ATT&CK T1046 - Network Service Discovery: <a href=\"https://attack.mitre.org/techniques/T1046/\">https://attack.mitre.org/techniques/T1046/</a><br>\nAplicar CIS Control 9.2 para limitar puertos expuestos: <a href=\"https://www.cisecurity.org/controls/limitation-and-control-of-network-ports\">https://www.cisecurity.org/controls/limitation-and-control-of-network-ports</a><br>\n</div>\n\n**JSON Search Query:**\n```json\n{\n  \"q\": \"Reputación y comportamiento malicioso de la IP 89.45.67.123 originando conexiones fallidas al puerto 5985 (WinRM) en una red interna. ¿Está asociada a campañas de escaneo o explotación automatizada? Incluir técnicas MITRE, CVEs relevantes y medidas de mitigación.\",\n  \"engine\": \"google\",\n  \"num\": 10\n}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[800,780],"id":"459a34cf-ed67-4a83-94cd-e41dcfaad8d8","name":"AI Analityc Log SIEM"},{"parameters":{"model":{"__rl":true,"value":"openai-nano","mode":"list","cachedResultName":"openai-nano"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[640,700],"id":"f17b97ab-b0e3-487e-874f-43c43ba2876e","name":"AI Extract Fields","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"model":{"__rl":true,"value":"openai-mini","mode":"list","cachedResultName":"openai-mini"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[640,860],"id":"01e39db7-3f37-4ecd-9445-0c2b9d9d1970","name":"Llama 3","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1200,780],"id":"53facab4-a8bc-480c-b068-322b2130a7d2","name":"Aggregate Information"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Ciberseguridad</title>\n  <style>\n    /* Estilos generales - compatibles con clientes de correo */\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      margin: 0;\n      padding: 0;\n      background-color: #f8f9fa;\n      color: #333;\n      line-height: 1.6;\n    }\n\n    .container {\n      max-width: 650px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #ffffff;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n    }\n\n    .header-img {\n      width: 100%;\n      height: auto;\n      display: block;\n      margin-bottom: 15px;\n      border-radius: 6px 6px 0 0;\n    }\n\n    .header {\n      background: #2980b9;\n      color: white;\n      padding: 15px;\n      text-align: center;\n      border-radius: 6px;\n      margin-bottom: 20px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n    }\n\n    .alert-icon {\n      font-size: 22px;\n      margin-right: 10px;\n      vertical-align: middle;\n    }\n\n    h1 {\n      margin: 0;\n      padding: 0;\n      font-size: 20px;\n      color: white;\n      letter-spacing: 0.5px;\n    }\n\n    h2 {\n      color: #2874a6;\n      font-size: 18px;\n      margin-top: 0;\n      border-bottom: 2px solid #2874a6;\n      padding-bottom: 8px;\n      letter-spacing: 0.3px;\n    }\n\n    .incident-summary {\n      background-color: #f1f8fe;\n      padding: 15px;\n      border-left: 5px solid #3498db;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .severity-low {\n      display: inline-block;\n      background-color: #FEEA00;\n      color: black;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-medium {\n      display: inline-block;\n      background-color: #f39c12;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-high {\n      display: inline-block;\n      background-color: #e4011a;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .highlight {\n      color: #2874a6;\n      font-weight: bold;\n    }\n\n    .priority-item {\n      border-left: 3px solid #e74c3c;\n      padding-left: 10px;\n      font-weight: 600;\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 20px;\n      border-radius: 6px;\n      overflow: hidden;\n      box-shadow: 0 2px 3px rgba(0,0,0,0.05);\n    }\n\n    table, th, td {\n      border: 1px solid #e0e0e0;\n    }\n\n    th {\n      background-color: #eaf2f8;\n      text-align: left;\n      padding: 12px;\n      width: 40%;\n      color: #2874a6;\n      font-weight: 600;\n    }\n\n    td {\n      padding: 12px;\n      word-break: break-word;\n      background-color: #ffffff;\n    }\n\n    tr:hover td {\n      background-color: #f9f9f9;\n    }\n\n    .section {\n      margin-bottom: 25px;\n    }\n\n    .remediation {\n      background-color: #e8f4fc;\n      border-left: 5px solid #3498db;\n      padding: 15px;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .remediation h2 {\n      color: #2874a6;\n      border-bottom-color: #3498db;\n    }\n\n    .remediation-content {\n      font-weight: 500;\n    }\n\n    .footer {\n      font-size: 12px;\n      color: #777;\n      text-align: center;\n      margin-top: 20px;\n      padding-top: 15px;\n      border-top: 1px solid #eee;\n    }\n\n    .footer-img {\n      width: 100%;\n      max-width: 650px;\n      height: auto;\n      display: block;\n      margin: 10px auto;\n      border-radius: 0 0 6px 6px;\n    }\n\n    .signature {\n      font-size: 6px;\n      font-family: sans-serif;\n      text-align: right;\n      margin-right: 4px;\n      color: #999;\n      margin-bottom: 5px;\n    }\n\n    .signature span {\n      font-style: italic;\n      color: #9c27b0;\n      font-weight: bold;\n      font-family: serif;\n      font-size: 9px;\n    }\n\n    /* Estilos responsivos */\n    @media screen and (max-width: 600px) {\n      .container {\n        width: 100%;\n        padding: 10px;\n      }\n\n      th, td {\n        display: block;\n        width: auto;\n      }\n\n      th {\n        border-bottom: none;\n      }\n\n      td {\n        border-top: none;\n      }\n    }\n  </style>\n</head>\n\n<body>\n  <div class=\"container\">\n    <img class=\"header-img\"\n      src=\"https://github.com/ifxnetworks/Dise-o/blob/main/Header_Comunicado_Cyberseguridad_IFX_CL_(2.0).png?raw=true\"\n      alt=\"Encabezado de Ciberseguridad\">\n    <div class=\"signature\">Generated by <span>aifx</span></div>\n    <div class=\"header\">\n      <span class=\"alert-icon\">⚠️</span>\n      <h1 id=\"mainTitle\">{{ $('New Email Trigger').item.json.subject }}</h1>\n    </div>\n\n    <div class=\"incident-summary\">\n      <h2 id=\"incidentTitle\">{{ $json.data[0].output.incidentTitle }}</h2>\n      <p><strong>Cliente:</strong> <span style=\"text-transform: uppercase\" id=\"customer\">{{ $json.data[0].output.customer }}</span></p>\n      <p><strong>ID del Incidente:</strong> <span id=\"incidentID\">{{ $json.data[0].output.incidentID }}</span></p>\n      <p><strong>Severidad:</strong> <span id=\"severity\" class=\"{{ $json.data[0].output.severityType }}\">{{ $json.data[0].output.severity }}</span></p>\n    </div>\n    <div class=\"section\">\n      <h2>Detalles del Incidente</h2>\n      <table>\n        <tr>\n          <th>Primera Ocurrencia</th>\n          <td id=\"firstOccurrenceTime\">{{ $json.data[0].output.firstOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Última Ocurrencia</th>\n          <td id=\"lastOccurrenceTime\">{{ $json.data[0].output.lastOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Categoría</th>\n          <td id=\"incidentCategory\">{{ $json.data[0].output.incidentCategory }}</td>\n        </tr>\n        <tr>\n          <th>Conteo de Incidentes</th>\n          <td id=\"incidentCount\">{{ $json.data[0].output.incidentCount }}</td>\n        </tr>\n        <tr>\n          <th>ID de Política de Notificación</th>\n          <td id=\"notificationPolicyID\">{{ $json.data[0].output.notificationPolicyID }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Información de la Regla</h2>\n      <table>\n        <tr>\n          <th>Nombre de la Regla</th>\n          <td id=\"ruleName\" class=\"priority-item\">{{ $json.data[0].output.ruleName }}</td>\n        </tr>\n        <tr>\n          <th>Descripción de la Regla</th>\n          <td id=\"ruleDescription\">{{ $json.data[0].output.ruleDescription }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Detalles del Sistema</h2>\n      <table>\n        <tr>\n          <th>Nombre del Host</th>\n          <td id=\"hostName\">{{ $json.data[0].output.hostName }}</td>\n        </tr>\n        <tr>\n          <th>Usuario</th>\n          <td id=\"user\">{{ $json.data[0].output.user }}</td>\n        </tr>\n        <tr>\n          <th>Usuario Objetivo</th>\n          <td id=\"targetUser\" class=\"priority-item\">{{ $json.data[0].output.targetUser }}</td>\n        </tr>\n        <tr>\n          <th>Grupo Objetivo</th>\n          <td id=\"targetUser\" class=\"priority-item\">{{ $json.data[0].output.targetUserGroup }}</td>\n        </tr>\n        <tr>\n          <th>Dominio</th>\n          <td id=\"domain\">{{ $json.data[0].output.domain }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"remediation\">\n      <h2>Remediación Recomendada</h2>\n      <p id=\"remediation\" class=\"remediation-content priority-item\">{{ $json.data[1].output }}</p>\n    </div>\n\n    <div class=\"footer\">\n      <img class=\"footer-img\" src=\"https://raw.githubusercontent.com/ifxnetworks/Ansible/refs/heads/main/Imagen1nnlnl.jpg\" \n     alt=\"Pie de página\" style=\"width: 100%; height: auto;\">\n      <p>Este es un mensaje automatizado de alerta de seguridad. Por favor, no responda a este correo.</p>\n      <p>Para obtener soporte contacte con <a href=\"mailto:soc-cl@ifxcorp.com\" style=\"color: #3498db;\">soc-cl@ifxcorp.com</a></p>\n    </div>\n  </div>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1420,780],"id":"119e7309-b7cd-4c2c-ad22-8203242c1d16","name":"HTML Template"},{"parameters":{"toRecipients":"soc-cl@ifxcorp.com","subject":"=Analisis de Log: {{ $('New Email Trigger').item.json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1200,1000],"id":"7b1d3115-73f9-4b77-922f-2a8961f47b77","name":"Send Analysis","webhookId":"9fba1cd7-b460-428c-852c-f38e37b6620e","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=Analisis de Log: {{ $('Microsoft Outlook').item.json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1640,880],"id":"50af986c-7d16-4aaa-ab17-6d4f801c4140","name":"Mail Test","webhookId":"69504935-3c14-4ea7-8805-973c1c07c7d2","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook jaimep@ifxcorp.com"}},"disabled":true},{"parameters":{"operation":"get","messageId":{"__rl":true,"mode":"list","value":""},"output":"raw","options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[980,320],"id":"89b55ec5-7841-4ab1-89c5-ff9321ac48a5","name":"Microsoft Outlook","webhookId":"e9aba4c5-a138-41fc-bb76-52c1fc245b6b","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}},"disabled":true},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"output":"fields","fields":["body","conversationId","createdDateTime","subject"],"filters":{"foldersToInclude":["AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAIxI7UAAA="],"readStatus":"unread"},"options":{}},"type":"n8n-nodes-base.microsoftOutlookTrigger","typeVersion":1,"position":[780,320],"id":"70e70b5e-5245-4ad6-a93c-c80b971cfdb5","name":"New Email Trigger","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"jsCode":"// Función para convertir fechas españolas a timestamp PostgreSQL\nconst items = $input.all();\n\n// Función para convertir fecha española a timestamp\nfunction convertSpanishDateToTimestamp(dateStr) {\n  if (!dateStr || dateStr === 'N/A') return null;\n  \n  // Mapeo de meses en español\n  const monthMap = {\n    'ene': 'Jan', 'feb': 'Feb', 'mar': 'Mar', 'abr': 'Apr',\n    'may': 'May', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Aug',\n    'sep': 'Sep', 'oct': 'Oct', 'nov': 'Nov', 'dic': 'Dec'\n  };\n  \n  // Reemplazar mes español por inglés\n  let englishDate = dateStr;\n  for (const [spanish, english] of Object.entries(monthMap)) {\n    englishDate = englishDate.replace(new RegExp(spanish, 'gi'), english);\n  }\n  \n  try {\n    // Convertir a formato timestamp PostgreSQL\n    const date = new Date(englishDate);\n    return date.toISOString().replace('T', ' ').substring(0, 19);\n  } catch (error) {\n    console.log(`Error converting date: ${dateStr}`, error);\n    return null;\n  }\n}\n\n// Procesar cada item\nconst processedItems = items.map(item => {\n  const data = item.json;\n  \n  // Obtener datos del nodo Aggregate Information\n  const aggregateData = $('Aggregate Information').first().json;\n  \n  if (aggregateData && aggregateData.data && aggregateData.data.length > 0) {\n    const firstOutput = aggregateData.data[0].output;\n    \n    return {\n      json: {\n        ...data,\n        firstOccurrenceTime: firstOutput.firstOccurrenceTime,\n        lastOccurrenceTime: firstOutput.lastOccurrenceTime,\n        firstOccurrenceTime_converted: convertSpanishDateToTimestamp(firstOutput.firstOccurrenceTime),\n        lastOccurrenceTime_converted: convertSpanishDateToTimestamp(firstOutput.lastOccurrenceTime)\n      }\n    };\n  }\n  \n  return item;\n});\n\nreturn processedItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1640,700],"id":"22dc3b71-f877-40b7-824e-1fd4c19bd2c6","name":"Code"},{"parameters":{"options":{"google_domain":"google.com"}},"type":"@n8n/n8n-nodes-langchain.toolSerpApi","typeVersion":1,"position":[640,1020],"id":"93ae7a60-9e92-40a5-b7fb-66b9e25d45fa","name":"SerpAPI","credentials":{"serpApi":{"id":"MRuXkXXO6TX2gDPo","name":"SerpAPI JPG"}}}],"connections":{"Moves Message":{"main":[[]]},"Markdown":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Moves Message","type":"main","index":0}],[{"node":"Extractor Mail Fields","type":"main","index":0}]]},"Extractor Mail Fields":{"main":[[{"node":"Merge","type":"main","index":0},{"node":"AI Analityc Log SIEM","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Aggregate Information","type":"main","index":0}]]},"AI Analityc Log SIEM":{"main":[[{"node":"Merge","type":"main","index":1}]]},"AI Extract Fields":{"ai_languageModel":[[{"node":"Extractor Mail Fields","type":"ai_languageModel","index":0}]]},"Llama 3":{"ai_languageModel":[[{"node":"AI Analityc Log SIEM","type":"ai_languageModel","index":0}]]},"Aggregate Information":{"main":[[{"node":"HTML Template","type":"main","index":0}]]},"HTML Template":{"main":[[{"node":"Send Analysis","type":"main","index":0},{"node":"Mail Test","type":"main","index":0},{"node":"Code","type":"main","index":0}]]},"Send Analysis":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Microsoft Outlook":{"main":[[{"node":"Markdown","type":"main","index":0}]]},"New Email Trigger":{"main":[[{"node":"Microsoft Outlook","type":"main","index":0}]]},"Code":{"main":[[{"node":"Insert Event DB","type":"main","index":0}]]},"SerpAPI":{"ai_tool":[[{"node":"AI Analityc Log SIEM","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Txht1wrdLAI370JY"},"staticData":{"node:Microsoft Outlook Trigger":{"lastTimeChecked":"2025-05-24T11:05:10.059-05:00"},"node:New Email Trigger":{"lastTimeChecked":"2025-05-27T09:47:21.008-04:00"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"3db5a21c-fef9-4f63-bc26-981f6337d88a","triggerCount":1,"tags":[]}