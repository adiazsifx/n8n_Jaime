{"createdAt":"2025-05-12T23:54:44.645Z","updatedAt":"2025-05-24T15:28:05.000Z","id":"k5IVYZIjP1zZ4y5T","name":"Read Fortisiem Mails","active":false,"isArchived":true,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.toolSerpApi","typeVersion":1,"position":[260,720],"id":"396b989a-4075-4cec-9b41-4f4a0f88dc0b","name":"SerpAPI","credentials":{"serpApi":{"id":"MRuXkXXO6TX2gDPo","name":"SerpAPI JPG"}}},{"parameters":{"text":"={{ $json.data }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"customer\": \"TPA\",\n  \"mainTitle\": \"[New] TPADC03:Windows User Account Disabled (TPA)\",\n  \"incidentTitle\": \"Excessive Denied Connections from Philippines\",\n  \"incidentID\": \"85555\",\n  \"firstOccurrenceTime\": \"13 may 2025, 11:58:45 AM\",\n  \"lastOccurrenceTime\": \"13 may 2025, 11:08:30 AM\",\n  \"severity\": \"MEDIO (7)\",\n  \"severityType\":\"severity-medium\",\n  \"incidentCount\": \"1\",\n  \"incidentCategory\": \"Cambio/Persistencia\",\n  \"notificationPolicyID\": \"1707853\",\n  \"ruleName\": \"Windows User Account Disabled\",\n  \"ruleDescription\": \"Detecta que una cuenta de usuario de Windows fue deshabilitada en un servidor\",\n  \"sourceCountry\": \"Filipinas\",\n  \"hostName\": \"TPADC03\",\n  \"user\": \"administrator\",\n  \"targetUser\": \"mmendez\",\n  \"domain\": \"TPA\",\n  \"triggeredEventCount\": \"511\",\n  \"rawEvents\": \"N/A\"\n}","options":{"systemPromptTemplate":"ERES UN AGENTE EXTRACTOR DE DATOS AVANZADO, ENTRENADO PARA LEER CORREOS ELECTRÓNICOS Y ORGANIZAR SU CONTENIDO EN UNA ESTRUCTURA DE CLAVES Y VALORES ANIDADOS, TODO EN UNA SOLA LÍNEA. HAS SIDO OPTIMIZADO PARA FUNCIONAR CON LLAMA 3.3 70B Y DEBES RESPONDER DE FORMA FORMATEADA Y LIMPIA, SIN INTRODUCIR SALTOS DE LÍNEA, SANGRÍAS, COMENTARIOS NI MARCADORES.\n\n###INSTRUCCIONES###\n\n- ANALIZA TODO EL CONTENIDO DEL CORREO ELECTRÓNICO DETENIDAMENTE  \n- EXTRAE LA INFORMACIÓN CLAVE QUE CORRESPONDE A CADA CLAVE DE LA ESTRUCTURA QUE SE MUESTRA  \n- ORDENA LA INFORMACIÓN SEGÚN EL ESQUEMA DEFINIDO, RESPETANDO LA JERARQUÍA DE CLAVES Y SUBCLAVES  \n- TODOS LOS VALORES DEBEN ESTAR EN ESPAÑOL LATINOAMERICANO, SALVO LOS TÉRMINOS TÉCNICOS QUE DEBEN CONSERVARSE EN INGLÉS  \n- FORMATEA LAS FECHAS AL ESTILO \"30 abr 2025, 01:16:45 PM\"  \n- EXTRAE EL NOMBRE DEL CLIENTE DESDE EL `Subject`, BUSCANDO **EXCLUSIVAMENTE EL TEXTO QUE APARECE DENTRO DEL PARÉNTESIS FINAL**. POR EJEMPLO, SI EL SUBJECT ES: `[New] TPADC03:Windows User Account Disabled (TPA)`, EL NOMBRE DEL CLIENTE ES `\"TPA\"`, Y DEBE ASIGNARSE A LA CLAVE `\"customer\"`  \n- AGREGA UNA CLAVE ADICIONAL LLAMADA `\"severityType\"` BASADA EN EL TEXTO PRINCIPAL DE `\"Event Severity\"`, IGNORANDO NÚMEROS ENTRE PARÉNTESIS:  \n  - SI INCLUYE `\"LOW\"` → `\"severity-low\"`  \n  - SI INCLUYE `\"MEDIUM\"` → `\"severity-medium\"`  \n  - SI INCLUYE `\"HIGH\"` → `\"severity-high\"`  \n  - CUALQUIER OTRO VALOR → `\"severity-unknown\"`  \n- LA SALIDA DEBE SER ENTREGADA **COMPLETAMENTE EN UNA SOLA LÍNEA**, SIN SALTOS DE LÍNEA, NI RETORNOS, NI ESPACIOS INNECESARIOS ENTRE CLAVES  \n- SI ALGÚN DATO NO ESTÁ PRESENTE EN EL CORREO, DEBES ESCRIBIR EL VALOR `\"N/A\"` PARA ESA CLAVE  \n\n###CADENA DE RAZONAMIENTO###\n\n1. ENTENDER: INTERPRETA EL CORREO COMPLETO PARA COMPRENDER EL CONTEXTO DEL INCIDENTE  \n2. DETECTAR: UBICA TODAS LAS PIEZAS DE INFORMACIÓN NECESARIAS  \n3. ORGANIZAR: ALINEA CADA DATO EXTRAÍDO CON SU CLAVE CORRESPONDIENTE EN LA ESTRUCTURA  \n4. AJUSTAR: TRADUCE VALORES, NORMALIZA FORMATO DE FECHAS Y NOMBRES  \n5. EXTRAER CLIENTE: DETECTA EL `Subject`, BUSCA LOS PARÉNTESIS AL FINAL Y EXTRAE **EXACTAMENTE EL TEXTO ENTRE PARÉNTESIS** COMO VALOR DE `\"customer\"`  \n6. COMPLETAR VACÍOS: SI FALTA ALGÚN DATO, COLOCA `\"N/A\"` COMO VALOR  \n7. DERIVAR `severityType`: A PARTIR DEL TEXTO PRINCIPAL EN `\"Event Severity\"` (ANTES DE CUALQUIER PARÉNTESIS), GENERA EL VALOR CORRESPONDIENTE COMO SE INDICA  \n8. CONSTRUIR: GENERA UNA ESTRUCTURA ANIDADA CON TODA LA INFORMACIÓN EN UNA SOLA LÍNEA  \n9. VALIDAR: VERIFICA QUE NO HAYA SALTOS DE LÍNEA, COMENTARIOS NI CAMPOS VACÍOS  \n\n###PROHIBIDO###\n\n- NO USAR SALTOS DE LÍNEA (\\n), NI ESPACIOS INNECESARIOS  \n- NO USAR COMILLAS INVERTIDAS, NI ETIQUETAS DE CÓDIGO  \n- NO INCLUIR COMENTARIOS, EXPLICACIONES, NI TEXTO FUERA DE LA ESTRUCTURA  \n- NO INVENTAR CAMPOS, NI DUPLICAR CLAVES  \n- NO TRADUCIR TÉRMINOS TÉCNICOS COMO “Brute Force”, “Credential Access”, “Host Login”  \n- NO OMITIR CAMPOS; SI NO EXISTE UN DATO, USA \"N/A\"  \n- NO ELIMINAR NI MODIFICAR LA CLAVE `\"Event Severity\"` BAJO NINGUNA CIRCUNSTANCIA  \n- NO COPIAR TEXTUALMENTE EL VALOR COMPLETO DE `\"Event Severity\"` A `\"severityType\"` "}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[420,260],"id":"25d577ff-d470-4982-9c66-232a2e344e9b","name":"Extractor Mail Fields"},{"parameters":{"model":{"__rl":true,"value":"openai-nano","mode":"list","cachedResultName":"openai-nano"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[260,400],"id":"e40b5d55-9ccc-440b-8a17-1d0312058196","name":"AI Extract Fields","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"promptType":"define","text":"={{ $json.output.rawEvents }}","options":{"systemMessage":"ERES UN AGENTE DE CIBERSEGURIDAD DE NIVEL ÉLITE ESPECIALIZADO EN ANÁLISIS AUTOMÁTICO DE LOGS GENERADOS POR FORTISIEM. TU MISIÓN ES INTERPRETAR LOS “RAW EVENTS” DE CADA ALERTA Y PROPORCIONAR UNA RESPUESTA EXPERTA EN FORMATO HTML BÁSICO, CONTENIDA DENTRO DE UNA ETIQUETA `<div>`, QUE INCLUYA:\n\n1. LA EXPLICACIÓN DEL INCIDENTE DETECTADO  \n2. UNA RECOMENDACIÓN DE REMEDIACIÓN BASADA EN MEJORES PRÁCTICAS (NIST, MITRE ATT&CK, CIS, OWASP, ETC.). \n3. ENLACES RELEVANTES USANDO `<a href=\"...\">` PERO MOSTRANDO TAMBIÉN LA URL DE FORMA VISIBLE  \n4. SEPARACIÓN DE IDEAS CON `<br>` PARA MEJOR FORMATO EN HTML  \n5. TODO EN UN SOLO BLOQUE DENTRO DE `<div>`, SIN ESTILOS\n\n###INSTRUCCIONES###\n\n- TRABAJA EXCLUSIVAMENTE CON EL CAMPO “RAW EVENTS”\n- GENERA UNA RESPUESTA EN HTML, DENTRO DE UN `<div>`, USANDO SOLO `<br>`, `<a>`, `<code>` Y TEXTO PLANO\n- CADA LINK DEBE SER CLICKEABLE Y TAMBIÉN MOSTRAR VISUALMENTE LA URL (por ejemplo: **MITRE ATT&CK - https://attack.mitre.org/techniques/T1190/**)\n- LA RESPUESTA DEBE TENER FORMATO NATURAL DE PÁRRAFO, PERO SEPARADO CON `<br>` PARA HTML\n- NO USES `<p>`, `<ul>`, `<style>`, `<script>`, NI NINGUNA OTRA ETIQUETA\n\n###CADENA DE RAZONAMIENTO (CHAIN OF THOUGHTS)###\n\n1. **UNDERSTAND**: EXTRAER del “RAW EVENTS” todos los datos clave: origen, destino, tipo de ataque, herramienta, agente, URL, método\n2. **BASICS**: IDENTIFICAR el tipo de amenaza y cómo se cataloga (por ejemplo: técnica MITRE, CVE, firma IPS)\n3. **BREAK DOWN**: ANALIZAR roles del atacante y víctima, superficie atacada, tecnología afectada\n4. **ANALYZE**: EVALUAR la severidad, probabilidad de éxito, consecuencias si no se remedia\n5. **BUILD**: GENERAR una respuesta con acciones técnicas de remediación y prevención\n6. **EDGE CASES**: CONSIDERAR si el ataque puede variar o escalar según contexto\n7. **FINAL ANSWER**: FORMATEAR LA RESPUESTA EN UN SOLO `<div>`, USANDO `<br>` Y LINKS COMPLETOS Y VISIBLES\n\n###WHAT NOT TO DO###\n\n- **NUNCA OMITAS LOS LINKS EXPLÍCITOS Y VISIBLES**\n- **NUNCA USES ETIQUETAS HTML QUE NO SEAN `<div>`, `<br>`, `<a>`, O `<code>`**\n- **NO OMITAS LA RECOMENDACIÓN DE REMEDIACIÓN**\n- **NO SEPARES LA RESPUESTA EN VARIOS PÁRRAFOS FUERA DE UN SOLO `<div>`**\n- **NO OCULTES LA URL EN UN HIPERVÍNCULO; SIEMPRE MUESTRA EL LINK COMPLETO**\n\n###FEW-SHOT EXAMPLE (HTML CON LINK CLICKEABLE + URL VISIBLE)###\n\n**Input RAW EVENT:**\n`Raw Events: attack=\"Spring.Boot.Actuator.Unauthorized.Access\" srcip=206.189.233.36 dstip=10.250.2.227 url=\"/actuator/env\"`\n\n**Output esperado:**\n```html\n<div>\nSe detectó un intento de explotación desde la IP 206.189.233.36 contra el host 10.250.2.227 mediante un acceso no autorizado al endpoint <code>/actuator/env</code>, parte del framework Spring Boot Actuator.<br>\nEste endpoint fue expuesto sin autenticación, lo cual representa una mala práctica y permite al atacante acceder a configuraciones sensibles.<br>\nSe recomienda implementar Spring Security, cerrar el acceso público a endpoints Actuator y revisar las configuraciones: <code>management.endpoints.web.exposure.include=none</code><br>\nConsulta la guía oficial de seguridad de Actuator: Spring Boot Actuator Security - <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#securing-actuator-endpoints\">https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#securing-actuator-endpoints</a><br>\nTambién se relaciona con la técnica MITRE ATT&CK T1190 - Exploit Public-Facing Application - <a href=\"https://attack.mitre.org/techniques/T1190/\">https://attack.mitre.org/techniques/T1190/</a><br>\nGuías de buenas prácticas adicionales disponibles en Center for Internet Security - <a href=\"https://www.cisecurity.org/\">https://www.cisecurity.org/</a><br>\n</div>\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[420,480],"id":"189e4c73-8b00-4ea3-86d6-253112be493c","name":"AI Analityc Log SIEM"},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[260,560],"id":"0222517e-7c0a-47b8-853f-cba275a3428e","name":"Llama 3.3","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"toRecipients":"soc-cl@ifxcorp.com","subject":"=Analisis de Log: {{ $('Get Mail Event').item.json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[820,700],"id":"d32866ca-4a98-4ab6-a501-dbd6eeb22f51","name":"Send Analysis","webhookId":"ce28d2cc-ad0a-4d7a-9788-a4b794d38f20","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=Analisis de Log: {{ $('Get Mail Event').item.json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1380,480],"id":"e4ed39c3-941c-4825-82a7-579cb9fb6b56","name":"Mail Test","webhookId":"ce28d2cc-ad0a-4d7a-9788-a4b794d38f20","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook jaimep@ifxcorp.com"}},"disabled":true},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"=fortisiem_incidents","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"customer":"={{ $('Aggregate Information').item.json.data[0].output.customer }}","main_title":"={{ $('Aggregate Information').item.json.data[0].output.mainTitle }}","incident_title":"={{ $('Aggregate Information').item.json.data[0].output.incidentTitle }}","incident_id":"={{ $('Aggregate Information').item.json.data[0].output.incidentID }}","first_occurrence_time":"={{ DateTime.fromFormat($('Aggregate Information').item.json.data[0].output.firstOccurrenceTime, 'dd MMM yyyy, hh:mm:ss a').toFormat('yyyy-MM-dd HH:mm:ss') }}","last_occurrence_time":"={{ DateTime.fromFormat($('Aggregate Information').item.json.data[0].output.lastOccurrenceTime, 'dd MMM yyyy, hh:mm:ss a').toFormat('yyyy-MM-dd HH:mm:ss') }}","incident_count":"={{ $('Aggregate Information').item.json.data[0].output.incidentCount }}","notification_policy_id":"={{ $('Aggregate Information').item.json.data[0].output.notificationPolicyID }}","triggered_event_count":"={{ $('Aggregate Information').item.json.data[0].output.triggeredEventCount }}","severity":"={{ $('Aggregate Information').item.json.data[0].output.severity }}","severity_type":"={{ $('Aggregate Information').item.json.data[0].output.severityType }}","incident_category":"={{ $('Aggregate Information').item.json.data[0].output.incidentCategory }}","rule_name":"={{ $('Aggregate Information').item.json.data[0].output.ruleName }}","rule_description":"={{ $('Aggregate Information').item.json.data[0].output.ruleDescription }}","source_country":"={{ $('Aggregate Information').item.json.data[0].output.sourceCountry }}","host_name":"={{ $('Aggregate Information').item.json.data[0].output.hostName }}","user_account":"={{ $('Aggregate Information').item.json.data[0].output.user }}","target_user":"={{ $('Aggregate Information').item.json.data[0].output.targetUser }}","domain":"={{ $('Aggregate Information').item.json.data[0].output.domain }}","raw_events":"={{ $('Aggregate Information').item.json.data[0].output.rawEvents }}","analysis_output":"={{ $('Aggregate Information').item.json.data[1].output }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"tt_number","displayName":"tt_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"customer","displayName":"customer","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"main_title","displayName":"main_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_title","displayName":"incident_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_id","displayName":"incident_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"first_occurrence_time","displayName":"first_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"last_occurrence_time","displayName":"last_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"severity","displayName":"severity","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"severity_type","displayName":"severity_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_count","displayName":"incident_count","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"incident_category","displayName":"incident_category","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"notification_policy_id","displayName":"notification_policy_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"rule_name","displayName":"rule_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"rule_description","displayName":"rule_description","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"source_country","displayName":"source_country","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"host_name","displayName":"host_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"user_account","displayName":"user_account","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"target_user","displayName":"target_user","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"domain","displayName":"domain","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"triggered_event_count","displayName":"triggered_event_count","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true},{"id":"raw_events","displayName":"raw_events","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"analysis_output","displayName":"analysis_output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1380,280],"id":"9a894f89-2f90-4f23-8a68-8d66b1163b15","name":"Insert Event DB","credentials":{"postgres":{"id":"NfJHLM3V8jbiKzoD","name":"Postgres DB SOC"}}},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"output":"fields","fields":["body","conversationId","createdDateTime"],"filters":{"readStatus":"both","sender":"fortisiem@info.ifxnetworks.com"},"options":{}},"type":"n8n-nodes-base.microsoftOutlookTrigger","typeVersion":1,"position":[420,20],"id":"219ee7e9-16dd-4c64-926f-85897cffb1b5","name":"New Mai Event","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"resource":"folderMessage","folderId":{"__rl":true,"value":"AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAAAAEMAAA=","mode":"list","cachedResultName":"Bandeja de entrada","cachedResultUrl":"https://outlook.office365.com/mail/AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C%2FOf%2FSaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAAAAEMAAA%3D"},"returnAll":true,"output":"raw","filtersUI":{"values":{"filters":{"sender":"fortisiem@info.ifxnetworks.com"}}},"options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[640,20],"id":"1f82741a-2a53-4354-8825-f5b3ce60ced7","name":"Get Mail Event","webhookId":"9699a48d-730f-432d-bab7-41aa62812c70","alwaysOutputData":true,"credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"html":"={{ $json.body.content }}","options":{}},"type":"n8n-nodes-base.markdown","typeVersion":1,"position":[840,20],"id":"ce62021c-f6a4-4836-aa53-ce51712ce7d3","name":"Convert Markdown"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1020,20],"id":"8fab7836-2009-4720-afd3-d79b842b1d2c","name":"Loop Mails"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[820,260],"id":"92c69bcf-801d-4a81-ac02-bc4fa7c4b52c","name":"Merge Extract and Analysis"},{"parameters":{"assignments":{"assignments":[{"id":"05a1a813-ca14-4d73-813d-8cd5478f317a","name":"customer","value":"={{ $json.output.customer }}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1060,260],"id":"6345b472-134c-49c9-91fa-b89330f9783c","name":"Set Customer Name"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[820,480],"id":"773396c7-2566-4b22-b7fa-b8d5c6cc0a84","name":"Aggregate Information"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Ciberseguridad</title>\n  <style>\n    /* Estilos generales - compatibles con clientes de correo */\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      margin: 0;\n      padding: 0;\n      background-color: #f8f9fa;\n      color: #333;\n      line-height: 1.6;\n    }\n\n    .container {\n      max-width: 650px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #ffffff;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n    }\n\n    .header-img {\n      width: 100%;\n      height: auto;\n      display: block;\n      margin-bottom: 15px;\n      border-radius: 6px 6px 0 0;\n    }\n\n    .header {\n      background: #2980b9;\n      color: white;\n      padding: 15px;\n      text-align: center;\n      border-radius: 6px;\n      margin-bottom: 20px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n    }\n\n    .alert-icon {\n      font-size: 22px;\n      margin-right: 10px;\n      vertical-align: middle;\n    }\n\n    h1 {\n      margin: 0;\n      padding: 0;\n      font-size: 20px;\n      color: white;\n      letter-spacing: 0.5px;\n    }\n\n    h2 {\n      color: #2874a6;\n      font-size: 18px;\n      margin-top: 0;\n      border-bottom: 2px solid #2874a6;\n      padding-bottom: 8px;\n      letter-spacing: 0.3px;\n    }\n\n    .incident-summary {\n      background-color: #f1f8fe;\n      padding: 15px;\n      border-left: 5px solid #3498db;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .severity-low {\n      display: inline-block;\n      background-color: #FEEA00;\n      color: black;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-medium {\n      display: inline-block;\n      background-color: #f39c12;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-high {\n      display: inline-block;\n      background-color: #e4011a;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .highlight {\n      color: #2874a6;\n      font-weight: bold;\n    }\n\n    .priority-item {\n      border-left: 3px solid #e74c3c;\n      padding-left: 10px;\n      font-weight: 600;\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 20px;\n      border-radius: 6px;\n      overflow: hidden;\n      box-shadow: 0 2px 3px rgba(0,0,0,0.05);\n    }\n\n    table, th, td {\n      border: 1px solid #e0e0e0;\n    }\n\n    th {\n      background-color: #eaf2f8;\n      text-align: left;\n      padding: 12px;\n      width: 40%;\n      color: #2874a6;\n      font-weight: 600;\n    }\n\n    td {\n      padding: 12px;\n      word-break: break-word;\n      background-color: #ffffff;\n    }\n\n    tr:hover td {\n      background-color: #f9f9f9;\n    }\n\n    .section {\n      margin-bottom: 25px;\n    }\n\n    .remediation {\n      background-color: #e8f4fc;\n      border-left: 5px solid #3498db;\n      padding: 15px;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .remediation h2 {\n      color: #2874a6;\n      border-bottom-color: #3498db;\n    }\n\n    .remediation-content {\n      font-weight: 500;\n    }\n\n    .footer {\n      font-size: 12px;\n      color: #777;\n      text-align: center;\n      margin-top: 20px;\n      padding-top: 15px;\n      border-top: 1px solid #eee;\n    }\n\n    .footer-img {\n      width: 100%;\n      max-width: 650px;\n      height: auto;\n      display: block;\n      margin: 10px auto;\n      border-radius: 0 0 6px 6px;\n    }\n\n    .signature {\n      font-size: 6px;\n      font-family: sans-serif;\n      text-align: right;\n      margin-right: 4px;\n      color: #999;\n      margin-bottom: 5px;\n    }\n\n    .signature span {\n      font-style: italic;\n      color: #9c27b0;\n      font-weight: bold;\n      font-family: serif;\n      font-size: 9px;\n    }\n\n    /* Estilos responsivos */\n    @media screen and (max-width: 600px) {\n      .container {\n        width: 100%;\n        padding: 10px;\n      }\n\n      th, td {\n        display: block;\n        width: auto;\n      }\n\n      th {\n        border-bottom: none;\n      }\n\n      td {\n        border-top: none;\n      }\n    }\n  </style>\n</head>\n\n<body>\n  <div class=\"container\">\n    <img class=\"header-img\"\n      src=\"https://github.com/ifxnetworks/Dise-o/blob/main/Header_Comunicado_Cyberseguridad_IFX_CL_(2.0).png?raw=true\"\n      alt=\"Encabezado de Ciberseguridad\">\n    <div class=\"signature\">Generated by <span>aifx</span></div>\n    <div class=\"header\">\n      <span class=\"alert-icon\">⚠️</span>\n      <h1 id=\"mainTitle\">{{ $('Microsoft Outlook').item.json.subject }}</h1>\n    </div>\n\n    <div class=\"incident-summary\">\n      <h2 id=\"incidentTitle\">{{ $json.data[0].output.incidentTitle }}</h2>\n      <p><strong>Cliente:</strong> <span style=\"text-transform: uppercase\" id=\"customer\">{{ $json.data[0].output.customer }}</span></p>\n      <p><strong>ID del Incidente:</strong> <span id=\"incidentID\">{{ $json.data[0].output.incidentID }}</span></p>\n      <p><strong>Severidad:</strong> <span id=\"severity\" class=\"{{ $json.data[0].output.severityType }}\">{{ $json.data[0].output.severity }}</span></p>\n    </div>\n    <div class=\"section\">\n      <h2>Detalles del Incidente</h2>\n      <table>\n        <tr>\n          <th>Primera Ocurrencia</th>\n          <td id=\"firstOccurrenceTime\">{{ $json.data[0].output.firstOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Última Ocurrencia</th>\n          <td id=\"lastOccurrenceTime\">{{ $json.data[0].output.lastOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Categoría</th>\n          <td id=\"incidentCategory\">{{ $json.data[0].output.incidentCategory }}</td>\n        </tr>\n        <tr>\n          <th>Conteo de Incidentes</th>\n          <td id=\"incidentCount\">{{ $json.data[0].output.incidentCount }}</td>\n        </tr>\n        <tr>\n          <th>ID de Política de Notificación</th>\n          <td id=\"notificationPolicyID\">{{ $json.data[0].output.notificationPolicyID }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Información de la Regla</h2>\n      <table>\n        <tr>\n          <th>Nombre de la Regla</th>\n          <td id=\"ruleName\" class=\"priority-item\">{{ $json.data[0].output.ruleName }}</td>\n        </tr>\n        <tr>\n          <th>Descripción de la Regla</th>\n          <td id=\"ruleDescription\">{{ $json.data[0].output.ruleDescription }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Detalles del Sistema</h2>\n      <table>\n        <tr>\n          <th>Nombre del Host</th>\n          <td id=\"hostName\">{{ $json.data[0].output.hostName }}</td>\n        </tr>\n        <tr>\n          <th>Usuario</th>\n          <td id=\"user\">{{ $json.data[0].output.user }}</td>\n        </tr>\n        <tr>\n          <th>Usuario Objetivo</th>\n          <td id=\"targetUser\" class=\"priority-item\">{{ $json.data[0].output.targetUser }}</td>\n        </tr>\n        <tr>\n          <th>Dominio</th>\n          <td id=\"domain\">{{ $json.data[0].output.domain }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"remediation\">\n      <h2>Remediación Recomendada</h2>\n      <p id=\"remediation\" class=\"remediation-content priority-item\">{{ $json.data[1].output }}</p>\n    </div>\n\n    <div class=\"footer\">\n      <img class=\"footer-img\" src=\"https://raw.githubusercontent.com/ifxnetworks/Ansible/refs/heads/main/Imagen1nnlnl.jpg\" \n     alt=\"Pie de página\" style=\"width: 100%; height: auto;\">\n      <p>Este es un mensaje automatizado de alerta de seguridad. Por favor, no responda a este correo.</p>\n      <p>Para obtener soporte contacte con <a href=\"mailto:soc-cl@ifxcorp.com\" style=\"color: #3498db;\">soc-cl@ifxcorp.com</a></p>\n    </div>\n  </div>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1040,480],"id":"b1f0ba2a-1331-4128-a8d8-02b7bf5b2ae9","name":"HTML Mail"},{"parameters":{"operation":"move","messageId":{"__rl":true,"value":"={{ $('Get Mail Event').item.json.id }}","mode":"id"},"folderId":{"__rl":true,"value":"AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA=","mode":"list","cachedResultName":"Fortisiem Ready","cachedResultUrl":"https://outlook.office365.com/mail/AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C%2FOf%2FSaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA%3D"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1040,700],"id":"afb8415f-7f4f-41c2-a263-def43db37fdb","name":"Move Ready Mail","webhookId":"d8aa6d72-ad3c-4ab1-b89d-256b5e7bab62","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}}],"connections":{"SerpAPI":{"ai_tool":[[{"node":"AI Analityc Log SIEM","type":"ai_tool","index":0}]]},"Extractor Mail Fields":{"main":[[{"node":"Merge Extract and Analysis","type":"main","index":0},{"node":"AI Analityc Log SIEM","type":"main","index":0}]]},"AI Extract Fields":{"ai_languageModel":[[{"node":"Extractor Mail Fields","type":"ai_languageModel","index":0}]]},"AI Analityc Log SIEM":{"main":[[{"node":"Merge Extract and Analysis","type":"main","index":1}]]},"Llama 3.3":{"ai_languageModel":[[{"node":"AI Analityc Log SIEM","type":"ai_languageModel","index":0}]]},"Send Analysis":{"main":[[{"node":"Move Ready Mail","type":"main","index":0}]]},"Mail Test":{"main":[[]]},"New Mai Event":{"main":[[{"node":"Get Mail Event","type":"main","index":0}]]},"Get Mail Event":{"main":[[{"node":"Convert Markdown","type":"main","index":0}]]},"Convert Markdown":{"main":[[{"node":"Loop Mails","type":"main","index":0}]]},"Loop Mails":{"main":[[],[{"node":"Extractor Mail Fields","type":"main","index":0}]]},"Merge Extract and Analysis":{"main":[[{"node":"Set Customer Name","type":"main","index":0}]]},"Set Customer Name":{"main":[[{"node":"Aggregate Information","type":"main","index":0}]]},"Aggregate Information":{"main":[[{"node":"HTML Mail","type":"main","index":0}]]},"HTML Mail":{"main":[[{"node":"Mail Test","type":"main","index":0},{"node":"Insert Event DB","type":"main","index":0},{"node":"Send Analysis","type":"main","index":0}]]},"Move Ready Mail":{"main":[[{"node":"Loop Mails","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Txht1wrdLAI370JY"},"staticData":{"node:Microsoft Outlook Trigger":{"lastTimeChecked":"2025-05-24T10:14:52.071-05:00"},"node:New Mai Event":{"lastTimeChecked":"2025-05-24T11:19:04.273-04:00"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d7d31249-ac11-4746-81d2-1db13cf9518e","triggerCount":1,"tags":[]}