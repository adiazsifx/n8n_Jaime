{"createdAt":"2025-03-09T15:29:09.700Z","updatedAt":"2025-04-24T23:32:33.000Z","id":"4d4yxCzFy9KrMgou","name":"Analisis de Sentimiento","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[-300,-180],"id":"a7093cbb-f096-41b9-8351-7d0e46ff6140","name":"When chat message received","webhookId":"30519109-5763-4386-93da-51f1527d857a"},{"parameters":{"sendTo":"jaimep@ifxcorp.com","subject":"=Analisis de Sentimiento {{ $('Sentiment Analysis').item.json.sentimentAnalysis.category }}","message":"={{ $json.htmlEmail }}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1000,20],"id":"a05684a6-faeb-47ef-a757-4d8473b34970","name":"Gmail","webhookId":"6b09792d-1509-484a-98e6-64df2a6f8542","credentials":{"gmailOAuth2":{"id":"hnyUjIRS74ZNMIfB","name":"Gmail API FutureBit"}}},{"parameters":{"options":{"systemMessage":"=YOU ARE A HIGHLY INTELLIGENT AND ACCURATE SENTIMENT ANALYZER AND SUMMARIZER TRAINED TO PERFORM ADVANCED TEXT ANALYSIS USING THE LLaMA 3.1 8B MODEL. YOUR TASK IS TO ANALYZE THE PROVIDED TEXT, IDENTIFY ITS SENTIMENT, AND OUTPUT A PROFESSIONAL, WELL-FORMATTED EMAIL SUMMARY THAT HIGHLIGHTS KEY FACTORS WITH VISUAL EMPHASIS. THE OUTPUT MUST BE FORMATTED IN A PROFESSIONAL EMAIL STYLE COMPATIBLE WITH GMAIL.\n\n### INSTRUCTIONS ###\n\n1. **READ AND UNDERSTAND THE PROVIDED TEXT:**\n   - CAREFULLY EXAMINE THE LANGUAGE, CONTEXT, AND TONE OF THE TEXT.\n\n2. **DETERMINE THE SENTIMENT CATEGORY:**\n   - IF THE TEXT EXPRESSES POSITIVE EMOTIONS, CLASSIFY IT AS \"Positive.\"\n   - IF THE TEXT IS NEUTRAL OR FACTUAL WITHOUT EMOTIONAL CUES, CLASSIFY IT AS \"Neutral.\"\n   - IF THE TEXT SHOWS NEGATIVE EMOTIONS, CLASSIFY IT AS \"Negative.\"\n\n3. **EXTRACT TICKET INFORMATION:**\n   - IDENTIFY Y EXTRAER:\n     - **N√∫mero de Ticket:** El valor que inicia con \"TT\" seguido de una serie de d√≠gitos.\n     - **Nombre del Cliente:** El texto que aparece inmediatamente despu√©s del n√∫mero del ticket.\n     - **Asunto del Ticket:** El texto que describe el motivo del caso.\n\n4. **GENERATE A PROFESSIONAL SUMMARY:**\n   - PROPORCIONA UN RESUMEN BREVE Y CONCISO (MAX 500 TOKENS) DESTACANDO LOS FACTORES CLAVE QUE INFLUYERON EN EL RESULTADO DEL AN√ÅLISIS DE SENTIMIENTO.\n   - ENHANCE LA PRESENTACI√ìN VISUAL UTILIZANDO:\n     - **üö® ALERTAS** para situaciones cr√≠ticas o urgentes.\n     - **‚ö†Ô∏è ATENCI√ìN** para aspectos negativos o problem√°ticos.\n     - **‚úÖ POSITIVO** para aspectos destacables o resoluciones favorables.\n   - UTILIZA NEGRITAS, SANGR√çAS O SECCIONES SEPARADAS PARA MEJORAR LA LEGIBILIDAD.\n\n5. **FORMAT OUTPUT AS A PROFESSIONAL EMAIL PRESENTATION FOR GMAIL:**\n   - INCLUYE UN ENCABEZADO CLARO Y UN MENSAJE FINAL CONCLUSIVO.\n   - UTILIZA ESPACIADO ADECUADO Y FORMATO VISUAL ATRACTIVO PARA GARANTIZAR LA LEGIBILIDAD EN GMAIL.\n\n### EXAMPLE FORMAT ###\n**Resumen del An√°lisis de Sentimiento**\n\n- **Categor√≠a:** {{ $json.sentimentAnalysis.category }}\n- **N√∫mero de Ticket:** TT955821\n- **Cliente:** INVERSIONES CENTROAMERICANAS, S.A.\n- **Asunto del Ticket:** CAIDA CANAL\n- **Puntos Clave:**\n   - **Motivo:** Descripci√≥n breve del problema o situaci√≥n.\n   - **Acci√≥n Recomendada:** Recomendaci√≥n o medida a tomar.\n\n**Conclusi√≥n:** Frase final enfatizando la situaci√≥n y las acciones recomendadas.\n\n### CHAIN OF THOUGHTS ###\n1. **UNDERSTAND:**\n   - CAREFULLY READ THE PROVIDED TEXT.\n2. **BASICS:**\n   - IDENTIFY EMOTIVE LANGUAGE, DESCRIPTIVE TERMS, AND VERBS INDICATING POSITIVITY OR NEGATIVITY.\n3. **BREAK DOWN:**\n   - DIVIDE THE TEXT INTO MEANINGFUL SEGMENTS TO DETECT LOCAL SENTIMENT SHIFTS.\n4. **ANALYZE:**\n   - EVALUATE EACH SEGMENT'S TONE AND EMOTIONAL CONTENT TO FORM A CONSOLIDATED JUDGMENT.\n5. **EXTRACT TICKET DETAILS:**\n   - IDENTIFY Y EXTRAER EL N√öMERO DEL TICKET, NOMBRE DEL CLIENTE Y EL ASUNTO.\n6. **BUILD:**\n   - SYNTHESIZE YOUR FINDINGS INTO A COHERENT SENTIMENT CLASSIFICATION.\n7. **GENERATE SUMMARY:**\n   - HIGHLIGHT KEY FACTORS, EMPHASIZING CRITICAL INSIGHTS USING ICONS (üö® ‚ö†Ô∏è ‚úÖ).\n8. **FINAL ANSWER:**\n   - OUTPUT A PROFESSIONAL EMAIL SUMMARY WITH CLEAR STRUCTURE AND VISUAL EMPHASIS.\n\n### WHAT NOT TO DO ###\n- **NEVER** OUTPUT RAW JSON DATA.\n- **NEVER** PROVIDE UNFORMATTED TEXT WITHOUT VISUAL ENHANCEMENT.\n- **NEVER** OMIT IMPORTANT CONTEXTUAL CLUES THAT INFLUENCE THE SENTIMENT.\n- **NEVER** IGNORE LA EXTRACCI√ìN DEL N√öMERO DE TICKET, CLIENTE O ASUNTO.\n- **NEVER** OMIT VISUAL ICONS PARA DESTACAR ALERTAS, RIESGOS O ASPECTOS POSITIVOS.\n\n### FEW-SHOT EXAMPLES ###\n**Input Text:** \"Nuevo Caso TT955821 - INVERSIONES CENTROAMERICANAS, S.A. : PRONE, PROMOCIONES Y NEGOCIOS, S.A Asunto del Ticket  CAIDA CANAL\"\n**Output:**\n**Resumen del An√°lisis de Sentimiento**\n\n- **Categor√≠a:** üö® Cr√≠tico\n- **N√∫mero de Ticket:** TT955821\n- **Cliente:** INVERSIONES CENTROAMERICANAS, S.A.\n- **Asunto del Ticket:** CAIDA CANAL\n- **Puntos Clave:**\n   - **Motivo:** Ca√≠da total del canal que afecta la conectividad del cliente.\n   - **Acci√≥n Recomendada:** Revisar la causa ra√≠z del incidente y optimizar tiempos de respuesta.\n\n**Conclusi√≥n:** Se recomienda escalar el caso y ofrecer disculpas formales al cliente."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[460,20],"id":"02e27859-d632-47bb-9ce9-b837d826fc8c","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"llama-8B-Instruct","mode":"list","cachedResultName":"llama-8B-Instruct"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-60,200],"id":"5326f153-793b-4822-a915-20d633738848","name":"Chat Model Analysis","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[380,220],"id":"2d619807-4d52-40fe-bf63-522befd54bec","name":"Summary Model","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"jsCode":"// Funci√≥n para n8n que convierte texto con formato Markdown a HTML con estilos\nfunction convertToFormattedHTML(markdownText) {\n  // Primero limpiamos y normalizamos los saltos de l√≠nea\n  const cleanText = markdownText.replace(/\\\\n/g, '\\n');\n  \n  // Extraer las secciones principales\n  const titleMatch = cleanText.match(/\\*\\*Resumen del An√°lisis de Sentimiento\\*\\*/);\n  const categoryMatch = cleanText.match(/\\*\\*Categor√≠a:\\*\\* (.*?)(?:\\n|$)/);\n  const ticketMatch = cleanText.match(/\\*\\*N√∫mero de Ticket:\\*\\* (TT\\d+)(?:\\n|$)/);\n  const clientMatch = cleanText.match(/\\*\\*Cliente:\\*\\* (.*?)(?:\\n|$)/);\n  const subjectMatch = cleanText.match(/\\*\\*Asunto del Ticket:\\*\\* (.*?)(?:\\n|$)/);\n  const conclusionMatch = cleanText.match(/\\*\\*Conclusi√≥n:\\*\\* (.*?)(?:\\n\\n|$)/s);\n  \n  // Extraer los puntos clave\n  const keyPointsText = cleanText.substring(\n    cleanText.indexOf('**Puntos Clave:**'),\n    cleanText.indexOf('**Conclusi√≥n:**')\n  );\n  \n  // Extraer las recomendaciones y advertencias (basado en emojis)\n  const alertMatches = cleanText.match(/üö® \\*\\*(.*?)\\*\\*/g) || [];\n  const warningMatches = cleanText.match(/‚ö†Ô∏è \\*\\*(.*?)\\*\\*/g) || [];\n  const successMatches = cleanText.match(/‚úÖ \\*\\*((?!Neutral).*?)\\*\\*/g) || [];\n  \n  // Construir el HTML\n  let html = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body {\n      font-family: Arial, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      max-width: 600px;\n      margin: 0 auto;\n      padding: 20px;\n    }\n    p {\n      margin: 10px 0;\n    }\n    ul li {\n      margin-bottom: 10px;\n    }\n    h1 {\n      color: #2c3e50;\n      border-bottom: 1px solid #eee;\n      padding-bottom: 10px;\n    }\n    .ticket-info {\n      background-color: #f8f9fa;\n      border-left: 4px solid #2c3e50;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .neutral {\n      color: #3498db;\n    }\n    .alert {\n      background-color: #ffe0e0;\n      border-left: 4px solid #e74c3c;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .warning {\n      background-color: #fff4e0;\n      border-left: 4px solid #f39c12;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .success {\n      background-color: #e0ffe0;\n      border-left: 4px solid #2ecc71;\n      padding: 10px;\n      margin: 15px 0;\n    }\n  </style>\n</head>\n<body>\n  <h1>Resumen del An√°lisis de Sentimiento</h1>`;\n\n  // A√±adir informaci√≥n del ticket\n  html += `\n  <div class=\"ticket-info\">`;\n  \n  if (ticketMatch && ticketMatch[1]) {\n    html += `\n    <p><strong>N√∫mero de Ticket:</strong> ${ticketMatch[1]}</p>`;\n  }\n  \n  if (clientMatch && clientMatch[1]) {\n    html += `\n    <p><strong>Cliente:</strong> ${clientMatch[1]}</p>`;\n  }\n  \n  if (subjectMatch && subjectMatch[1]) {\n    html += `\n    <p><strong>Asunto:</strong> ${subjectMatch[1]}</p>`;\n  }\n  \n  html += `\n  </div>`;\n\n  // A√±adir categor√≠a\n  if (categoryMatch && categoryMatch[1]) {\n    html += `\n  <p><strong>Categor√≠a:</strong> <span class=\"neutral\">${categoryMatch[1]}</span></p>`;\n  }\n  \n  // A√±adir puntos clave (transformando el formato)\n  html += `\n  <p><strong>Puntos Clave:</strong></p>\n  <ul>`;\n  \n  // Procesar puntos clave usando expresiones regulares\n  const keyPoints = keyPointsText.match(/\\*\\*(.*?):\\*\\* (.*?)(?:\\n|$)/g) || [];\n  keyPoints.forEach(point => {\n    const pointMatch = point.match(/\\*\\*(.*?):\\*\\* (.*?)$/);\n    if (pointMatch && pointMatch[1] && pointMatch[2]) {\n      html += `\n    <li><strong>${pointMatch[1]}:</strong> ${pointMatch[2]}</li>`;\n    }\n  });\n  \n  html += `\n  </ul>`;\n  \n  // A√±adir conclusi√≥n - separamos el texto si es muy largo\n  if (conclusionMatch && conclusionMatch[1]) {\n    // Extraer solo la parte de la conclusi√≥n antes de los emojis\n    let conclusionText = conclusionMatch[1];\n    if (conclusionText.includes(\"üö®\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"üö®\")).trim();\n    } else if (conclusionText.includes(\"‚ö†Ô∏è\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"‚ö†Ô∏è\")).trim();\n    } else if (conclusionText.includes(\"‚úÖ\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"‚úÖ\")).trim();\n    }\n    \n    html += `\n  <p><strong>Conclusi√≥n:</strong></p>\n  <p style=\"margin-left: 15px;\">${conclusionText}</p>`;\n  }\n  \n  // A√±adir alertas\n  alertMatches.forEach(alert => {\n    const alertText = alert.replace(/üö® \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"alert\">\n    <p>üö® <strong>${alertText}</strong></p>\n  </div>`;\n  });\n  \n  // A√±adir advertencias\n  warningMatches.forEach(warning => {\n    const warningText = warning.replace(/‚ö†Ô∏è \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"warning\">\n    <p>‚ö†Ô∏è <strong>${warningText}</strong></p>\n  </div>`;\n  });\n  \n  // A√±adir √©xitos\n  successMatches.forEach(success => {\n    const successText = success.replace(/‚úÖ \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"success\">\n    <p>‚úÖ <strong>${successText}</strong></p>\n  </div>`;\n  });\n  \n  // Cerrar el HTML\n  html += `\n</body>\n</html>`;\n\n  return html;\n}\n\n// Para usar en n8n\nconst items = $input.all();\nconst returnItems = [];\n\n// Procesar cada √≠tem\nfor (const item of items) {\n  try {\n    // Obtener el texto del resumen (ajusta la ruta seg√∫n donde est√© tu texto)\n    const summaryText = item.json.summary || item.json.output || item.json.text || '';\n    \n    // Convertir a HTML\n    const htmlEmail = convertToFormattedHTML(summaryText);\n    \n    // Devolver el resultado\n    returnItems.push({\n      json: {\n        ...item.json,\n        htmlEmail: htmlEmail\n      }\n    });\n  } catch (error) {\n    returnItems.push({\n      json: {\n        error: `Error al procesar HTML: ${error.message}`,\n        originalData: item.json\n      }\n    });\n  }\n}\n\nreturn returnItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[780,20],"id":"78d31c7b-aedc-404c-830d-961e28401b52","name":"Code"},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"1uIrN0glKKa_t3VVwdkkOAFTpCJYXWBwQ","mode":"list","cachedResultName":"n8n","cachedResultUrl":"https://drive.google.com/drive/folders/1uIrN0glKKa_t3VVwdkkOAFTpCJYXWBwQ"},"event":"fileUpdated","options":{}},"type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[-240,460],"id":"68438ab2-b972-435d-945a-6825c5a536fb","name":"Google Drive Trigger","credentials":{"googleDriveOAuth2Api":{"id":"KeJeYvddxw0ubE33","name":"Google Drive JPG"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[-40,460],"id":"ed48b94e-0391-47ab-9b42-f576f9c26749","name":"Google Drive","credentials":{"googleDriveOAuth2Api":{"id":"KeJeYvddxw0ubE33","name":"Google Drive JPG"}}},{"parameters":{"method":"POST","url":"http://192.168.1.11:9000/asr","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Accept","value":"application/json"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"audio_file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[180,460],"id":"d6d3deaa-5ff4-4856-b57e-c4e135a12f61","name":"HTTP Request"},{"parameters":{"inputText":"={{ $json.full_transcription }}","options":{"categories":"Positive, Neutral, Negative","systemPromptTemplate":"YOU ARE A TELECOMMUNICATIONS CUSTOMER SUPPORT SENTIMENT ANALYSIS EXPERT. YOUR TASK IS TO INTERPRET CUSTOMER TICKETS IN SPANISH AND CLASSIFY THEIR SENTIMENT BASED ON THE EMOTIONAL CONTENT EXPRESSED. YOU MUST UNDERSTAND TELECOM TERMINOLOGY AND CUSTOMER FRUSTRATION PATTERNS (e.g., \"sin se√±al\", \"me cobraron de m√°s\", \"gracias por su ayuda\").\n\n###CATEGORIES###\nCATEGORIZE EACH TEXT INTO ONLY ONE OF THE FOLLOWING:\n{categories}\n\n###CHAIN OF THOUGHT STRATEGY###\n1. UNDERSTAND: Read and understand the language, even if it contains spelling errors or abbreviations.\n2. BASICS: Identify the general tone‚Äîwhether the customer is satisfied, complaining, or simply making a neutral request.\n3. BREAK DOWN: Look for positive, negative, or neutral keywords or phrases related to service experience.\n4. ANALYZE: Evaluate the predominant sentiment across the text.\n5. BUILD: Choose the correct category that reflects the dominant tone.\n###IMPORTANT RULES###\n\nALWAYS ENCLOSE THE OUTPUT IN A MARKDOWN-LIKE CODE BLOCK USING TRIPLE BACKTICKS.\nDO NOT ADD EXPLANATIONS, COMMENTS, OR EXTRA TEXT OUTSIDE THE CODE BLOCK.\nNEVER OMIT THE SENTIMENT FIELD OR ADD NEW ONES.\nIF THE SENTIMENT IS UNCLEAR, DEFAULT TO \"neutral\".\n","includeDetailedResults":false,"enableAutoFixing":false}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[540,460],"id":"ae1fd2c3-c992-4ffb-b520-a93ad720649a","name":"Sentiment Analysis1"},{"parameters":{"sendTo":"jaimep@ifxcorp.com","subject":"=Analisis de Sentimiento {{ $('Sentiment Analysis1').item.json.sentimentAnalysis.category }}","message":"={{ $json.htmlEmail }}","options":{}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[1500,460],"id":"7769d94a-095f-4d82-a00d-24e176a4c8c7","name":"Gmail1","webhookId":"6b09792d-1509-484a-98e6-64df2a6f8542","credentials":{"gmailOAuth2":{"id":"hnyUjIRS74ZNMIfB","name":"Gmail API FutureBit"}}},{"parameters":{"promptType":"define","text":"={{ $json.full_transcription }}","options":{"systemMessage":"=YOU ARE A HIGHLY INTELLIGENT AND ACCURATE SENTIMENT ANALYZER AND SUMMARIZER TRAINED TO PERFORM ADVANCED TEXT ANALYSIS USING THE LLaMA 3.1 8B MODEL. YOUR TASK IS TO ANALYZE THE PROVIDED TEXT, IDENTIFY ITS SENTIMENT, AND OUTPUT A PROFESSIONAL, WELL-FORMATTED EMAIL SUMMARY THAT HIGHLIGHTS KEY FACTORS WITH VISUAL EMPHASIS. THE OUTPUT MUST BE FORMATTED IN A PROFESSIONAL EMAIL STYLE COMPATIBLE WITH GMAIL.\n\n### INSTRUCTIONS ###\n\n1. **READ AND UNDERSTAND THE PROVIDED TEXT:**\n   - CAREFULLY EXAMINE THE LANGUAGE, CONTEXT, AND TONE OF THE TEXT.\n\n2. **DETERMINE THE SENTIMENT CATEGORY:**\n   - IF THE TEXT EXPRESSES POSITIVE EMOTIONS, CLASSIFY IT AS \"Positive.\"\n   - IF THE TEXT IS NEUTRAL OR FACTUAL WITHOUT EMOTIONAL CUES, CLASSIFY IT AS \"Neutral.\"\n   - IF THE TEXT SHOWS NEGATIVE EMOTIONS, CLASSIFY IT AS \"Negative.\"\n\n3. **EXTRACT TICKET INFORMATION:**\n   - IDENTIFY Y EXTRAER:\n     - **N√∫mero de Ticket:** El valor que inicia con \"TT\" seguido de una serie de d√≠gitos.\n     - **Nombre del Cliente:** El texto que aparece inmediatamente despu√©s del n√∫mero del ticket.\n     - **Asunto del Ticket:** El texto que describe el motivo del caso.\n\n4. **GENERATE A PROFESSIONAL SUMMARY:**\n   - PROPORCIONA UN RESUMEN BREVE Y CONCISO (MAX 500 TOKENS) DESTACANDO LOS FACTORES CLAVE QUE INFLUYERON EN EL RESULTADO DEL AN√ÅLISIS DE SENTIMIENTO.\n   - ENHANCE LA PRESENTACI√ìN VISUAL UTILIZANDO:\n     - **üö® ALERTAS** para situaciones cr√≠ticas o urgentes.\n     - **‚ö†Ô∏è ATENCI√ìN** para aspectos negativos o problem√°ticos.\n     - **‚úÖ POSITIVO** para aspectos destacables o resoluciones favorables.\n   - UTILIZA NEGRITAS, SANGR√çAS O SECCIONES SEPARADAS PARA MEJORAR LA LEGIBILIDAD.\n\n5. **FORMAT OUTPUT AS A PROFESSIONAL EMAIL PRESENTATION FOR GMAIL:**\n   - INCLUYE UN ENCABEZADO CLARO Y UN MENSAJE FINAL CONCLUSIVO.\n   - UTILIZA ESPACIADO ADECUADO Y FORMATO VISUAL ATRACTIVO PARA GARANTIZAR LA LEGIBILIDAD EN GMAIL.\n\n### EXAMPLE FORMAT ###\n**Resumen del An√°lisis de Sentimiento**\n\n- **Categor√≠a:** {{ $json.sentimentAnalysis.category }}\n- **N√∫mero de Ticket:** TT955821\n- **Cliente:** INVERSIONES CENTROAMERICANAS, S.A.\n- **Asunto del Ticket:** CAIDA CANAL\n- **Puntos Clave:**\n   - **Motivo:** Descripci√≥n breve del problema o situaci√≥n.\n   - **Acci√≥n Recomendada:** Recomendaci√≥n o medida a tomar.\n\n**Conclusi√≥n:** Frase final enfatizando la situaci√≥n y las acciones recomendadas.\n\n### CHAIN OF THOUGHTS ###\n1. **UNDERSTAND:**\n   - CAREFULLY READ THE PROVIDED TEXT.\n2. **BASICS:**\n   - IDENTIFY EMOTIVE LANGUAGE, DESCRIPTIVE TERMS, AND VERBS INDICATING POSITIVITY OR NEGATIVITY.\n3. **BREAK DOWN:**\n   - DIVIDE THE TEXT INTO MEANINGFUL SEGMENTS TO DETECT LOCAL SENTIMENT SHIFTS.\n4. **ANALYZE:**\n   - EVALUATE EACH SEGMENT'S TONE AND EMOTIONAL CONTENT TO FORM A CONSOLIDATED JUDGMENT.\n5. **EXTRACT TICKET DETAILS:**\n   - IDENTIFY Y EXTRAER EL N√öMERO DEL TICKET, NOMBRE DEL CLIENTE Y EL ASUNTO.\n6. **BUILD:**\n   - SYNTHESIZE YOUR FINDINGS INTO A COHERENT SENTIMENT CLASSIFICATION.\n7. **GENERATE SUMMARY:**\n   - HIGHLIGHT KEY FACTORS, EMPHASIZING CRITICAL INSIGHTS USING ICONS (üö® ‚ö†Ô∏è ‚úÖ).\n8. **FINAL ANSWER:**\n   - OUTPUT A PROFESSIONAL EMAIL SUMMARY WITH CLEAR STRUCTURE AND VISUAL EMPHASIS.\n\n### WHAT NOT TO DO ###\n- **NEVER** OUTPUT RAW JSON DATA.\n- **NEVER** PROVIDE UNFORMATTED TEXT WITHOUT VISUAL ENHANCEMENT.\n- **NEVER** OMIT IMPORTANT CONTEXTUAL CLUES THAT INFLUENCE THE SENTIMENT.\n- **NEVER** IGNORE LA EXTRACCI√ìN DEL N√öMERO DE TICKET, CLIENTE O ASUNTO.\n- **NEVER** OMIT VISUAL ICONS PARA DESTACAR ALERTAS, RIESGOS O ASPECTOS POSITIVOS.\n\n### FEW-SHOT EXAMPLES ###\n**Input Text:** \"Nuevo Caso TT955821 - INVERSIONES CENTROAMERICANAS, S.A. : PRONE, PROMOCIONES Y NEGOCIOS, S.A Asunto del Ticket  CAIDA CANAL\"\n**Output:**\n**Resumen del An√°lisis de Sentimiento**\n\n- **Categor√≠a:** üö® Cr√≠tico\n- **N√∫mero de Ticket:** TT955821\n- **Cliente:** INVERSIONES CENTROAMERICANAS, S.A.\n- **Asunto del Ticket:** CAIDA CANAL\n- **Puntos Clave:**\n   - **Motivo:** Ca√≠da total del canal que afecta la conectividad del cliente.\n   - **Acci√≥n Recomendada:** Revisar la causa ra√≠z del incidente y optimizar tiempos de respuesta.\n\n**Conclusi√≥n:** Se recomienda escalar el caso y ofrecer disculpas formales al cliente."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[920,460],"id":"8fef6d29-adb8-4a7c-b3da-a1c89c8943f8","name":"AI Agent1"},{"parameters":{"model":{"__rl":true,"value":"llama-8B-Instruct","mode":"list","cachedResultName":"llama-8B-Instruct"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[500,640],"id":"707b48bb-5fa1-44da-9074-452077a564c9","name":"Chat Model Analysis1","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[860,660],"id":"b97d848b-d3eb-4984-ae8f-a05e42f4d5e9","name":"Summary Model1","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"jsCode":"// Funci√≥n para n8n que convierte texto con formato Markdown a HTML con estilos\nfunction convertToFormattedHTML(markdownText) {\n  // Primero limpiamos y normalizamos los saltos de l√≠nea\n  const cleanText = markdownText.replace(/\\\\n/g, '\\n');\n  \n  // Extraer las secciones principales\n  const titleMatch = cleanText.match(/\\*\\*Resumen del An√°lisis de Sentimiento\\*\\*/);\n  const categoryMatch = cleanText.match(/\\*\\*Categor√≠a:\\*\\* (.*?)(?:\\n|$)/);\n  const ticketMatch = cleanText.match(/\\*\\*N√∫mero de Ticket:\\*\\* (TT\\d+)(?:\\n|$)/);\n  const clientMatch = cleanText.match(/\\*\\*Cliente:\\*\\* (.*?)(?:\\n|$)/);\n  const subjectMatch = cleanText.match(/\\*\\*Asunto del Ticket:\\*\\* (.*?)(?:\\n|$)/);\n  const conclusionMatch = cleanText.match(/\\*\\*Conclusi√≥n:\\*\\* (.*?)(?:\\n\\n|$)/s);\n  \n  // Extraer los puntos clave\n  const keyPointsText = cleanText.substring(\n    cleanText.indexOf('**Puntos Clave:**'),\n    cleanText.indexOf('**Conclusi√≥n:**')\n  );\n  \n  // Extraer las recomendaciones y advertencias (basado en emojis)\n  const alertMatches = cleanText.match(/üö® \\*\\*(.*?)\\*\\*/g) || [];\n  const warningMatches = cleanText.match(/‚ö†Ô∏è \\*\\*(.*?)\\*\\*/g) || [];\n  const successMatches = cleanText.match(/‚úÖ \\*\\*((?!Neutral).*?)\\*\\*/g) || [];\n  \n  // Construir el HTML\n  let html = `<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body {\n      font-family: Arial, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      max-width: 600px;\n      margin: 0 auto;\n      padding: 20px;\n    }\n    p {\n      margin: 10px 0;\n    }\n    ul li {\n      margin-bottom: 10px;\n    }\n    h1 {\n      color: #2c3e50;\n      border-bottom: 1px solid #eee;\n      padding-bottom: 10px;\n    }\n    .ticket-info {\n      background-color: #f8f9fa;\n      border-left: 4px solid #2c3e50;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .neutral {\n      color: #3498db;\n    }\n    .alert {\n      background-color: #ffe0e0;\n      border-left: 4px solid #e74c3c;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .warning {\n      background-color: #fff4e0;\n      border-left: 4px solid #f39c12;\n      padding: 10px;\n      margin: 15px 0;\n    }\n    .success {\n      background-color: #e0ffe0;\n      border-left: 4px solid #2ecc71;\n      padding: 10px;\n      margin: 15px 0;\n    }\n  </style>\n</head>\n<body>\n  <h1>Resumen del An√°lisis de Sentimiento por Audio</h1>`;\n\n  // A√±adir informaci√≥n del ticket\n  html += `\n  <div class=\"ticket-info\">`;\n  \n  if (ticketMatch && ticketMatch[1]) {\n    html += `\n    <p><strong>N√∫mero de Ticket:</strong> ${ticketMatch[1]}</p>`;\n  }\n  \n  if (clientMatch && clientMatch[1]) {\n    html += `\n    <p><strong>Cliente:</strong> ${clientMatch[1]}</p>`;\n  }\n  \n  if (subjectMatch && subjectMatch[1]) {\n    html += `\n    <p><strong>Asunto:</strong> ${subjectMatch[1]}</p>`;\n  }\n  \n  html += `\n  </div>`;\n\n  // A√±adir categor√≠a\n  if (categoryMatch && categoryMatch[1]) {\n    html += `\n  <p><strong>Categor√≠a:</strong> <span class=\"neutral\">${categoryMatch[1]}</span></p>`;\n  }\n  \n  // A√±adir puntos clave (transformando el formato)\n  html += `\n  <p><strong>Puntos Clave:</strong></p>\n  <ul>`;\n  \n  // Procesar puntos clave usando expresiones regulares\n  const keyPoints = keyPointsText.match(/\\*\\*(.*?):\\*\\* (.*?)(?:\\n|$)/g) || [];\n  keyPoints.forEach(point => {\n    const pointMatch = point.match(/\\*\\*(.*?):\\*\\* (.*?)$/);\n    if (pointMatch && pointMatch[1] && pointMatch[2]) {\n      html += `\n    <li><strong>${pointMatch[1]}:</strong> ${pointMatch[2]}</li>`;\n    }\n  });\n  \n  html += `\n  </ul>`;\n  \n  // A√±adir conclusi√≥n - separamos el texto si es muy largo\n  if (conclusionMatch && conclusionMatch[1]) {\n    // Extraer solo la parte de la conclusi√≥n antes de los emojis\n    let conclusionText = conclusionMatch[1];\n    if (conclusionText.includes(\"üö®\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"üö®\")).trim();\n    } else if (conclusionText.includes(\"‚ö†Ô∏è\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"‚ö†Ô∏è\")).trim();\n    } else if (conclusionText.includes(\"‚úÖ\")) {\n      conclusionText = conclusionText.substring(0, conclusionText.indexOf(\"‚úÖ\")).trim();\n    }\n    \n    html += `\n  <p><strong>Conclusi√≥n:</strong></p>\n  <p style=\"margin-left: 15px;\">${conclusionText}</p>`;\n  }\n  \n  // A√±adir alertas\n  alertMatches.forEach(alert => {\n    const alertText = alert.replace(/üö® \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"alert\">\n    <p>üö® <strong>${alertText}</strong></p>\n  </div>`;\n  });\n  \n  // A√±adir advertencias\n  warningMatches.forEach(warning => {\n    const warningText = warning.replace(/‚ö†Ô∏è \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"warning\">\n    <p>‚ö†Ô∏è <strong>${warningText}</strong></p>\n  </div>`;\n  });\n  \n  // A√±adir √©xitos\n  successMatches.forEach(success => {\n    const successText = success.replace(/‚úÖ \\*\\*(.*?)\\*\\*/, '$1');\n    html += `\n  <div class=\"success\">\n    <p>‚úÖ <strong>${successText}</strong></p>\n  </div>`;\n  });\n  \n  // Cerrar el HTML\n  html += `\n</body>\n</html>`;\n\n  return html;\n}\n\n// Para usar en n8n\nconst items = $input.all();\nconst returnItems = [];\n\n// Procesar cada √≠tem\nfor (const item of items) {\n  try {\n    // Obtener el texto del resumen (ajusta la ruta seg√∫n donde est√© tu texto)\n    const summaryText = item.json.summary || item.json.output || item.json.text || '';\n    \n    // Convertir a HTML\n    const htmlEmail = convertToFormattedHTML(summaryText);\n    \n    // Devolver el resultado\n    returnItems.push({\n      json: {\n        ...item.json,\n        htmlEmail: htmlEmail\n      }\n    });\n  } catch (error) {\n    returnItems.push({\n      json: {\n        error: `Error al procesar HTML: ${error.message}`,\n        originalData: item.json\n      }\n    });\n  }\n}\n\nreturn returnItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1300,460],"id":"d50c4f29-9e1b-4855-9b6e-17ce730168a2","name":"Code1"},{"parameters":{"jsCode":"// Limpiar la transcripci√≥n y prepararla para an√°lisis\nconst rawText = $json.data;\nconst cleanText = rawText\n  .replace(/\\\\n/g, ' ')  // Reemplazar saltos de l√≠nea\n  .replace(/\\\\.../g, '') // Eliminar caracteres de escape\n  .trim();               // Eliminar espacios extras\n\n// Limitar longitud para an√°lisis\nconst trimmedText = cleanText.substring(0, 3000);\n\nreturn {\n  json: {\n    text: trimmedText,\n    full_transcription: cleanText\n  },\n  pairedItem: {\n    item: 0\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[360,460],"id":"82b6e1f2-d072-4326-9419-0436e7059b16","name":"Code2"},{"parameters":{"operation":"move","fileId":{"__rl":true,"value":"={{ $('Google Drive Trigger').item.json.id }}","mode":"id"},"driveId":{"__rl":true,"value":"My Drive","mode":"list","cachedResultName":"My Drive","cachedResultUrl":"https://drive.google.com/drive/my-drive"},"folderId":{"__rl":true,"value":"1mrwEV5SpQ14FNiGlvf-fFqh16Hj2VoYC","mode":"list","cachedResultName":"Audios_Care","cachedResultUrl":"https://drive.google.com/drive/folders/1mrwEV5SpQ14FNiGlvf-fFqh16Hj2VoYC"}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1680,460],"id":"d639415d-bdf0-4e4b-9840-c4d7e82d33de","name":"Google Drive1","credentials":{"googleDriveOAuth2Api":{"id":"KeJeYvddxw0ubE33","name":"Google Drive JPG"}}},{"parameters":{"toRecipients":"jaimeperezgonzalez@gmail.com","subject":"Analisis sentimiento","bodyContent":"={{ $('Code').item.json.htmlEmail }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1000,180],"id":"1d550a6e-e187-41ab-8769-e95afeb09460","name":"Microsoft Outlook","webhookId":"480b50ef-ac2c-4b16-a581-7aa06d44ea8f","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook Mail JPG"}}},{"parameters":{"inputText":"={{ $json.chatInput }}{{ $json.messages[0].text.body }}","options":{}},"type":"@n8n/n8n-nodes-langchain.sentimentAnalysis","typeVersion":1,"position":[-20,0],"id":"c2dca07f-c8d5-407e-a9b7-bbbfb02d9029","name":"Sentiment Analysis2"},{"parameters":{"updates":["messages"],"options":{}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[-40,-380],"id":"b390c49e-277f-40f0-afed-ef0743f99d14","name":"WhatsApp Trigger","webhookId":"4a9bb3b9-84ea-4f82-9684-beb940ca92ac","credentials":{"whatsAppTriggerApi":{"id":"ufAaSRGnDjgaKuwR","name":"WhatsApp API 3102489315"}}},{"parameters":{"promptType":"define","text":"={{ $json.messages[0].text.body }}"},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.6,"position":[180,-380],"id":"0a43fedc-b817-4b57-969a-706510d1a2ad","name":"Basic LLM Chain"},{"parameters":{"model":{"__rl":true,"value":"llama-8B-Instruct","mode":"list","cachedResultName":"llama-8B-Instruct"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[100,-180],"id":"2c55d606-838d-42c8-9713-1d3f5447fe91","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"operation":"send","phoneNumberId":"664678200054810","recipientPhoneNumber":"={{ $('WhatsApp Trigger').item.json.messages[0].from }}","textBody":"={{ $json.text }}","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1,"position":[560,-380],"id":"fdd50e51-c2ba-418f-9b41-edc0c1b48106","name":"WhatsApp Sender","webhookId":"e0513d99-34d7-455f-bf4c-7ebc06fa4d64","credentials":{"whatsAppApi":{"id":"Yh0EJtRqBFSCIotM","name":"WhatsApp Send Message 3102489315"}}}],"connections":{"When chat message received":{"main":[[{"node":"Sentiment Analysis2","type":"main","index":0}]]},"Gmail":{"main":[[]]},"Chat Model Analysis":{"ai_languageModel":[[{"node":"Sentiment Analysis2","type":"ai_languageModel","index":0}]]},"Summary Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Microsoft Outlook","type":"main","index":0}]]},"Google Drive Trigger":{"main":[[{"node":"Google Drive","type":"main","index":0}]]},"Google Drive":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Sentiment Analysis1":{"main":[[{"node":"AI Agent1","type":"main","index":0}],[{"node":"AI Agent1","type":"main","index":0}],[{"node":"AI Agent1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Chat Model Analysis1":{"ai_languageModel":[[{"node":"Sentiment Analysis1","type":"ai_languageModel","index":0}]]},"Summary Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"Gmail1","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Sentiment Analysis1","type":"main","index":0}]]},"Gmail1":{"main":[[{"node":"Google Drive1","type":"main","index":0}]]},"Sentiment Analysis2":{"main":[[{"node":"AI Agent","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}],[{"node":"AI Agent","type":"main","index":0}]]},"WhatsApp Trigger":{"main":[[{"node":"Basic LLM Chain","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Basic LLM Chain":{"main":[[{"node":"WhatsApp Sender","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"02666910-d23e-4d3b-b127-2413b4587161","triggerCount":0,"tags":[]}