{"createdAt":"2025-04-05T17:13:57.098Z","updatedAt":"2025-05-24T11:47:05.000Z","id":"SYmrYm84ahqSwcvz","name":"Dev Logs Analisis de Fortisiem Openwebui","active":false,"isArchived":true,"nodes":[{"parameters":{"jsCode":"// C√≥digo para nodo Code de n8n - Generador de Alertas de Ciberseguridad\n// Procesa datos din√°micos de entrada y genera un email HTML compatible\n\n// Funci√≥n para crear el header compatible con email\nfunction createEmailSafeHeader() {\n  return `\n  <!-- Header para clientes de correo -->\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px; max-width: 800px;\">\n    <tr>\n      <td style=\"position: relative; padding: 0;\">\n        <div style=\"position: relative; max-width: 800px; margin: 0 auto;\">\n          <img src=\"https://github.com/ifxnetworks/Dise-o/blob/main/Header_Comunicado_Cyberseguridad_IFX_CL_(2.0).png?raw=true\" alt=\"Header\" style=\"width: 100%; height: auto; display: block; max-width: 800px;\">\n          <div style=\"position: absolute; bottom: 10px; right: 15px; text-align: right;\">\n            <span style=\"color: #000000; font-family: Arial, sans-serif; font-size: 12px; margin-right: 4px;\">Generated by <i style=\"font-style: italic;\">aifx</i></span>\n          </div>\n        </div>\n      </td>\n    </tr>\n  </table>`;\n}\n\n// Funci√≥n para crear tarjetas de informaci√≥n\nfunction createInfoCard(title, value) {\n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 10px;\">\n    <tr>\n      <td style=\"background-color: #f8fafd; border: 1px solid #d1d8e0; border-radius: 8px; padding: 15px;\">\n        <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n          <tr>\n            <td style=\"font-family: Arial, sans-serif; color: #002244; font-weight: bold;\">${title}:</td>\n          </tr>\n          <tr>\n            <td style=\"font-family: Arial, sans-serif; padding-top: 5px;\">${value}</td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>`;\n}\n\n// Funci√≥n para crear la secci√≥n de estado del evento\nfunction createEventStatus(status, severity) {\n  let statusColor = \"#0066cc\";\n  \n  if (severity && severity.includes(\"HIGH\")) {\n    statusColor = \"#dc3545\";\n  } else if (severity && severity.includes(\"MEDIUM\")) {\n    statusColor = \"#ff9933\";\n  } else if (severity && severity.includes(\"LOW\")) {\n    statusColor = \"#28a745\";\n  }\n  \n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top: 20px;\">\n    <tr>\n      <td style=\"background-color: ${statusColor}; color: #ffffff; font-family: Arial, sans-serif; text-align: center; padding: 15px; border-radius: 8px; font-weight: bold;\">\n        Estado del Evento: ${status}\n      </td>\n    </tr>\n  </table>`;\n}\n\n// Funci√≥n para crear una secci√≥n con t√≠tulo\nfunction createSection(title, content) {\n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 30px;\">\n    <tr>\n      <td>\n        <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 15px;\">\n          <tr>\n            <td width=\"5\" style=\"background-color: #0066cc;\"></td>\n            <td style=\"padding-left: 10px; font-family: Arial, sans-serif; font-size: 20px; font-weight: bold; color: #002244;\">\n              ${title}\n            </td>\n          </tr>\n        </table>\n        ${content}\n      </td>\n    </tr>\n  </table>`;\n}\n\n// Funci√≥n para crear una lista compatible con email\nfunction createList(items) {\n  if (!items || !items.length) return '<p style=\"font-family: Arial, sans-serif;\">No hay elementos disponibles.</p>';\n  \n  let listHtml = '<table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">';\n  \n  items.forEach(item => {\n    listHtml += `\n    <tr>\n      <td width=\"20\" valign=\"top\" style=\"font-family: Arial, sans-serif; padding: 5px;\">‚Ä¢</td>\n      <td style=\"font-family: Arial, sans-serif; padding: 5px;\">${item}</td>\n    </tr>`;\n  });\n  \n  listHtml += '</table>';\n  return listHtml;\n}\n\n// Funci√≥n para generar el HTML de la alerta\nfunction generateAlertHTML(alertData) {\n  // Funci√≥n para acceso seguro a propiedades anidadas\n  const getNestedValue = (obj, path, defaultValue = '') => {\n    try {\n      const result = path.split('.').reduce((o, p) => o?.[p], obj);\n      return result !== undefined && result !== null ? result : defaultValue;\n    } catch (e) {\n      return defaultValue;\n    }\n  };\n  \n  // Secci√≥n de informaci√≥n del cliente\n  let clientInfoContent = `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n    <tr>\n      <td width=\"50%\" style=\"padding-right: 10px;\">\n        ${createInfoCard(\"Cliente Afectado\", getNestedValue(alertData, 'informacionCliente.clienteAfectado', 'No especificado'))}\n      </td>\n      <td width=\"50%\" style=\"padding-left: 10px;\">\n        ${createInfoCard(\"Fecha del Evento\", getNestedValue(alertData, 'informacionCliente.fechaEvento', 'No especificada'))}\n      </td>\n    </tr>\n    <tr>\n      <td width=\"50%\" style=\"padding-right: 10px; padding-top: 10px;\">\n        ${createInfoCard(\"N¬∞ Ticket\", getNestedValue(alertData, 'informacionCliente.numeroTicket', 'No especificado'))}\n      </td>\n      <td width=\"50%\" style=\"padding-left: 10px; padding-top: 10px;\">\n        ${createInfoCard(\"Severidad\", getNestedValue(alertData, 'informacionCliente.severidad', 'No especificada'))}\n      </td>\n    </tr>\n  </table>\n  \n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top: 20px;\">\n    <tr>\n      <td width=\"33%\" style=\"padding-right: 10px;\">\n        ${createInfoCard(\"Analista\", getNestedValue(alertData, 'informacionAnalisis.analista', 'No especificado'))}\n      </td>\n      <td width=\"33%\" style=\"padding: 0 5px;\">\n        ${createInfoCard(\"Categor√≠a\", getNestedValue(alertData, 'informacionAnalisis.categoria', 'No especificada'))}\n      </td>\n      <td width=\"33%\" style=\"padding-left: 10px;\">\n        ${createInfoCard(\"Regla Aplicada\", getNestedValue(alertData, 'informacionAnalisis.reglaAplicada', 'No especificada'))}\n      </td>\n    </tr>\n  </table>`;\n  \n  // Secci√≥n de detalles del evento\n  let eventDetailsContent = `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n    <tr>\n      <td width=\"50%\" style=\"padding-right: 10px;\">\n        ${createInfoCard(\"IP de Origen\", getNestedValue(alertData, 'detallesEvento.origen.ip', 'No disponible'))}\n      </td>\n      <td width=\"50%\" style=\"padding-left: 10px;\">\n        ${createInfoCard(\"Hostname de Origen\", getNestedValue(alertData, 'detallesEvento.origen.hostname', 'No disponible'))}\n      </td>\n    </tr>\n    <tr>\n      <td width=\"50%\" style=\"padding-right: 10px; padding-top: 10px;\">\n        ${createInfoCard(\"IP de Destino\", getNestedValue(alertData, 'detallesEvento.destino.ip', 'No disponible'))}\n      </td>\n      <td width=\"50%\" style=\"padding-left: 10px; padding-top: 10px;\">\n        ${createInfoCard(\"Host de Destino\", getNestedValue(alertData, 'detallesEvento.destino.hostname', 'No disponible'))}\n      </td>\n    </tr>\n    <tr>\n      <td colspan=\"2\" style=\"padding-top: 10px;\">\n        ${createInfoCard(\"Usuario Afectado\", getNestedValue(alertData, 'detallesEvento.usuarioAfectado', 'No especificado'))}\n      </td>\n    </tr>\n  </table>\n  ${createEventStatus(\n    getNestedValue(alertData, 'detallesEvento.estadoEvento', 'Pendiente de revisi√≥n'), \n    getNestedValue(alertData, 'informacionCliente.severidad', '')\n  )}`;\n  \n  // Secci√≥n de descripci√≥n y recomendaciones\n  let descriptionContent = `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px;\">\n    <tr>\n      <td style=\"font-family: Arial, sans-serif; padding-bottom: 10px;\">\n        <strong>Descripci√≥n del Evento:</strong> ${getNestedValue(alertData, 'descripcion', 'No hay descripci√≥n disponible')}\n      </td>\n    </tr>\n  </table>\n  \n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px;\">\n    <tr>\n      <td style=\"font-family: Arial, sans-serif; font-weight: bold; color: #002244; padding-bottom: 10px;\">\n        Acciones Detectadas:\n      </td>\n    </tr>\n    <tr>\n      <td>\n        ${createList(alertData.accionesDetectadas || [])}\n      </td>\n    </tr>\n  </table>\n  \n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n    <tr>\n      <td style=\"font-family: Arial, sans-serif; font-weight: bold; color: #002244; padding-bottom: 10px;\">\n        Recomendaciones:\n      </td>\n    </tr>\n    <tr>\n      <td>\n        ${createList(alertData.recomendaciones || [])}\n      </td>\n    </tr>\n  </table>`;\n  \n  // Construir HTML completo\n  return `<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>${getNestedValue(alertData, 'tipoAlerta', 'Alerta de Ciberseguridad')} - ${getNestedValue(alertData, 'titulo', 'Informe de Seguridad')}</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f7fb; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;\">\n  <center>\n    <table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width: 800px; margin: 0 auto;\">\n      <tr>\n        <td>\n          <table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"background-color: #ffffff; margin: 20px auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\">\n            <!-- Header -->\n            <tr>\n              <td align=\"center\">\n                ${createEmailSafeHeader(getNestedValue(alertData, 'informacionCliente.fechaEvento', ''))}\n              </td>\n            </tr>\n            \n            <!-- Contenido principal -->\n            <tr>\n              <td style=\"padding: 30px;\">\n                <!-- Informaci√≥n del Cliente y Evento -->\n                ${createSection(\"Informaci√≥n del Cliente y Evento\", clientInfoContent)}\n                \n                <!-- Detalles del Evento -->\n                ${createSection(\"Detalles del Evento\", eventDetailsContent)}\n                \n                <!-- Descripci√≥n y Recomendaciones -->\n                ${createSection(\"Descripci√≥n y Recomendaciones\", descriptionContent)}\n              </td>\n            </tr>\n            \n            <!-- Footer -->\n            <tr>\n              <td>\n                <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n                  <tr>\n                    <td align=\"center\">\n                      <img src=\"https://github.com/ifxnetworks/Dise-o/blob/main/Footer_Comunicado_Cyberseguridad_IFX_CL(2.0).png?raw=true\" alt=\"Pie de p√°gina\" style=\"width: 100%; max-width: 800px; height: auto; display: block;\">\n                    </td>\n                  </tr>\n                </table>\n              </td>\n            </tr>\n          </table>\n        </td>\n      </tr>\n    </table>\n  </center>\n</body>\n</html>`;\n}\n\n// Funci√≥n para completar datos faltantes en la alerta\nfunction completarDatosAlerta(datos) {\n  // Estructura base para asegurar integridad del reporte\n  const plantilla = {\n    \"tipoAlerta\": \"ALERTA DE CIBERSEGURIDAD\",\n    \"titulo\": \"Alerta de Seguridad\",\n    \"informacionCliente\": {\n      \"clienteAfectado\": \"No especificado\",\n      \"fechaEvento\": new Date().toLocaleString(),\n      \"numeroTicket\": \"Sin asignar\",\n      \"severidad\": \"No especificada\"\n    },\n    \"informacionAnalisis\": {\n      \"analista\": \"No especificado\",\n      \"categoria\": \"No especificada\",\n      \"reglaAplicada\": \"No especificada\"\n    },\n    \"detallesEvento\": {\n      \"origen\": {\n        \"ip\": \"No disponible\",\n        \"hostname\": \"No disponible\"\n      },\n      \"destino\": {\n        \"ip\": \"No disponible\",\n        \"hostname\": \"No disponible\"\n      },\n      \"usuarioAfectado\": \"No especificado\",\n      \"estadoEvento\": \"Pendiente de revisi√≥n\"\n    },\n    \"descripcion\": \"No hay descripci√≥n disponible\",\n    \"accionesDetectadas\": [\"No hay acciones detectadas disponibles\"],\n    \"recomendaciones\": [\"No hay recomendaciones disponibles\"]\n  };\n  \n  // Combinar datos proporcionados con plantilla\n  return {\n    ...plantilla,\n    ...datos,\n    informacionCliente: {\n      ...plantilla.informacionCliente,\n      ...(datos.informacionCliente || {})\n    },\n    informacionAnalisis: {\n      ...plantilla.informacionAnalisis,\n      ...(datos.informacionAnalisis || {})\n    },\n    detallesEvento: {\n      ...plantilla.detallesEvento,\n      ...(datos.detallesEvento || {}),\n      origen: {\n        ...plantilla.detallesEvento.origen,\n        ...(datos.detallesEvento?.origen || {})\n      },\n      destino: {\n        ...plantilla.detallesEvento.destino,\n        ...(datos.detallesEvento?.destino || {})\n      }\n    }\n  };\n}\n\n// Funci√≥n para generar versi√≥n de texto plano\nfunction generateTextVersion(alertData) {\n  return `\nALERTA DE CIBERSEGURIDAD - ${alertData.titulo || 'Alerta de Seguridad'}\nFecha: ${alertData.informacionCliente?.fechaEvento || 'No especificada'}\nCliente: ${alertData.informacionCliente?.clienteAfectado || 'No especificado'}\nTicket: ${alertData.informacionCliente?.numeroTicket || 'No especificado'}\nSeveridad: ${alertData.informacionCliente?.severidad || 'No especificada'}\n\nDETALLES DEL EVENTO:\n- IP Origen: ${alertData.detallesEvento?.origen?.ip || 'No disponible'} (${alertData.detallesEvento?.origen?.hostname || 'No disponible'})\n- IP Destino: ${alertData.detallesEvento?.destino?.ip || 'No disponible'} (${alertData.detallesEvento?.destino?.hostname || 'No disponible'})\n- Usuario Afectado: ${alertData.detallesEvento?.usuarioAfectado || 'No especificado'}\n- Estado: ${alertData.detallesEvento?.estadoEvento || 'No especificado'}\n\nDESCRIPCI√ìN:\n${alertData.descripcion || 'No disponible'}\n\nACCIONES DETECTADAS:\n${alertData.accionesDetectadas?.map(accion => `- ${accion}`).join('\\n') || '- No disponibles'}\n\nRECOMENDACIONES:\n${alertData.recomendaciones?.map(recomendacion => `- ${recomendacion}`).join('\\n') || '- No disponibles'}\n  `;\n}\n\n// C√≥digo principal para n8n\nconst items = $input.all();\nconst returnItems = [];\n\nfor (const item of items) {\n  try {\n    // Extraer y parsear los datos JSON del campo output\n    let alertData;\n    \n    if (item.json && item.json.output) {\n      try {\n        // El campo output puede contener c√≥digo con backticks y formato ```json\n        let jsonStr = item.json.output;\n        \n        // Eliminar ```json y ``` si est√°n presentes\n        if (jsonStr.includes('```json')) {\n          jsonStr = jsonStr.replace(/```json\\n/g, '').replace(/```$/g, '');\n        }\n        \n        // Intenta parsear el JSON\n        alertData = JSON.parse(jsonStr);\n        console.log(\"Datos JSON procesados correctamente\");\n      } catch (e) {\n        console.log('Error al parsear JSON:', e);\n        throw new Error(`No se pudo parsear el JSON: ${e.message}`);\n      }\n    } else {\n      throw new Error('No se encontr√≥ un campo output en los datos de entrada');\n    }\n    \n    // Validar estructura y completar datos faltantes\n    if (!alertData || !alertData.tipoAlerta || !alertData.titulo) {\n      console.log('Estructura de datos incompleta, completando con valores por defecto');\n      alertData = completarDatosAlerta(alertData || {});\n    }\n    \n    // Generar HTML y versi√≥n de texto\n    const html = generateAlertHTML(alertData);\n    const textVersion = generateTextVersion(alertData);\n    \n    // Devolver resultados\n    returnItems.push({\n      json: {\n        htmlEmail: html,\n        textEmail: textVersion,\n        alertData: alertData,\n        subject: `${alertData.tipoAlerta} - ${alertData.titulo} ${alertData.informacionCliente?.severidad ? `[${alertData.informacionCliente.severidad}]` : ''}`\n      }\n    });\n  } catch (error) {\n    console.log('Error:', error);\n    const errorMessage = error instanceof Error \n      ? error.message \n      : 'Error desconocido';\n    returnItems.push({\n      json: {\n        error: `Error al procesar los datos: ${errorMessage}`,\n        originalInput: item.json ? JSON.stringify(item.json) : 'No hay datos de entrada'\n      }\n    });\n  }\n}\n\nreturn returnItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1320,40],"id":"1affa621-7f43-49ff-97da-7ada7fbdcdc5","name":"Convertir a HTML Template"},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=TEST - Alerta de Ciberseguridad -  {{ $json.alertData.informacionCliente.clienteAfectado }} - {{ $json.alertData.informacionCliente.numeroTicket }}","bodyContent":"={{ $json.htmlEmail }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[-1120,40],"id":"fb9281e6-40ee-4e73-b93f-3a2d7c2ff75b","name":"Enviar Correo HTML a SOC","webhookId":"848327b2-7b40-4675-901f-50be26abb01b","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook Mail JPG"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"responseFormat":"json_object","temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1760,280],"id":"7c6acd51-4ef8-4723-9343-c2bcae89a4ce","name":"Lllama 70B","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"httpMethod":"POST","path":"logs-siem","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1960,80],"id":"f579dd18-5631-4c2d-a4b5-1f245d7a1f88","name":"Webhook","webhookId":"a91306f5-ea1e-4cb8-8a81-6538e8ceb80b"},{"parameters":{"options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-940,220],"id":"6e48953a-3636-4173-b113-89ef4ebb7dc5","name":"Respond to Webhook"},{"parameters":{"promptType":"define","text":"={{ $json.output }}","options":{"systemMessage":"ERES UN MODELO ESPECIALIZADO EN TRANSFORMAR ALERTAS DE SEGURIDAD EN FORMATO JSON A UN FORMATO **MARKDOWN ENRIQUECIDO** LEGIBLE PARA EQUIPOS T√âCNICOS Y EJECUTIVOS. TU SALIDA DEBE TENER ESTILO CLARO, PROFESIONAL Y T√âCNICAMENTE PRECISO.\n\n---\n\nüéØ **OBJETIVO PRINCIPAL**  \nCONVIERTE CUALQUIER ALERTA DE CIBERSEGURIDAD EN FORMATO JSON AL FORMATO **MARKDOWN**, CONSERVANDO TODOS LOS DETALLES IMPORTANTES Y ORGANIZ√ÅNDOLOS CON TIPOGRAF√çA RICA (negritas, listas, espaciado adecuado), PERO **SIN USAR BLOQUES DE C√ìDIGO COMO ` ``` `**.\n\n---\n\nüìå **INSTRUCCIONES DE FORMATO Y COMPORTAMIENTO**\n\n- NO uses ```markdown ni ning√∫n bloque de c√≥digo.\n- NO inventes datos. Si alg√∫n campo no existe o est√° vac√≠o, om√≠telo del resultado.\n- NO incluyas los campos `recursos.imagenEncabezado` ni `recursos.imagenPie`.\n- AGREGA una nota final discreta que diga:  \n  _Generated by aifx_\n\n- CONVIERTE las siguientes claves en un texto MARKDOWN estructurado:\n\n---\n\nüìä ESTRUCTURA DE CONVERSI√ìN\n\n1. **tipoAlerta** y **titulo** ‚Üí PRES√âNTALO COMO T√çTULO CON NEGRITA Y MAY√öSCULAS.  \n   Ejemplo: `**ALERTA DE CIBERSEGURIDAD: Fallas en IPsec Phase 1**`\n\n2. **informacionCliente** ‚Üí MUESTRA EN LISTA DE PUNTOS  \n   - Cliente afectado: ...  \n   - Fecha del evento: ...  \n   - N√∫mero de ticket: ...  \n   - Severidad: ...\n\n3. **informacionAnalisis** ‚Üí OTRA LISTA  \n   - Analista: ...  \n   - Categor√≠a: ...  \n   - Regla aplicada: ...\n\n4. **detallesEvento** ‚Üí SEPARAR POR ORIGEN, DESTINO, USUARIO  \n   - IP Origen: ...  \n   - Hostname Origen: ...  \n   - IP Destino: ...  \n   - Hostname Destino: ...  \n   - Usuario afectado: ...  \n   - Estado del evento: ...\n\n5. **descripcion** ‚Üí MOSTRAR COMO P√ÅRRAFO NORMAL CON NEGRITA:  \n   - **Descripci√≥n**: ...\n\n6. **accionesDetectadas** ‚Üí LISTA CON VI√ëETAS  \n   - Acci√≥n detectada 1  \n   - Acci√≥n detectada 2  \n   - ...\n\n7. **recomendaciones** ‚Üí OTRA LISTA CON VI√ëETAS  \n   - Recomendaci√≥n t√©cnica 1  \n   - Recomendaci√≥n t√©cnica 2  \n   - ...\n\n8. **metadatos** ‚Üí MOSTRAR EN LISTA SIMPLE  \n   - Tipo de documento: ...  \n   - Versi√≥n del formato: ...  \n   - Fecha de generaci√≥n: ...\n\n---\n\n‚ö†Ô∏è **QU√â NO HACER**\n\n- ‚ùå NO AGREGUES ENCABEZADOS DE NIVEL H1/H2/H3\n- ‚ùå NO INSERTES BLOQUES DE C√ìDIGO NI MARCADORES DE FORMATO DE C√ìDIGO COMO ` ``` `\n- ‚ùå NO A√ëADAS IM√ÅGENES, LINKS, NI CONTENIDO EXTERNO\n- ‚ùå NO INCLUYAS CAMPOS VAC√çOS NI CAMPOS INEXISTENTES\n- ‚ùå NO CAMBIES EL ORDEN DE LOS ELEMENTOS\n- ‚ùå NO RESUMAS, NO INTERPRETES, SOLO FORMATEA\n\n---\n\n‚úÖ **EJEMPLO DE SALIDA ESPERADA (RESUMEN VISUAL):**\n\n**ALERTA DE CIBERSEGURIDAD: Fallas en IPsec Phase 1**\n\n- Cliente afectado: Empresa XYZ  \n- Fecha del evento: 2025-03-31 14:22  \n- N√∫mero de ticket: INC123456  \n- Severidad: 9\n\n- Analista: Juan P√©rez  \n- Categor√≠a: T1566.002  \n- Regla aplicada: IPSec Phase 1 Mismatch\n\n- IP Origen: 10.10.10.1  \n- Hostname Origen: fw-main-east  \n- IP Destino: 192.168.5.10  \n- Hostname Destino: vpn-gateway-west  \n- Usuario afectado: admin_ops  \n- Estado del evento: En investigaci√≥n\n\n**Descripci√≥n**: Se detectaron m√∫ltiples intentos fallidos de negociaci√≥n IKEv2 entre dos gateways de VPN, indicando un desajuste en los par√°metros de autenticaci√≥n.\n\n- Intentos de conexi√≥n IKEv2 fallidos desde IP origen  \n- Regla IPSec Negotiation Failed disparada  \n- Eventos repetidos en menos de 5 minutos  \n- IPs involucradas con tr√°fico no autorizado  \n- Posible desincronizaci√≥n de par√°metros de cifrado\n\n- Revisar par√°metros de Fase 1 en ambos dispositivos  \n- Validar integridad de certificados utilizados  \n- Sincronizar m√©todos de autenticaci√≥n entre gateways  \n- Verificar logs correlacionados de eventos similares  \n- Aplicar cambios en mantenimiento programado\n\n- Tipo de documento: Alerta de Seguridad  \n- Versi√≥n del formato: 1.0  \n- Fecha de generaci√≥n: 2025-04-01\n\n_Generated by aifx_\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[-1320,220],"id":"0ff9b282-a9b8-40e6-8cec-6e5b51a82f52","name":"Convertir a Texto"},{"parameters":{"promptType":"define","text":"={{ $json.body.chatInput }}","options":{"systemMessage":"## üéØ OBJETIVO:\nERES UN ANALISTA DE CIBERSEGURIDAD EN UN CENTRO DE OPERACIONES DE SEGURIDAD (SOC). TU FUNCI√ìN ES ACTUAR COMO UN EXPERTO DE √âLITE EN SEGURIDAD INFORM√ÅTICA. TU TAREA ES ANALIZAR EVENTOS DE SEGURIDAD Y GENERAR INFORMES ESTRUCTURADOS USANDO:\n\n- LA METODOLOG√çA **STAR (SITUACI√ìN, TAREA, ACCI√ìN, RESULTADO)**  \n- EST√ÅNDARES INTERNACIONALES COMO **NIST**, **MITRE ATT&CK**, Y DIRECTRICES DE FABRICANTES  \n- UNA RESPUESTA FINAL EN FORMATO **JSON ESTRUCTURADO** SIGUIENDO LA PLANTILLA DEFINIDA\n\n## üîç CADENA DE RAZONAMIENTO (CHAIN OF THOUGHTS):\n1. **COMPRENDER** el contexto del evento y su impacto potencial.\n2. **IDENTIFICAR** elementos clave: IPs, hostnames, logs, severidad, categor√≠a MITRE, reglas.\n3. **CLASIFICAR** la severidad como **ALTA**, **MEDIA** o **BAJA**.\n4. **DESCRIBIR** el evento en t√©rminos t√©cnicos usando la metodolog√≠a STAR.\n5. **DETERMINAR** acciones observadas y **PROPONER** recomendaciones t√©cnicas espec√≠ficas.\n6. **ENSAMBLAR** toda la informaci√≥n en una estructura **JSON** conforme al modelo preestablecido.\n\n## üß† ESTRUCTURA DE RESPUESTA (FORMATO OBLIGATORIO)\n{\n  \"tipoAlerta\": \"ALERTA DE CIBERSEGURIDAD\",\n  \"titulo\": \"[T√≠tulo claro del evento]\",\n  \"informacionCliente\": {\n    \"clienteAfectado\": \"[Nombre del cliente]\",\n    \"fechaEvento\": \"[Fecha y hora del evento]\",\n    \"numeroTicket\": \"[Ticket o c√≥digo del incidente] **Extraer identificadores como 'TT123456'**\",\n    \"severidad\": \"[Nivel de severidad con valor num√©rico si aplica]\"\n  },\n  \"informacionAnalisis\": {\n    \"analista\": \"[Nombre del analista o 'No especificado']\",\n    \"categoria\": \"[Clasificaci√≥n MITRE u otra]\",\n    \"reglaAplicada\": \"[Regla o nombre de alerta que gener√≥ el evento]\"\n  },\n  \"detallesEvento\": {\n    \"origen\": {\n      \"ip\": \"[IP origen]\",\n      \"hostname\": \"[Hostname origen]\"\n    },\n    \"destino\": {\n      \"ip\": \"[IP destino]\",\n      \"hostname\": \"[Hostname destino]\"\n    },\n    \"usuarioAfectado\": \"[Usuario relacionado al evento]\",\n    \"estadoEvento\": \"[Estado actual del incidente]\"\n  },\n  \"descripcion\": \"[Resumen t√©cnico del evento redactado usando metodolog√≠a STAR]\",\n  \"accionesDetectadas\": [\n    \"[Acci√≥n o comportamiento observado 1]\",\n    \"[Acci√≥n 2]\",\n    \"[...]\"\n  ],\n  \"recomendaciones\": [\n    \"[Recomendaci√≥n t√©cnica 1]\",\n    \"[Recomendaci√≥n 2]\",\n    \"[...]\"\n  ],\n  \"recursos\": {\n    \"imagenEncabezado\": \"https://github.com/ifxnetworks/Dise-o/blob/main/Header_Comunicado_Cyberseguridad_IFX_CL_(2.0).png?raw=true\",\n    \"imagenPie\": \"https://github.com/ifxnetworks/Dise-o/blob/main/Footer_Comunicado_Cyberseguridad_IFX_CL(2.0).png?raw=true\"\n  },\n  \"metadatos\": {\n    \"tipoDocumento\": \"Alerta de Seguridad\",\n    \"versionFormato\": \"1.0\",\n    \"fechaGeneracion\": \"[Fecha de generaci√≥n del JSON]\"\n  }\n}\n\n## üìå DIRECTRICES DE AN√ÅLISIS:\n- SIGUE SIEMPRE LA METODOLOG√çA **STAR**\n- USA VOCABULARIO T√âCNICO, PRESERVANDO T√âRMINOS EN INGL√âS SI SON EST√ÅNDAR (EJ. \"brute-force\", \"IPSec\", \"phishing\")\n- CLASIFICA LA SEVERIDAD DEL EVENTO Y APLICA CATEGOR√çA **MITRE** CUANDO SEA POSIBLE\n- USA FECHAS Y FORMATO ISO 8601 SI ES NECESARIO (ej: 2025-04-04T13:45:00Z)\n- IDENTIFICA Y EXTRA LOS CAMPOS NECESARIOS PARA CUMPLIR CON EL JSON (ej: ticket TT123456, IPs, usuarios)\n\n## üö´ QU√â NO HACER (WHAT NOT TO DO):\n- ‚ùå NO RESPONDER EN FORMATO LIBRE O SOLO EN MARKDOWN: LA RESPUESTA DEBE SER 100% EN FORMATO JSON.\n- ‚ùå NO OMITIR CAMPOS COMO **IPs**, **USUARIOS**, **CATEGOR√çA MITRE**, **N√öMERO DE TICKET**\n- ‚ùå NO INVENTAR INFORMACI√ìN SI NO EXISTE EN LOS DATOS: USA \"No especificado\" O \"[Desconocido]\"\n- ‚ùå NO USAR UN FORMATO DIFERENTE AL JSON MOSTRADO ARRIBA\n- ‚ùå NO CAMBIAR LOS NOMBRES DE CLAVE DEL JSON\n\n## ‚úÖ EJEMPLO DE SALIDA ESPERADA (FRAGMENTO)\n{\n  \"tipoAlerta\": \"ALERTA DE CIBERSEGURIDAD\",\n  \"titulo\": \"Actividad sospechosa detectada en tr√°fico SSH\",\n  ...\n}"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[-1700,80],"id":"222db8c8-7906-49eb-a35d-36d3bbaf3950","name":"Analisis de los Logs","alwaysOutputData":false},{"parameters":{"model":{"__rl":true,"value":"openai-mini","mode":"list","cachedResultName":"openai-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1320,400],"id":"bc859ff2-6506-444f-938b-23aee5d0c9b3","name":"Llama 8B","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"model":{"__rl":true,"value":"openai-mini","mode":"list","cachedResultName":"openai-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1220,440],"id":"bc859ff2-6506-444f-938b-23aee5d0c9b3","name":"Llama 8B","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}}],"connections":{"Convertir a HTML Template":{"main":[[{"node":"Enviar Correo HTML a SOC","type":"main","index":0}]]},"Lllama 70B":{"ai_languageModel":[[{"node":"Analisis de los Logs","type":"ai_languageModel","index":0}]]},"Webhook":{"main":[[{"node":"Analisis de los Logs","type":"main","index":0}]]},"Enviar Correo HTML a SOC":{"main":[[]]},"Respond to Webhook":{"main":[[]]},"Convertir a Texto":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Analisis de los Logs":{"main":[[{"node":"Convertir a Texto","type":"main","index":0},{"node":"Convertir a HTML Template","type":"main","index":0}]]},"Llama 8B":{"ai_languageModel":[[{"node":"Convertir a Texto","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner"},"staticData":{"global":{"output_default-session":"**ALERTA DE CIBERSEGURIDAD: Actividad sospechosa detectada en tr√°fico VPN y SSL**\n\n- Cliente afectado: No especificado  \n- Fecha del evento: 2025-01-29 11:42:11 CLST  \n- N√∫mero de ticket: No especificado  \n- Severidad: ALTA\n\n- Analista: No especificado  \n- Categor√≠a: T1496: SSL/TLS Inspection  \n- Regla aplicada: SSL VPN alert\n\n- IP Origen: 94.232.46.49  \n- Hostname Origen: No especificado  \n- IP Destino: 172.16.30.1  \n- Hostname Destino: CLSCLELB8SFNG1500DX018  \n- Usuario afectado: N/A  \n- Estado del evento: En an√°lisis\n\n**Descripci√≥n**: Se ha detectado actividad sospechosa en el tr√°fico VPN y SSL. El an√°lisis de los registros muestra varias alertas de SSL VPN y errores de fase 1 de IPsec. La situaci√≥n se describe como una posible intentona de acceso no autorizado al sistema. La tarea es analizar los registros y determinar la causa ra√≠z del problema. La acci√≥n tomada es la notificaci√≥n a los equipos de seguridad y el inicio de una investigaci√≥n m√°s a fondo. El resultado es la identificaci√≥n de una posible vulnerabilidad en el sistema de VPN y la necesidad de actualizar los protocolos de seguridad.\n\n- Intentos de conexi√≥n SSL VPN  \n- Errores de fase 1 de IPsec  \n- Alertas de SSL VPN  \n\n- Actualizar los protocolos de seguridad de VPN  \n- Revisar los registros de conexi√≥n para detectar patrones sospechosos  \n- Realizar pruebas de penetraci√≥n para identificar vulnerabilidades  \n\n- Tipo de documento: Alerta de Seguridad  \n- Versi√≥n del formato: 1.0  \n- Fecha de generaci√≥n: 2025-02-01 20:36:58  \n\n_Generated by aifx_"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"ff22af3e-4a0c-4d87-87de-9abf8656839b","triggerCount":1,"tags":[]}