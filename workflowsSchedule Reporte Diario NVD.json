{"createdAt":"2025-03-29T22:21:01.709Z","updatedAt":"2025-05-23T01:33:36.000Z","id":"aJjWj0GkiWK3TgyK","name":"Schedule Reporte Diario NVD","active":true,"isArchived":false,"nodes":[{"parameters":{"promptType":"define","text":"={{ $json.concatenated_data }}","options":{"systemMessage":"ERES UN EXPERTO ANALISTA DE CIBERSEGURIDAD Y TU FUNCI√ìN PRINCIPAL ES ANALIZAR, CLASIFICAR Y RESUMIR REPORTES DE VULNERABILIDADES OBTENIDOS A TRAV√âS DE LA **NVD (NATIONAL VULNERABILITY DATABASE) NIST.GOV**. DEBES PRODUCIR UNA SALIDA **ESTRICTAMENTE EN FORMATO JSON** QUE CUMPLA CON LA ESTRUCTURA PROPORCIONADA M√ÅS ABAJO.\n\n---\n\n### ENCABEZADO OBLIGATORIO ###\nINCLUYE SIEMPRE AL INICIO DE CADA INFORME LA SIGUIENTE L√çNEA EN NEGRITA:\n\n**FUENTE DEL REPORTE: NVD (NATIONAL VULNERABILITY DATABASE) NIST.GOV**\n\n---\n\n### INSTRUCCIONES DE SALIDA ###\n\n1. **CLASIFICA** LAS VULNERABILIDADES EN TRES CATEGOR√çAS BASADAS EN SU CVSS:\n   - üî¥ **CRITICIDAD ALTA**\n   - üü† **CRITICIDAD MEDIA**\n   - üü¢ **CRITICIDAD BAJA**\n\n2. **EXTRAE Y PRESENTA** PARA CADA VULNERABILIDAD LOS SIGUIENTES CAMPOS:\n   - **CVE**\n   - **Fecha del Reporte**\n   - **Fabricante Afectado**\n   - **Producto Afectado**\n   - **CVSS**\n   - **Descripci√≥n T√©cnica**\n   - **Acciones Recomendadas**\n   - **Referencias** (S√ìLO LAS URLS TAL COMO VIENEN, SIN FORMATO EXTRA)\n\n3. AGREGA UNA SECCI√ìN DE **PAUTAS DE ACCI√ìN GENERALES**, CONTENIENDO BUENAS PR√ÅCTICAS DE SEGURIDAD.\n\n4. INCLUYE UNA SECCI√ìN DE **ESTAD√çSTICAS** AL FINAL CON LOS SIGUIENTES CAMPOS:\n   - **Total de Vulnerabilidades**\n   - **Conteo por Criticidad**\n   - **Promedio CVSS**\n\n---\n\n### FORMATO JSON OBLIGATORIO DE SALIDA ###\nDEVUELVE **EXCLUSIVAMENTE** UNA RESPUESTA EN FORMATO JSON, SIENDO OBLGATORIO ESTE ESQUEMA JSON\n\n{\n  \"metadata\": {\n    \"title\": \"\",\n    \"fecha\": \"\",\n    \"fuente\": \"\"\n  },\n  \"vulnerabilidades\": [\n    {\n      \"criticidad\": \"Alta\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    },\n    {\n      \"criticidad\": \"Media\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    },\n    {\n      \"criticidad\": \"Baja\",\n      \"cve\": \"\",\n      \"fecha_reporte\": \"\",\n      \"fabricante\": \"\",\n      \"producto\": \"\",\n      \"cvss\": null,\n      \"descripcion\": \"\",\n      \"acciones_recomendadas\": [\n        \"\"\n      ],\n      \"referencias\": [\n        \"\"\n      ]\n    }\n  ],\n  \"pautas_generales\": [\n    \"\",\n    \"\"\n  ],\n  \"estadisticas\": {\n    \"total_vulnerabilidades\": null,\n    \"vulnerabilidades_altas\": null,\n    \"vulnerabilidades_medias\": null,\n    \"vulnerabilidades_bajas\": null,\n    \"promedio_cvss\": null\n  }\n}\n\n### CHAIN OF THOUGHTS ###\nSIGUE ESTRICTAMENTE ESTE PROCESO ANTES DE GENERAR LA SALIDA:\n\n1. **ENTENDER**: LEER Y COMPRENDER LA INFORMACI√ìN CRUDA DE LA API DE VULNERS.\n2. **IDENTIFICAR**: EXTRAER LOS CAMPOS RELEVANTES COMO CVE, CVSS, FABRICANTE, ETC.\n3. **CLASIFICAR**: ASIGNAR UNA CATEGOR√çA DE CRITICIDAD BASADA EN EL CVSS.\n4. **ANALIZAR**: EVALUAR IMPACTO, VECTORES Y DETALLES T√âCNICOS RELEVANTES.\n5. **SINTETIZAR**: REDACTAR DESCRIPCIONES Y RECOMENDACIONES CLARAS Y √öTILES.\n6. **ESTRUCTURAR**: ORDENAR LA INFORMACI√ìN EN EL FORMATO JSON DEFINIDO.\n7. **VALIDAR**: ASEGURAR QUE TODAS LAS SECCIONES Y CAMPOS EST√âN COMPLETOS Y CORRECTOS.\n8. **TRADUCIR**: LA DESCRIPCION TECNICA SIEMPRE DEBE SER ENTREGADA EN ESPA√±OL, MANTENIENDO SOLAMENTE LOS TERMINOS TECNICOS EN EL IDIOMA ORIGINAL.\n\n---\n\n### WHAT NOT TO DO ###\n- **NO OMITAS EL ENCABEZADO DE LA FUENTE (API DE LA NATIONAL VULNERABILITY DATABASE DE NIST.GOV)**\n- **NO FUSIONES VULNERABILIDADES DE DIFERENTES NIVELES DE CRITICIDAD EN UNA MISMA ENTRADA**\n- **NO OMITAS CAMPOS COMO FECHA, CVSS, O FABRICANTE**\n- **NO USES DESCRIPCIONES GEN√âRICAS O INEXACTAS**\n- **NO DEJES VAC√çAS LAS ACCIONES RECOMENDADAS**\n- **NO FORMATEES ENLACES COMO MARKDOWN, NI LOS ENCAPSULES ENTRE PAR√âNTESIS O CORCHETES**\n- **NO DEVUELVAS OTRO FORMATO QUE NO SEA EL JSON DEFINIDO**\n- **NO A√ëADAS TEXTO EXTERNO FUERA DE LA RESPUESTA JSON (NI COMENTARIOS, NI CABECERAS EXTRA, NI SALUDOS)**"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1620,60],"id":"2c3c3ef3-b8ab-467f-b40b-266418bc513d","name":"AI Agent"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=VMware&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-720],"id":"be1ef78c-f8ce-4a9a-abd1-ab130613eedd","name":"Vmware"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Sophos&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-580],"id":"d3284c09-0172-4eff-9d20-b27001fb01ee","name":"Sophos"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=HPE&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-440],"id":"57c91ff9-8105-4546-895c-ded99832b0b2","name":"HPE"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Veeam&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-300],"id":"4142aaa5-bffa-4a33-a41a-881abfc50feb","name":"Veeam"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Fortinet&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-160],"id":"39946780-22b6-49d6-8e01-c25ee8c2ea35","name":"Fortinet"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Cisco&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,-20],"id":"fc6df2d9-aeba-4bc5-8aac-1e560ae4cfc8","name":"Cisco"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Ansible&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,120],"id":"67474fec-2477-494f-a38c-68e4a67c97fe","name":"Ansible"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Kubernetes&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,260],"id":"d1b7e37b-7f56-47c2-b47d-2802e11ab6ef","name":"Kubernetes"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=SolarWinds&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,400],"id":"6256c020-a200-4547-bc65-86c0bee47f2f","name":"SolarWinds"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Acronis&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,540],"id":"18c22b74-5426-4fa5-a032-35341df5f2e3","name":"Acronis"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Juniper&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}\n","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-720],"id":"de4a9380-47a4-4520-b9f3-16c192d4838c","name":"Juniper"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Huawei&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-580],"id":"5718fee6-3037-4d02-9dcf-7eb456446b8c","name":"Huawei"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Chrome&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-440],"id":"8f1929e6-0183-4222-9ccf-0013cf552ac6","name":"Chrome"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Edge&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-300],"id":"abecff19-069b-4357-a1cf-f8a8299add34","name":"Edge"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Outlook&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-160],"id":"df7ca769-3a8a-4408-8e91-7adf0032b391","name":"Outlook"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Dell&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,-20],"id":"77f6086d-b475-4288-b617-45207fb26d7e","name":"Dell"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=IBM&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,120],"id":"64a50415-3530-4069-be1e-d3032edd86d4","name":"IBM"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Hitachi&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,260],"id":"151372d2-f0dd-4e69-8841-d8afa89a3833","name":"Hitachi"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Pure&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,400],"id":"d3f73f41-f619-4788-884c-8b44e3f155f0","name":"Pure"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Broadcom&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,540],"id":"8ebc0b6d-4dab-4f51-96dd-58d55bae3066","name":"Broadcom"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Mikrotik&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-100,680],"id":"859a3ec4-a650-44ff-bdf6-d7296edc8ed9","name":"Mikrotik"},{"parameters":{"numberInputs":10},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,-440],"id":"e345f4a8-6172-416b-8bad-2719257746f4","name":"Grupo 1"},{"parameters":{"numberInputs":9},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,60],"id":"77364be1-4de2-409f-9a51-b9ae5b7907e6","name":"Grupo 2"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[880,500],"id":"e26f7ac8-56d9-4417-a234-613f9541203f","name":"Grupo 3"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[1140,60],"id":"7148b987-2e35-4ce9-b1a0-bdb5c7a34e21","name":"Merge"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-720],"id":"a025ec39-d7f2-455c-b6b4-6f9c3caf3da0","name":"If"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-580],"id":"7c8b204d-dff6-4855-9bb6-17f1cef95e23","name":"If1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-440],"id":"d28da08a-a7a5-47b3-bc53-162df0c0b0b4","name":"If2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-300],"id":"613fd8a6-67c7-4d68-87da-37fd4a277b21","name":"If3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-160],"id":"9e6d8278-6bb0-4500-a896-42d069c85870","name":"If4"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,-20],"id":"4d9274d5-2c33-4346-a36f-008c71217517","name":"If5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,120],"id":"49167930-717d-4bb7-ba82-67ebe6cf0b5d","name":"If6"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,260],"id":"4ebf6b5b-eacc-45b4-9cbc-d619abf13bec","name":"If7"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,400],"id":"cbf3a56d-c9d2-4d86-bf74-12317e2afea3","name":"If8"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,540],"id":"7f655983-8028-4312-98a8-1c42920de42a","name":"If9"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[80,680],"id":"4ad494b9-b426-4b23-a7ac-c84e8a851427","name":"If10"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-720],"id":"079ad9a5-d5a6-48f5-b4b2-bc00ef57129d","name":"If11"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-580],"id":"f2334965-4365-4539-a35a-0e489d69ec54","name":"If12"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-440],"id":"8d6b668d-1a3d-4885-b361-736743a9c99a","name":"If13"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-300],"id":"a00abf90-d0ac-4a4e-be92-ef2ede5f4245","name":"If14"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-160],"id":"5ab345a8-27de-41c0-bc08-ab7550387f3c","name":"If15"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,-20],"id":"f0dc903a-9343-4995-9ba7-449f40f2351e","name":"If16"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,120],"id":"653c1edd-6755-4f33-b7de-17e9548559c5","name":"If17"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,260],"id":"908753c7-3838-435c-a1cf-bdd8efef1604","name":"If18"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,400],"id":"10617cf2-6354-49da-a281-c15d4826efd4","name":"If19"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,540],"id":"86d357f5-2053-4010-9699-a818c9206d9f","name":"If20"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[1300,60],"id":"37dd0dc0-6550-4d19-8795-826eac973c92","name":"Aggregate"},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"data","includeEmpty":true,"separateBy":", "}]},"options":{}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[1460,60],"id":"37a823c6-f599-4590-9440-613234f9cda1","name":"Summarize"},{"parameters":{"jsCode":"// Funci√≥n para formatear el per√≠odo de fechas\nfunction formatearPeriodo(startDate, endDate) {\n  if (!startDate || !endDate) return \"\";\n  \n  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];\n  \n  const inicio = new Date(startDate);\n  const fin = new Date(endDate);\n  \n  // Si son el mismo d√≠a\n  if (inicio.toDateString() === fin.toDateString()) {\n    return `${inicio.getDate()} de ${meses[inicio.getMonth()]} de ${inicio.getFullYear()}`;\n  } else {\n    return `${inicio.getDate()} de ${meses[inicio.getMonth()]} al ${fin.getDate()} de ${meses[fin.getMonth()]} de ${fin.getFullYear()}`;\n  }\n}\n\n// Versi√≥n con header con degradado azul a magenta e informaci√≥n del periodo\nfunction createEmailSafeHeader(date, startDate, endDate) {\n  const periodText = formatearPeriodo(startDate, endDate);\n  const periodInfo = periodText ? `<p style=\"color: #ffffff; font-size: 14px; margin: 5px 0 0 0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\">Periodo de Consulta: ${periodText}</p>` : '';\n  \n  \n// Usar una imagen de fondo o celdas con colores s√≥lidos en lugar de gradiente\n  // Usar la imagen como fondo con VML para Outlook\n  return `\n  <!--[if gte mso 9]>\n  <v:rect xmlns:v=\"urn:schemas-microsoft-com:vml\" fill=\"true\" stroke=\"false\" style=\"width:800px;height:150px;\">\n    <v:fill type=\"frame\" src=\"https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM\" color=\"#1a237e\" />\n    <v:textbox style=\"mso-fit-shape-to-text:true\" inset=\"0,0,0,0\">\n  <![endif]-->\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" background=\"https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM\" style=\"background-image: url('https://media.licdn.com/dms/image/v2/D4E3DAQFqcEmbz29Nmw/image-scale_191_1128/image-scale_191_1128/0/1695664141867/ifx_networks_cover?e=2147483647&v=beta&t=JVG-v8jzdy-D85rsPWHrfn_rzAnV9459-s6uzEw-bPM'); background-size: cover; background-position: right center; margin-bottom: 20px;\">\n    <tr>\n      <td align=\"left\" valign=\"middle\" width=\"120\" style=\"padding: 15px;\">\n        <img src=\"https://github.com/aifx-dev/repo-images/blob/main/Logo_aifx_blanco_circle.png?raw=true\" alt=\"Logo\" style=\"width: 110px; height: auto;\">\n      </td>\n      <td align=\"left\" valign=\"middle\" style=\"padding: 15px;\">\n        <h1 style=\"color: #ffffff; font-size: 24px; margin: 0; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);\">BOLET√çN DE CIBERSEGURIDAD</h1>\n        <p style=\"color: #ffffff; font-size: 16px; margin: 5px 0 0 0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);\">${date}</p>\n        ${periodInfo}\n      </td>\n    </tr>\n    <tr>\n      <td colspan=\"2\" align=\"right\" style=\"padding-right: 15px; padding-bottom: 5px;\">\n        <p style=\"color: #ffffff; font-size: 11px; margin: 0;\">Generated by <i style=\"font-style: italic;\">aifx</i></p>\n      </td>\n    </tr>\n  </table>\n  <!--[if gte mso 9]>\n    </v:textbox>\n  </v:rect>\n  <![endif]-->`\n}\n\n// Funciones auxiliares\nfunction renderStats(vulnerabilidadesPorCriticidad) {\n  const contadores = {\n    'ALTA': vulnerabilidadesPorCriticidad['ALTA'].length,\n    'MEDIA': vulnerabilidadesPorCriticidad['MEDIA'].length,\n    'BAJA': vulnerabilidadesPorCriticidad['BAJA'].length\n  };\n  \n  const totalVulnerabilidades = contadores.ALTA + contadores.MEDIA + contadores.BAJA;\n  \n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n    <tr>\n      <td style=\"padding: 5px;\">\n        <table width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"5\" style=\"background-color: #f8f9fa; border-radius: 5px;\">\n          <tr>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #dc3545; margin-bottom: 5px;\">${contadores.ALTA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Alta Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #ff9933; margin-bottom: 5px;\">${contadores.MEDIA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Media Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 5px;\">${contadores.BAJA}</div>\n              <div style=\"font-size: 12px; color: #666;\">Vulnerabilidades de Baja Criticidad</div>\n            </td>\n            <td align=\"center\" valign=\"top\" style=\"width: 25%;\">\n              <div style=\"font-size: 24px; font-weight: bold; color: #2c67b2; margin-bottom: 5px;\">${totalVulnerabilidades}</div>\n              <div style=\"font-size: 12px; color: #666;\">Total de Vulnerabilidades</div>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>`;\n}\n\nfunction generarHTMLVulnerabilidad(vuln) {\n  let cvssColor;\n  let cvssBackColor;\n  let cvssValue;\n  \n  // Manejar el caso especial de CVSS \"TBD\"\n  if (vuln.cvss === \"TBD\" || vuln.cvss === null || vuln.cvss === undefined) {\n    cvssColor = '#ff9933'; // Naranja\n    cvssBackColor = '#fff5e6';\n    cvssValue = \"Pendiente\";\n  } else {\n    // Manejar valores num√©ricos normales\n    if (vuln.cvss >= 7) {\n      cvssColor = '#dc3545';\n      cvssBackColor = '#ffeaea';\n    } else if (vuln.cvss >= 4) {\n      cvssColor = '#ff9933';\n      cvssBackColor = '#fff5e6';\n    } else {\n      cvssColor = '#28a745';\n      cvssBackColor = '#e6f5e6';\n    }\n    cvssValue = vuln.cvss;\n  }\n  \n  // Generar HTML para acciones recomendadas\n  let accionesHTML = '';\n  if (vuln.acciones_recomendadas && vuln.acciones_recomendadas.length > 0) {\n    accionesHTML = vuln.acciones_recomendadas.map(accion => \n      `<li style=\"margin-bottom: 5px;\">${accion}</li>`\n    ).join('');\n  }\n  \n  // Generar HTML para referencias\n  let referenciasHTML = '';\n  if (vuln.referencias && vuln.referencias.length > 0) {\n    referenciasHTML = vuln.referencias.map(ref => \n      `<a href=\"${ref}\" style=\"color: #2c67b2; font-size: 13px; word-break: break-all; display: block; margin-bottom: 5px;\">${ref}</a>`\n    ).join('');\n  }\n  \n  return `\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-bottom: 20px; border: 1px solid #eaeaea; border-radius: 5px;\">\n    <tr>\n      <td style=\"padding: 15px 20px;\">\n        <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n          <tr>\n            <td>\n              <div style=\"font-weight: bold; font-size: 18px; color: #2c67b2; margin-bottom: 8px;\">${vuln.fabricante || 'Fabricante no especificado'}</div>\n              <div style=\"font-size: 14px; color: #666; margin-top: 5px;\">\n                <span><strong>CVE:</strong> ${vuln.cve}</span><br>\n                <span><strong>Fecha del Reporte:</strong> ${vuln.fecha_reporte}</span><br>\n                <span><strong>Producto Afectado:</strong> ${vuln.producto}</span><br>\n                <span style=\"display: inline-block; padding: 3px 8px; border-radius: 3px; font-weight: bold; font-size: 12px; margin-top: 5px; background-color: ${cvssBackColor}; color: ${cvssColor};\">CVSS: ${cvssValue}</span>\n              </div>\n            </td>\n          </tr>\n          <tr>\n            <td style=\"padding-top: 15px;\">\n              <table width=\"100%\" border=\"0\" cellpadding=\"12\" cellspacing=\"0\" style=\"background-color: #f8f9fa; border-radius: 5px; margin: 10px 0;\">\n                <tr>\n                  <td>\n                    <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Descripci√≥n T√©cnica</div>\n                    <p>${vuln.descripcion}</p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          <tr>\n            <td style=\"padding-top: 15px;\">\n              <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Acciones Recomendadas</div>\n              <ul style=\"padding-left: 25px; margin-bottom: 15px;\">\n                ${accionesHTML}\n              </ul>\n            </td>\n          </tr>\n          <tr>\n            <td>\n              <div style=\"font-weight: bold; margin-bottom: 5px; color: #555;\">Referencias</div>\n              ${referenciasHTML}\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>`;\n}\n\n// C√≥digo principal para n8n\nconst items = $input.all();\nconst returnItems = [];\n\nfor (const item of items) {\n  try {\n    // Obtener el per√≠odo desde los par√°metros de entrada (si existen)\n    const startDate = item.json.startDate || null;\n    const endDate = item.json.endDate || null;\n    \n    console.log(\"Per√≠odo recibido:\", { startDate, endDate });\n    \n    // Extraer y parsear los datos JSON\n    let securityData;\n    let outputContent = '';\n    \n    // Verificar si hay datos en el campo 'output'\n    if (item.json.output) {\n      outputContent = item.json.output;\n      \n      // Si el output ya es un objeto, usarlo directamente\n      if (typeof outputContent === 'object' && outputContent !== null) {\n        securityData = outputContent;\n      } \n      // Si es un string, procesar adecuadamente\n      else if (typeof outputContent === 'string') {\n        console.log(\"Output original:\", outputContent.substring(0, 100) + \"...\");\n        \n        // Limpiar el string: eliminar marcadores de c√≥digo y caracteres problem√°ticos\n        let cleanedContent = outputContent;\n        \n        // Eliminar ```json o ``` al inicio\n        if (cleanedContent.trim().startsWith('```json')) {\n          cleanedContent = cleanedContent.replace(/^```json\\s*/m, '');\n        } else if (cleanedContent.trim().startsWith('```')) {\n          cleanedContent = cleanedContent.replace(/^```\\s*/m, '');\n        }\n        \n        // Eliminar ``` al final\n        if (cleanedContent.trim().endsWith('```')) {\n          cleanedContent = cleanedContent.replace(/\\s*```$/m, '');\n        }\n        \n        console.log(\"Contenido limpio de marcadores:\", cleanedContent.substring(0, 100) + \"...\");\n        \n        // Intentar crear un objeto JSON v√°lido\n        try {\n          // Si comienza con asteriscos u otros caracteres no JSON, intentar extraer el JSON\n          if (cleanedContent.includes('{')) {\n            // Buscar el primer '{' y √∫ltimo '}'\n            const startIdx = cleanedContent.indexOf('{');\n            const endIdx = cleanedContent.lastIndexOf('}') + 1;\n            \n            if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {\n              const jsonCandidate = cleanedContent.substring(startIdx, endIdx);\n              console.log(\"Extrayendo JSON entre llaves:\", jsonCandidate.substring(0, 100) + \"...\");\n              securityData = JSON.parse(jsonCandidate);\n            } else {\n              throw new Error(\"No se encontr√≥ una estructura JSON v√°lida en el contenido\");\n            }\n          } else {\n            // Intentar parsear directo si no encontramos problemas evidentes\n            securityData = JSON.parse(cleanedContent);\n          }\n        } catch (e) {\n          console.log('Error al parsear JSON:', e);\n          \n          // Intentar crear un objeto de seguridad b√°sico si no podemos parsear el JSON\n          try {\n            // Extraer secciones relevantes del texto\n            console.log(\"Intentando crear estructura manualmente desde el texto\");\n            \n            // Creamos un objeto b√°sico\n            securityData = {\n              metadata: { fuente: \"Extracci√≥n manual del texto\" },\n              vulnerabilidades: [],\n              pautas_generales: []\n            };\n            \n            // Si podemos extraer vulnerabilidades del texto, lo hacemos\n            // Este es un proceso muy simplificado\n            const vulnSections = cleanedContent.split(/(?:\\r?\\n){2,}/);\n            \n            // Buscar secciones que parecen vulnerabilidades\n            for (const section of vulnSections) {\n              if (section.includes(\"CVE-\") || section.includes(\"vulnerabilidad\") || section.includes(\"criticidad\")) {\n                // Determinar criticidad\n                let criticidad = \"MEDIA\"; // Por defecto\n                if (section.toLowerCase().includes(\"alta\") || section.toLowerCase().includes(\"cr√≠tica\")) {\n                  criticidad = \"ALTA\";\n                } else if (section.toLowerCase().includes(\"baja\")) {\n                  criticidad = \"BAJA\";\n                }\n                \n                // Extraer CVE si existe\n                const cveMatch = section.match(/CVE-\\d{4}-\\d{4,}/);\n                const cve = cveMatch ? cveMatch[0] : \"Sin CVE\";\n                \n                // A√±adir vulnerabilidad b√°sica\n                securityData.vulnerabilidades.push({\n                  criticidad: criticidad,\n                  cve: cve,\n                  descripcion: section.substring(0, 500),\n                  producto: \"Extra√≠do del texto\",\n                  fecha_reporte: new Date().toISOString().split('T')[0],\n                  acciones_recomendadas: [\"Contactar al proveedor para m√°s informaci√≥n\"],\n                  referencias: []\n                });\n              }\n            }\n            \n            // Si no encontramos vulnerabilidades, a√±adir una de muestra\n            if (securityData.vulnerabilidades.length === 0) {\n              securityData.vulnerabilidades.push({\n                criticidad: \"MEDIA\",\n                cve: \"Formato-Desconocido\",\n                descripcion: \"No se pudo extraer informaci√≥n estructurada del texto. Por favor, revise el formato de entrada.\",\n                producto: \"Desconocido\",\n                fecha_reporte: new Date().toISOString().split('T')[0],\n                acciones_recomendadas: [\"Revisar el formato de entrada\"],\n                referencias: []\n              });\n            }\n            \n            // A√±adir pauta general\n            securityData.pautas_generales.push(\n              \"Este reporte fue generado desde un texto no estructurado. Se recomienda revisar el formato de entrada.\"\n            );\n            \n            console.log(\"Creada estructura manual con\", securityData.vulnerabilidades.length, \"vulnerabilidades\");\n            \n          } catch (manualError) {\n            console.log(\"Error al crear estructura manual:\", manualError);\n            throw new Error(`No se pudo procesar el formato de entrada: ${e.message}`);\n          }\n        }\n      } else {\n        throw new Error('El formato del output no es reconocible');\n      }\n    } else {\n      throw new Error('No se encontr√≥ campo \"output\" en los datos de entrada');\n    }\n    \n    console.log(\"Estructura procesada:\", JSON.stringify(securityData).substring(0, 100) + \"...\");\n    \n    // Validar la estructura\n    if (!securityData || !securityData.vulnerabilidades || !Array.isArray(securityData.vulnerabilidades)) {\n      throw new Error('Formato JSON inv√°lido: se requiere un array de vulnerabilidades');\n    }\n    \n    // Asegurarse que metadata existe\n    if (!securityData.metadata) {\n      securityData.metadata = {};\n    }\n    \n    // Normalizar criticidad a may√∫sculas\n    securityData.vulnerabilidades.forEach(vuln => {\n      if (vuln.criticidad) {\n        vuln.criticidad = vuln.criticidad.toUpperCase();\n      }\n    });\n    \n    // Clasificar vulnerabilidades por criticidad\n    const vulnerabilidadesPorCriticidad = {\n      'ALTA': [],\n      'MEDIA': [],\n      'BAJA': []\n    };\n\n    // Procesar cada vulnerabilidad \n    securityData.vulnerabilidades.forEach(vuln => {\n      // Convertir a may√∫sculas y normalizar\n      const criticidad = String(vuln.criticidad || '').toUpperCase();\n      \n      // A√±adir a la categor√≠a apropiada si existe\n      if (criticidad === 'ALTA') {\n        vulnerabilidadesPorCriticidad.ALTA.push(vuln);\n      } else if (criticidad === 'MEDIA') {\n        vulnerabilidadesPorCriticidad.MEDIA.push(vuln);\n      } else if (criticidad === 'BAJA') {\n        vulnerabilidadesPorCriticidad.BAJA.push(vuln);\n      }\n    });\n    \n    // Formatear fecha actual\n    const ahora = new Date();\n    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];\n    const fechaFormateada = `${meses[ahora.getMonth()]} ${ahora.getDate()} de ${ahora.getFullYear()}`;\n    \n    // Total de vulnerabilidades\n    const totalVulnerabilidades = securityData.vulnerabilidades.length;\n    \n    // Construir el HTML - usando tablas para compatibilidad con correo\n    let html = `<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Bolet√≠n de Alertas de Ciberseguridad</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f8f9fa; color: #333; font-family: Arial, sans-serif; line-height: 1.6;\">\n    <div style=\"max-width: 800px; margin: 0 auto; background-color: #ffffff; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);\">\n        <!-- Cabecera con gradiente y per√≠odo -->\n        ${createEmailSafeHeader(fechaFormateada, startDate, endDate)}\n        \n        <!-- Contenido -->\n        <div style=\"padding: 30px;\">\n            <div style=\"background-color: #f1f5f9; border-left: 4px solid #2c67b2; padding: 12px 20px; margin-bottom: 25px; font-size: 14px;\">\n                <strong>FUENTE DEL REPORTE:</strong> National Vulnerabilty Database - NIST.GOV\n            </div>\n            \n            <!-- Estad√≠sticas -->\n            ${renderStats(vulnerabilidadesPorCriticidad)}`;\n\n    // Si no hay vulnerabilidades, mostrar mensaje especial\n    if (totalVulnerabilidades === 0) {\n      html += `\n            <div style=\"background-color: #f8f9fa; padding: 30px; margin-bottom: 30px; text-align: center; border-radius: 5px; font-size: 18px;\">\n                <strong>¬°Buenas noticias!</strong><br>No se han detectado vulnerabilidades en el per√≠odo actual.\n            </div>`;\n    } else {\n      // Secci√≥n de Alta Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #dc3545; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD ALTA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['ALTA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['ALTA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n      \n      // Secci√≥n de Media Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #ff9933; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD MEDIA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['MEDIA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['MEDIA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n      \n      // Secci√≥n de Baja Criticidad\n      html += `\n            <div style=\"margin-bottom: 30px;\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #dee2e6;\">\n                    <div style=\"width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; background-color: #28a745; display: inline-block;\"></div>\n                    <h2 style=\"font-size: 18px; font-weight: bold; margin: 0;\">CRITICIDAD BAJA</h2>\n                </div>`;\n      \n      if (vulnerabilidadesPorCriticidad['BAJA'].length === 0) {\n        html += `\n                <div style=\"background-color: #f8f9fa; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: #666; font-style: italic;\">\n                    No se han detectado vulnerabilidades de este nivel de criticidad en el per√≠odo actual.\n                </div>`;\n      } else {\n        vulnerabilidadesPorCriticidad['BAJA'].forEach(vuln => {\n          html += generarHTMLVulnerabilidad(vuln);\n        });\n      }\n      \n      html += `\n            </div>`;\n    }\n    \n    // Secci√≥n de Pautas Generales\n    html += `\n            <div style=\"background-color: #f1f5f9; border-radius: 5px; padding: 20px; margin-top: 30px;\">\n                <h3 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1a2e4a;\">PAUTAS DE ACCI√ìN GENERALES</h3>\n                <ol style=\"padding-left: 25px;\">`;\n    \n    if (securityData.pautas_generales && securityData.pautas_generales.length > 0) {\n      securityData.pautas_generales.forEach(pauta => {\n        html += `\n                    <li style=\"margin-bottom: 10px;\">${pauta}</li>`;\n      });\n    } else {\n      html += `\n                    <li style=\"margin-bottom: 10px;\">No hay pautas generales disponibles.</li>`;\n    }\n    \n    html += `\n                </ol>\n            </div>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px;\">\n            <img src=\"https://github.com/ifxnetworks/Ansible/blob/main/Imagen1nnlnl.jpg?raw=true\" alt=\"Pie de p√°gina\" style=\"max-width: 100%; height: auto;\">\n        </div>\n    </div>\n</body>\n</html>`;\n\n    // Incluir los datos JSON en un campo oculto del HTML\n    const jsonScriptTag = `<script id=\"security-data\" type=\"application/json\" style=\"display:none;\">${JSON.stringify(securityData)}</script>`;\n    html = html.replace('</body>', `${jsonScriptTag}</body>`);\n\n    // Devolver un √∫nico output\n    returnItems.push({\n      json: {\n        htmlEmail: html\n      }\n    });\n  } catch (error) {\n    console.log('Error:', error);\n    const errorMessage = error instanceof Error \n      ? error.message \n      : 'Error desconocido';\n    returnItems.push({\n      json: {\n        error: `Error al procesar los datos: ${errorMessage}`\n      }\n    });\n  }\n}\n\nreturn returnItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,60],"id":"bb2f3ccc-006c-409d-8223-7bab867feec8","name":"HTML Create"},{"parameters":{"rule":{"interval":[{"triggerAtHour":4}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-860,-20],"id":"cf0a9277-f87a-49dc-81af-0f43d35f8c29","name":"Schedule Trigger"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"fe5da3ed-b4de-43af-b4d8-0ebcfef32998","leftValue":"={{ $json.totalResults }}","rightValue":0,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[580,680],"id":"0f26e7fc-e0b9-4f63-9c1b-95e3c2495206","name":"If21"},{"parameters":{"url":"=https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Ubiquiti&pubStartDate={{ $json.startDate }}&pubEndDate={{ $json.endDate }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apiKey","value":"={{ $json.apikey }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[360,680],"id":"eeaac2ed-1ac1-4f49-a58f-5ec12a5c7c0f","name":"Ubiquiti"},{"parameters":{"jsCode":"// Definir la API key de NVD\nconst apiKey = \"17e7fb6f-3f7c-4874-bcb2-4bab483013e6 \";\n// Extraer Fecha\nconst now = new Date();\nnow.setUTCDate(now.getUTCDate() - 1); // resta 1 d√≠a\nconst startOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));\nconst endOfDay = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));\nconst formatISO8601 = (date) => date.toISOString().replace(/\\.\\d{3}Z$/, '.000Z');\nreturn {\n  startDate: formatISO8601(startOfDay),\n  endDate: formatISO8601(endOfDay),\n  apikey: apiKey\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-620,-20],"id":"6e14a0ec-7b05-43f9-b5a2-c146881da683","name":"Diary Format Date"},{"parameters":{"jsCode":"const now = new Date();\nconst endDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));\nconst startDate = new Date(endDate);\nstartDate.setUTCDate(startDate.getUTCDate() - 7); // resta 7 d√≠as (una semana)\nstartDate.setUTCHours(0, 0, 0, 0); // establece al inicio del d√≠a\n\nconst formatISO8601 = (date) => date.toISOString().replace(/\\.\\d{3}Z$/, '.000Z');\n\nreturn {\n  startDate: formatISO8601(startDate),\n  endDate: formatISO8601(endDate)\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-620,200],"id":"7f1ff5a1-41db-45c3-8ec1-db172fb27936","name":"Weekly Format Date"},{"parameters":{"model":{"__rl":true,"value":"llama-4-Scout","mode":"list","cachedResultName":"llama-4-Scout"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1580,260],"id":"9691e47d-d0d2-4c23-8d87-c6536b9f3d27","name":"Llama 4 Scout","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"Boletin de Vulnerabilidades - NVD NIST.GOV","bodyContent":"={{ $json.htmlEmail }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[2400,260],"id":"f76fba1a-aad5-4b38-837d-6ca3412d4e8d","name":"Testing Email jaimep@ifxcorp.com","webhookId":"8d78c886-c815-4b16-af7e-fc137fe9fcfa","credentials":{"microsoftOutlookOAuth2Api":{"id":"WVU9558r90tkJoj9","name":"Outlook jaimep@ifxcorp.com"}},"disabled":true},{"parameters":{"toRecipients":"ai@ifxcorp.com","subject":"Boletin de Vulnerabilidades - NVD NIST.GOV","bodyContent":"={{ $json.htmlEmail }}","additionalFields":{"bccRecipients":"soc-cl@ifxcorp.com,care_interno@ifxcorp.com,seguridadinformacion@ifxcorp.com,jaimep@ifxcorp.com","bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[2380,60],"id":"52143cd3-83c3-475a-b9a1-4c6e52ff0fdd","name":"Sent Mail ai@ifxcorp.com","webhookId":"8d78c886-c815-4b16-af7e-fc137fe9fcfa","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}}],"connections":{"AI Agent":{"main":[[{"node":"HTML Create","type":"main","index":0}]]},"Cisco":{"main":[[{"node":"If5","type":"main","index":0}]]},"Vmware":{"main":[[{"node":"If","type":"main","index":0}]]},"Sophos":{"main":[[{"node":"If1","type":"main","index":0}]]},"HPE":{"main":[[{"node":"If2","type":"main","index":0}]]},"Veeam":{"main":[[{"node":"If3","type":"main","index":0}]]},"Fortinet":{"main":[[{"node":"If4","type":"main","index":0}]]},"Ansible":{"main":[[{"node":"If6","type":"main","index":0}]]},"Kubernetes":{"main":[[{"node":"If7","type":"main","index":0}]]},"SolarWinds":{"main":[[{"node":"If8","type":"main","index":0}]]},"Acronis":{"main":[[{"node":"If9","type":"main","index":0}]]},"Juniper":{"main":[[{"node":"If11","type":"main","index":0}]]},"Huawei":{"main":[[{"node":"If12","type":"main","index":0}]]},"Chrome":{"main":[[{"node":"If13","type":"main","index":0}]]},"Edge":{"main":[[{"node":"If14","type":"main","index":0}]]},"Outlook":{"main":[[{"node":"If15","type":"main","index":0}]]},"Dell":{"main":[[{"node":"If16","type":"main","index":0}]]},"IBM":{"main":[[{"node":"If17","type":"main","index":0}]]},"Hitachi":{"main":[[{"node":"If18","type":"main","index":0}]]},"Pure":{"main":[[{"node":"If19","type":"main","index":0}]]},"Broadcom":{"main":[[{"node":"If20","type":"main","index":0}]]},"Mikrotik":{"main":[[{"node":"If10","type":"main","index":0}]]},"Grupo 1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Grupo 2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Grupo 3":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"If":{"main":[[],[{"node":"Grupo 1","type":"main","index":0}]]},"If1":{"main":[[],[{"node":"Grupo 1","type":"main","index":2}]]},"If2":{"main":[[],[{"node":"Grupo 1","type":"main","index":4}]]},"If3":{"main":[[],[{"node":"Grupo 1","type":"main","index":6}]]},"If4":{"main":[[],[{"node":"Grupo 1","type":"main","index":8}]]},"If5":{"main":[[],[{"node":"Grupo 2","type":"main","index":0}]]},"If6":{"main":[[],[{"node":"Grupo 2","type":"main","index":2}]]},"If7":{"main":[[],[{"node":"Grupo 2","type":"main","index":4}]]},"If8":{"main":[[],[{"node":"Grupo 2","type":"main","index":6}]]},"If9":{"main":[[],[{"node":"Grupo 2","type":"main","index":8}]]},"If10":{"main":[[],[{"node":"Grupo 3","type":"main","index":1}]]},"If11":{"main":[[],[{"node":"Grupo 1","type":"main","index":1}]]},"If12":{"main":[[],[{"node":"Grupo 1","type":"main","index":3}]]},"If13":{"main":[[],[{"node":"Grupo 1","type":"main","index":5}]]},"If14":{"main":[[],[{"node":"Grupo 1","type":"main","index":7}]]},"If15":{"main":[[],[{"node":"Grupo 1","type":"main","index":9}]]},"If16":{"main":[[],[{"node":"Grupo 2","type":"main","index":1}]]},"If17":{"main":[[],[{"node":"Grupo 2","type":"main","index":3}]]},"If18":{"main":[[],[{"node":"Grupo 2","type":"main","index":5}]]},"If19":{"main":[[],[{"node":"Grupo 2","type":"main","index":7}]]},"If20":{"main":[[],[{"node":"Grupo 3","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Summarize","type":"main","index":0}]]},"Summarize":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"HTML Create":{"main":[[{"node":"Sent Mail ai@ifxcorp.com","type":"main","index":0},{"node":"Testing Email jaimep@ifxcorp.com","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Diary Format Date","type":"main","index":0}]]},"Ubiquiti":{"main":[[{"node":"If21","type":"main","index":0}]]},"If21":{"main":[[],[{"node":"Grupo 3","type":"main","index":2}]]},"Diary Format Date":{"main":[[{"node":"Vmware","type":"main","index":0},{"node":"Sophos","type":"main","index":0},{"node":"HPE","type":"main","index":0},{"node":"Veeam","type":"main","index":0},{"node":"Fortinet","type":"main","index":0},{"node":"Cisco","type":"main","index":0},{"node":"Ansible","type":"main","index":0},{"node":"Kubernetes","type":"main","index":0},{"node":"SolarWinds","type":"main","index":0},{"node":"Acronis","type":"main","index":0},{"node":"Mikrotik","type":"main","index":0},{"node":"Juniper","type":"main","index":0},{"node":"Huawei","type":"main","index":0},{"node":"Chrome","type":"main","index":0},{"node":"Edge","type":"main","index":0},{"node":"Outlook","type":"main","index":0},{"node":"Dell","type":"main","index":0},{"node":"IBM","type":"main","index":0},{"node":"Hitachi","type":"main","index":0},{"node":"Pure","type":"main","index":0},{"node":"Broadcom","type":"main","index":0},{"node":"Ubiquiti","type":"main","index":0}]]},"Llama 4 Scout":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Txht1wrdLAI370JY","timezone":"America/Bogota"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"422839b6-dcbc-4759-8b0e-e6f3b9ed1878","triggerCount":1,"tags":[]}