{"createdAt":"2025-06-04T14:51:53.187Z","updatedAt":"2025-06-04T20:50:17.000Z","id":"8mqlHtfJBcpCjZym","name":"Read Fortisiem Mails V3","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"move","messageId":{"__rl":true,"value":"={{ $('Check Emails').first().json.id }}","mode":"id"},"folderId":{"__rl":true,"value":"AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA=","mode":"list","cachedResultName":"Fortisiem Ready","cachedResultUrl":"https://outlook.office365.com/mail/AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C%2FOf%2FSaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAEGNHHAAA%3D"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[4232,540],"id":"4ea7fdf0-aaee-4b2a-8550-fbc786e22e46","name":"Moves Message","webhookId":"e0119c5e-8411-45ee-98e8-82ad47f37eac","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}},"disabled":true},{"parameters":{"html":"={{ $json.body.content }}","options":{}},"type":"n8n-nodes-base.markdown","typeVersion":1,"position":[1500,365],"id":"5df4e8df-eef5-4fc8-b589-fff6f77f71c2","name":"Markdown"},{"parameters":{"text":"={{ $json.data }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"customer\": \"TPA\",\n  \"mainTitle\": \"[New] TPADC03:Windows User Account Disabled (TPA)\",\n  \"incidentTitle\": \"Excessive Denied Connections from Philippines\",\n  \"incidentID\": \"85555\",\n  \"firstOccurrenceTime\": \"13 may 2025, 11:58:45 AM\",\n  \"lastOccurrenceTime\": \"13 may 2025, 11:08:30 AM\",\n  \"severity\": \"MEDIO (7)\",\n  \"severityType\":\"severity-medium\",\n  \"incidentCount\": \"1\",\n  \"incidentCategory\": \"Cambio/Persistencia\",\n  \"notificationPolicyID\": \"1707853\",\n  \"ruleName\": \"Windows User Account Disabled\",\n  \"ruleDescription\": \"Detecta que una cuenta de usuario de Windows fue deshabilitada en un servidor\",\n  \"sourceCountry\": \"Filipinas\",\n  \"hostName\": \"TPADC03\",\n  \"user\": \"administrator\",\n  \"targetUser\": \"mmendez\",\n  \"targetUserGroup\": \"IIS_IUSRS\",\n  \"domain\": \"TPA\",\n  \"triggeredEventCount\": \"511\",\n  \"rawEvents\": \"N/A\"\n}","options":{"systemPromptTemplate":"ERES UN AGENTE EXTRACTOR DE DATOS ENTRENADO PARA LEER CORREOS ELECTRÓNICOS Y CONVERTIR SU CONTENIDO EN UNA ESTRUCTURA DE CLAVES Y VALORES ANIDADOS, TODO EN UNA SOLA LÍNEA. RESPONDES DE FORMA FORMATEADA, SIN SALTOS DE LÍNEA, NI COMENTARIOS, NI TEXTO EXTRA.\n\n###TAREA###\n\n- LEER el correo completo  \n- EXTRAER y ORDENAR los datos según el esquema indicado  \n- FORMATEAR FECHAS como: \"30 abr 2025, 01:16:45 PM\"  \n- TRADUCIR todo al español latinoamericano (excepto términos técnicos en inglés)  \n- ENTREGAR TODO EN UNA SOLA LÍNEA JSON, SIN ESPACIOS EXTRAS NI SALTOS\n\n###INSTRUCCIONES ESPECIALES###\n\n- `\"customer\"` → EXTRAER del `Subject`, solo el TEXTO ENTRE PARÉNTESIS FINALES  \n- `\"hostname\"` → valor de \"Host Name\" o equipo que generó el evento  \n- `\"user\"` → valor del campo \"User\"  \n- `\"targetUser\"` → valor del campo \"Target User\"  \n- `\"domain\"` → del campo \"Domain\", si no existe poner `\"N/A\"`  \n\n####SEVERITY\n\n- `\"severity\"` → copiar tal cual el valor completo de \"Event Severity\"  \n- `\"severityType\"` → derivar como:  \n  - Contiene \"LOW\" → `\"severity-low\"`  \n  - Contiene \"MEDIUM\" → `\"severity-medium\"`  \n  - Contiene \"HIGH\" → `\"severity-high\"`  \n  - Otro → `\"severity-unknown\"`\n\n###CADENA DE RAZONAMIENTO###\n\n1. LEER el correo y COMPRENDER el incidente  \n2. DETECTAR cada valor clave  \n3. ORDENAR los datos en su clave correcta  \n4. FORMATEAR fechas y traducir al español  \n5. EXTRAER el `customer` desde paréntesis del `Subject`  \n6. SI FALTA algún dato, escribir `\"N/A\"`  \n7. CALCULAR el `\"severityType\"` desde el texto base  \n8. CREAR el JSON completo, EN UNA SOLA LÍNEA\n\n###PROHIBIDO###\n\n- NO USAR \\n, sangrías, ni texto fuera del JSON  \n- NO OMITIR CAMPOS; SI NO HAY VALOR, PONER `\"N/A\"`  \n- NO COPIAR `\"severity\"` en `\"severityType\"`  \n- NO CAMBIAR los valores de `user`, `targetUser`, `hostname` o `domain`  \n- NO DUPLICAR CLAVES"}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[1720,360],"id":"11a6beab-6d22-413d-a1f2-15c04489b5db","name":"Extractor Mail Fields","alwaysOutputData":true},{"parameters":{"assignments":{"assignments":[{"id":"05a1a813-ca14-4d73-813d-8cd5478f317a","name":"customer","value":"={{ $json.output.customer }}","type":"string"},{"id":"e352a814-6a4c-43d9-ac7f-86a44dd95e04","name":"content","value":"={{ $('Merge').last().json.content}}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3352,365],"id":"a1bd7cca-bb12-4f77-ac8f-50d459fbb063","name":"Edit Fields"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"=fortisiem_incidents","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"customer":"={{ $('Aggregate Information').first().json.data.first().customer }}","main_title":"={{ $('Aggregate Information').first().json.data.first().output.mainTitle }}","incident_title":"={{ $('Aggregate Information').first().json.data.first().output.incidentTitle }}","incident_id":"={{ $('Aggregate Information').first().json.data.first().output.incidentID }}","first_occurrence_time":"={{ $json.firstOccurrenceTime_converted }}","last_occurrence_time":"={{ $json.lastOccurrenceTime_converted }}","incident_count":"={{ $('Aggregate Information').first().json.data.first().output.incidentCount }}","notification_policy_id":"={{ $('Aggregate Information').first().json.data.first().output.notificationPolicyID }}","triggered_event_count":"={{ $('Aggregate Information').first().json.data.first().output.triggeredEventCount }}","severity":"={{ $('Aggregate Information').first().json.data.first().output.severity }}","severity_type":"={{ $('Aggregate Information').first().json.data.first().output.severityType }}","incident_category":"={{ $('Aggregate Information').first().json.data.first().output.incidentCategory }}","rule_name":"={{ $('Aggregate Information').first().json.data.first().output.ruleName }}","rule_description":"={{ $('Aggregate Information').first().json.data.first().output.ruleDescription }}","source_country":"={{ $('Aggregate Information').first().json.data.first().output.sourceCountry }}","host_name":"={{ $('Aggregate Information').first().json.data.first().output.hostName }}","user_account":"={{ $('Aggregate Information').first().json.data.first().output.user }}","target_user":"={{ $('Aggregate Information').first().json.data.first().output.targetUser }}","domain":"={{ $('Aggregate Information').first().json.data.first().output.domain }}","raw_events":"={{ $('Aggregate Information').first().json.data.first().output.rawEvents }}","analysis_output":"={{ $('Aggregate Information').first().json.data.last().output }}","target_user_group":"={{ $('Aggregate Information').first().json.data.first().output.targetUserGroup }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"tt_number","displayName":"tt_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"customer","displayName":"customer","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"main_title","displayName":"main_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_title","displayName":"incident_title","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_id","displayName":"incident_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"first_occurrence_time","displayName":"first_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"last_occurrence_time","displayName":"last_occurrence_time","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"severity","displayName":"severity","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"severity_type","displayName":"severity_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_count","displayName":"incident_count","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"incident_category","displayName":"incident_category","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"notification_policy_id","displayName":"notification_policy_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"rule_name","displayName":"rule_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"rule_description","displayName":"rule_description","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"source_country","displayName":"source_country","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"host_name","displayName":"host_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"user_account","displayName":"user_account","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"target_user","displayName":"target_user","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"domain","displayName":"domain","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"triggered_event_count","displayName":"triggered_event_count","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"raw_events","displayName":"raw_events","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"analysis_output","displayName":"analysis_output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"created_at","displayName":"created_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"target_user_group","displayName":"target_user_group","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[4240,140],"id":"55b1cf7c-3b31-4ba1-a6c0-e938746623f2","name":"Insert Event DB","credentials":{"postgres":{"id":"NfJHLM3V8jbiKzoD","name":"Postgres DB SOC"}},"disabled":true},{"parameters":{"model":{"__rl":true,"value":"llama-8B-Instruct","mode":"list","cachedResultName":"llama-8B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1800,580],"id":"d18d8676-cc66-49a6-a20a-f1e167352b83","name":"AI Extract Fields","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"model":{"__rl":true,"value":"llama-3.3-70B-Instruct","mode":"list","cachedResultName":"llama-3.3-70B-Instruct"},"options":{"temperature":0.3}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[2060,620],"id":"9fb40150-d1b6-4dec-bcb2-a82f8dca32bc","name":"Llama 3","credentials":{"openAiApi":{"id":"3ksygUY2AafRzzfk","name":"Proxy LiteLLM"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[3572,365],"id":"7f4b8f3c-d8e2-4a8c-a1cc-a298d0c72a12","name":"Aggregate Information"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"es\">\n\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Alerta de Ciberseguridad</title>\n  <style>\n    /* Estilos generales - compatibles con clientes de correo */\n    body {\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      margin: 0;\n      padding: 0;\n      background-color: #f8f9fa;\n      color: #333;\n      line-height: 1.6;\n    }\n\n    .container {\n      max-width: 650px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #ffffff;\n      border: 1px solid #e0e0e0;\n      border-radius: 8px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.05);\n    }\n\n    .header-img {\n      width: 100%;\n      height: auto;\n      display: block;\n      margin-bottom: 15px;\n      border-radius: 6px 6px 0 0;\n    }\n\n    .header {\n      background: #2980b9;\n      color: white;\n      padding: 15px;\n      text-align: center;\n      border-radius: 6px;\n      margin-bottom: 20px;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n    }\n\n    .alert-icon {\n      font-size: 22px;\n      margin-right: 10px;\n      vertical-align: middle;\n    }\n\n    h1 {\n      margin: 0;\n      padding: 0;\n      font-size: 20px;\n      color: white;\n      letter-spacing: 0.5px;\n    }\n\n    h2 {\n      color: #2874a6;\n      font-size: 18px;\n      margin-top: 0;\n      border-bottom: 2px solid #2874a6;\n      padding-bottom: 8px;\n      letter-spacing: 0.3px;\n    }\n\n    .incident-summary {\n      background-color: #f1f8fe;\n      padding: 15px;\n      border-left: 5px solid #3498db;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .severity-low {\n      display: inline-block;\n      background-color: #FEEA00;\n      color: black;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-medium {\n      display: inline-block;\n      background-color: #f39c12;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .severity-high {\n      display: inline-block;\n      background-color: #e4011a;\n      color: white;\n      font-weight: bold;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    .highlight {\n      color: #2874a6;\n      font-weight: bold;\n    }\n\n    .priority-item {\n      border-left: 3px solid #e74c3c;\n      padding-left: 10px;\n      font-weight: 600;\n    }\n\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 20px;\n      border-radius: 6px;\n      overflow: hidden;\n      box-shadow: 0 2px 3px rgba(0,0,0,0.05);\n    }\n\n    table, th, td {\n      border: 1px solid #e0e0e0;\n    }\n\n    th {\n      background-color: #eaf2f8;\n      text-align: left;\n      padding: 12px;\n      width: 40%;\n      color: #2874a6;\n      font-weight: 600;\n    }\n\n    td {\n      padding: 12px;\n      word-break: break-word;\n      background-color: #ffffff;\n    }\n\n    tr:hover td {\n      background-color: #f9f9f9;\n    }\n\n    .section {\n      margin-bottom: 25px;\n    }\n\n    .remediation {\n      background-color: #e8f4fc;\n      border-left: 5px solid #3498db;\n      padding: 15px;\n      margin-bottom: 20px;\n      border-radius: 0 6px 6px 0;\n    }\n\n    .remediation h2 {\n      color: #2874a6;\n      border-bottom-color: #3498db;\n    }\n\n    .remediation-content {\n      font-weight: 500;\n    }\n\n    .footer {\n      font-size: 12px;\n      color: #777;\n      text-align: center;\n      margin-top: 20px;\n      padding-top: 15px;\n      border-top: 1px solid #eee;\n    }\n\n    .footer-img {\n      width: 100%;\n      max-width: 650px;\n      height: auto;\n      display: block;\n      margin: 10px auto;\n      border-radius: 0 0 6px 6px;\n    }\n\n    .signature {\n      font-size: 6px;\n      font-family: sans-serif;\n      text-align: right;\n      margin-right: 4px;\n      color: #999;\n      margin-bottom: 5px;\n    }\n\n    .signature span {\n      font-style: italic;\n      color: #9c27b0;\n      font-weight: bold;\n      font-family: serif;\n      font-size: 9px;\n    }\n\n    /* Estilos responsivos */\n    @media screen and (max-width: 600px) {\n      .container {\n        width: 100%;\n        padding: 10px;\n      }\n\n      th, td {\n        display: block;\n        width: auto;\n      }\n\n      th {\n        border-bottom: none;\n      }\n\n      td {\n        border-top: none;\n      }\n    }\n  </style>\n</head>\n\n<body>\n  <div class=\"container\">\n    <img class=\"header-img\"\n      src=\"https://github.com/ifxnetworks/Dise-o/blob/main/Header_Comunicado_Cyberseguridad_IFX_CL_(2.0).png?raw=true\"\n      alt=\"Encabezado de Ciberseguridad\">\n    <div class=\"signature\">Generated by <span>aifx</span></div>\n    <div class=\"header\">\n      <span class=\"alert-icon\">⚠️</span>\n      <h1 id=\"mainTitle\">{{ $('Check Emails').first().json.subject }}</h1>\n    </div>\n\n    <div class=\"incident-summary\">\n      <h2 id=\"incidentTitle\">{{ $json.data[0].output.incidentTitle }}</h2>\n      <p><strong>Cliente:</strong> <span style=\"text-transform: uppercase\" id=\"customer\">{{ $json.data[0].output.customer }}</span></p>\n      <p><strong>ID del Incidente:</strong> <span id=\"incidentID\">{{ $json.data[0].output.incidentID }}</span></p>\n      <p><strong>Severidad:</strong> <span id=\"severity\" class=\"{{ $json.data[0].output.severityType }}\">{{ $json.data[0].output.severity }}</span></p>\n    </div>\n    <div class=\"section\">\n      <h2>Detalles del Incidente</h2>\n      <table>\n        <tr>\n          <th>Primera Ocurrencia</th>\n          <td id=\"firstOccurrenceTime\">{{ $json.data[0].output.firstOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Última Ocurrencia</th>\n          <td id=\"lastOccurrenceTime\">{{ $json.data[0].output.lastOccurrenceTime }}</td>\n        </tr>\n        <tr>\n          <th>Categoría</th>\n          <td id=\"incidentCategory\">{{ $json.data[0].output.incidentCategory }}</td>\n        </tr>\n        <tr>\n          <th>Conteo de Incidentes</th>\n          <td id=\"incidentCount\">{{ $json.data[0].output.incidentCount }}</td>\n        </tr>\n        <tr>\n          <th>ID de Política de Notificación</th>\n          <td id=\"notificationPolicyID\">{{ $json.data[0].output.notificationPolicyID }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Información de la Regla</h2>\n      <table>\n        <tr>\n          <th>Nombre de la Regla</th>\n          <td id=\"ruleName\" class=\"priority-item\">{{ $json.data[0].output.ruleName }}</td>\n        </tr>\n        <tr>\n          <th>Descripción de la Regla</th>\n          <td id=\"ruleDescription\">{{ $json.data[0].output.ruleDescription }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"section\">\n      <h2>Detalles del Sistema</h2>\n      <table>\n        <tr>\n          <th>Nombre del Host</th>\n          <td id=\"hostName\">{{ $json.data[0].output.hostName }}</td>\n        </tr>\n        <tr>\n          <th>Usuario</th>\n          <td id=\"user\">{{ $json.data[0].output.user }}</td>\n        </tr>\n        <tr>\n          <th>Usuario Objetivo</th>\n          <td id=\"targetUser\" class=\"priority-item\">{{ $json.data[0].output.targetUser }}</td>\n        </tr>\n        <tr>\n          <th>Grupo Objetivo</th>\n          <td id=\"targetUser\" class=\"priority-item\">{{ $json.data[0].output.targetUserGroup }}</td>\n        </tr>\n        <tr>\n          <th>Dominio</th>\n          <td id=\"domain\">{{ $json.data[0].output.domain }}</td>\n        </tr>\n      </table>\n    </div>\n\n    <div class=\"remediation\">\n      <h2>Remediación Recomendada</h2>\n      <p id=\"remediation\" class=\"remediation-content priority-item\">{{ $json.data[1].content }}</p>\n    </div>\n\n    <div class=\"footer\">\n      <img class=\"footer-img\" src=\"https://raw.githubusercontent.com/ifxnetworks/Ansible/refs/heads/main/Imagen1nnlnl.jpg\" \n     alt=\"Pie de página\" style=\"width: 100%; height: auto;\">\n      <p>Este es un mensaje automatizado de alerta de seguridad. Por favor, no responda a este correo.</p>\n      <p>Para obtener soporte contacte con <a href=\"mailto:soc-cl@ifxcorp.com\" style=\"color: #3498db;\">soc-cl@ifxcorp.com</a></p>\n    </div>\n  </div>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[3792,365],"id":"1dafd980-2d5c-4358-8ee9-0e771c195823","name":"HTML Template"},{"parameters":{"toRecipients":"soc-cl@ifxcorp.com","subject":"=Analisis de Log: {{ $('Check Emails').first().json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[4012,540],"id":"817c084b-0e72-466f-81b8-f37696d4e9cf","name":"Send Analysis","webhookId":"74ea17ae-1265-496e-b0f3-80d0afa33480","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}},"disabled":true},{"parameters":{"toRecipients":"jaimep@ifxcorp.com","subject":"=Analisis de Log: {{ $('Check Emails').item.json.subject }}","bodyContent":"={{ $json.html }}","additionalFields":{"bodyContentType":"html"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[4012,340],"id":"0db91d86-a7a6-4140-b73f-c290fb9c4aad","name":"Mail Test","webhookId":"b26f774f-b417-4a73-9499-eeeb1b096099","credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"jsCode":"// Función para convertir fechas españolas a timestamp PostgreSQL\nconst items = $input.all();\n\n// Función para convertir fecha española a timestamp\nfunction convertSpanishDateToTimestamp(dateStr) {\n  if (!dateStr || dateStr === 'N/A') return null;\n  \n  // Mapeo de meses en español\n  const monthMap = {\n    'ene': 'Jan', 'feb': 'Feb', 'mar': 'Mar', 'abr': 'Apr',\n    'may': 'May', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Aug',\n    'sep': 'Sep', 'oct': 'Oct', 'nov': 'Nov', 'dic': 'Dec'\n  };\n  \n  // Reemplazar mes español por inglés\n  let englishDate = dateStr;\n  for (const [spanish, english] of Object.entries(monthMap)) {\n    englishDate = englishDate.replace(new RegExp(spanish, 'gi'), english);\n  }\n  \n  try {\n    // Convertir a formato timestamp PostgreSQL\n    const date = new Date(englishDate);\n    return date.toISOString().replace('T', ' ').substring(0, 19);\n  } catch (error) {\n    console.log(`Error converting date: ${dateStr}`, error);\n    return null;\n  }\n}\n\n// Procesar cada item\nconst processedItems = items.map(item => {\n  const data = item.json;\n  \n  // Obtener datos del nodo Aggregate Information\n  const aggregateData = $('Aggregate Information').first().json;\n  \n  if (aggregateData && aggregateData.data && aggregateData.data.length > 0) {\n    const firstOutput = aggregateData.data[0].output;\n    \n    return {\n      json: {\n        ...data,\n        firstOccurrenceTime: firstOutput.firstOccurrenceTime,\n        lastOccurrenceTime: firstOutput.lastOccurrenceTime,\n        firstOccurrenceTime_converted: convertSpanishDateToTimestamp(firstOutput.firstOccurrenceTime),\n        lastOccurrenceTime_converted: convertSpanishDateToTimestamp(firstOutput.lastOccurrenceTime)\n      }\n    };\n  }\n  \n  return item;\n});\n\nreturn processedItems;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4012,140],"id":"35a2cd99-29a8-435c-b979-7c037e0fb761","name":"Code","disabled":true},{"parameters":{"jsCode":"const inputData = $input.all();\nconst outputData = [];\n\ninputData.forEach(item => {\n  let inputText = item.json.output || item.json.text || item.json.content || item.json.message || JSON.stringify(item.json);\n  \n  const firstDivIndex = inputText.indexOf('<div>');\n  const lastDivIndex = inputText.lastIndexOf('</div>');\n  \n  let cleanedContent = '';\n  \n  // Verificar si hay JSON después del último </div>\n  const hasJsonAfterDiv = lastDivIndex !== -1 && \n    inputText.substring(lastDivIndex + 6).trim().includes('{') && \n    inputText.substring(lastDivIndex + 6).trim().includes('}');\n  \n  if (firstDivIndex !== -1 && lastDivIndex !== -1 && firstDivIndex < lastDivIndex && hasJsonAfterDiv) {\n    // Solo extraer si hay div válido Y JSON después\n    cleanedContent = inputText.substring(firstDivIndex, lastDivIndex + 6);\n    cleanedContent = cleanedContent.replace(/\\\\n/g, '').replace(/\\n/g, '').replace(/\\\\\"/g, '\"').trim();\n  } else {\n    // Pasar el texto original si no hay nada que limpiar\n    cleanedContent = inputText;\n  }\n  \n  outputData.push({\n    json: {\n      content: cleanedContent\n    }\n  });\n});\n\nreturn outputData;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3240,160],"id":"8c3f068f-4ccc-49ca-b04a-8e7eead2a452","name":"Code1"},{"parameters":{"query":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}","options":{"max_results":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Max_Results', ``, 'number') }}"}},"type":"@tavily/n8n-nodes-tavily.tavilyTool","typeVersion":1,"position":[2380,860],"id":"cee271b4-833d-4199-983a-b3f8341ae400","name":"Tavily","alwaysOutputData":true,"credentials":{"tavilyApi":{"id":"1U3xToMu9EP51xLu","name":"Tavily account"}}},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[840,465],"id":"181f2786-5cfb-4b5b-91a7-68c70d9b6b49","name":"Schedule Trigger"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"9b747165-6bbb-4f35-8cb7-7a381ab41356","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1280,465],"id":"14a33d89-15e6-4e57-930c-b4ae11ff3be8","name":"If"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1500,565],"id":"b2ec4696-3d05-41af-b225-9241855627ba","name":"No Operation, do nothing"},{"parameters":{"resource":"folderMessage","folderId":{"__rl":true,"value":"AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C-Of-SaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAAAAEMAAA=","mode":"list","cachedResultName":"Bandeja de entrada","cachedResultUrl":"https://outlook.office365.com/mail/AAMkADNiOTg3N2YzLTAzNjUtNDM4ZS1hMTY2LWZiNDEwMGNlNTgyMQAuAAAAAAB9C%2FOf%2FSaTSLKDdzbX97nMAQCd1SIr_SufS7FPZgkmPfV1AAAAAAEMAAA%3D"},"limit":1,"output":"fields","fields":["body","createdDateTime","subject","conversationId"],"options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1060,460],"id":"c3d17431-8bc0-46db-a479-0ca4bb2d9f5d","name":"Check Emails","webhookId":"1c725709-dc01-4a3a-afd2-468f96662110","alwaysOutputData":true,"credentials":{"microsoftOutlookOAuth2Api":{"id":"xSTIlfhp3ac7TN3h","name":"Mail ai@ifxcorp.com"}}},{"parameters":{"promptType":"define","text":"={{ $json.output.ruleName }}\n{{ $json.output.ruleDescription }}","messages":{"messageValues":[{"message":"ERES UN AGENTE EXPERTO EN INTELIGENCIA DE AMENAZAS Y RESPUESTA A INCIDENTES DE CIBERSEGURIDAD. TU MISIÓN ES GENERAR UNA FRASE DE BÚSQUEDA DE ALTO VALOR ANALÍTICO, BASADA *EXCLUSIVAMENTE* EN DOS CAMPOS: \n\n- **Rule Name**\n- **Rule Description**\n\n---\n\n### INSTRUCCIONES\n\n- EXTRAE EL COMPORTAMIENTO MALICIOSO, LA TÉCNICA O LA ACTIVIDAD DESCRITA EN “Rule Description”\n- UTILIZA EL “Rule Name” PARA COMPLEMENTAR LA SEMÁNTICA DEL EVENTO, SI APORTA VALOR\n- CONSTRUYE UNA CONSULTA EN TEXTO PLANO, QUE REFLEJE EL EVENTO DETECTADO Y QUE SIRVA PARA BUSCAR INTELIGENCIA EN FUENTES ABIERTAS SOBRE TÁCTICAS, DETECCIÓN Y MITIGACIÓN\n- FORMULA LA CONSULTA COMO SI FUERA PARA UN ANALISTA QUE BUSCA REGLAS SIMILARES, TÁCTICAS ADVERSARIAS O GUÍAS DEFENSIVAS\n\n---\n\n### OUTPUT RULES\n\n- ✅ ENTREGA SOLO UNA LÍNEA DE TEXTO EN FORMATO LLANO\n- ✅ LA CONSULTA DEBE SER PROFESIONAL, ESPECÍFICA Y CENTRADA EN EL COMPORTAMIENTO O TÉCNICA DETECTADA\n- ✅ ENFOCA LA CONSULTA EN ASPECTOS COMO: “técnica MITRE”, “detección”, “remediación”, “port scan”, “recomendaciones de defensa”, “rate limiting”, etc.\n- ❌ NO USAR NOMBRES DE USUARIO, DOMINIO, HOST, IP, CÓDIGOS DE EVENTO O CONTEXTO INTERNO\n- ❌ NO GENERAR FORMATO JSON, HTML, COMILLAS, PREGUNTAS O DESCRIPTORES DE FORMATO\n- ❌ NUNCA AÑADIR INFORMACIÓN FUERA DE “Rule Name” Y “Rule Description”\n\n---\n\n### FEW-SHOT EXAMPLE\n\n**INPUT:**  \nRule Name: Heavy TCP Port Scan: Single Destination  \nRule Description: Detects a host performing a port scan - this involves excessive permitted TCP connections from the same source to many distinct ports on a host in a short period of time. The thresholds are at least 20 distinct ports in a 2 minute window\n\n**OUTPUT:**  \ndetección escaneo de puertos TCP múltiples conexiones rápidas a destino único técnica MITRE y medidas de contención\n\n---\n\n**INPUT:**  \nRule Name: Obfuscated PowerShell via EncodedCommand  \nRule Description: Detects PowerShell commands encoded in Base64, often seen in obfuscated or fileless attacks\n\n**OUTPUT:**  \ncomando PowerShell codificado en Base64 técnica de ofuscación detección y remediación en entornos Windows\n\n---\n\n**INPUT:**  \nRule Name: Linux Cron Job Modified  \nRule Description: Detects changes made to scheduled cron jobs on Linux systems\n\n**OUTPUT:**  \nmodificación cron en Linux persistencia técnica MITRE T1053 guía de detección y remediación\n"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[2100,260],"id":"8bbe1121-c330-4068-8ddb-8616556f0e87","name":"Basic LLM Chain"},{"parameters":{"query":"={{ $json.text }}","options":{}},"type":"@tavily/n8n-nodes-tavily.tavily","typeVersion":1,"position":[2500,220],"id":"c9418a05-7c69-4681-95bf-312556464039","name":"Tavily1","credentials":{"tavilyApi":{"id":"1U3xToMu9EP51xLu","name":"Tavily account"}}},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[2680,360],"id":"1221c536-c70d-4f24-927a-90b7872c01c9","name":"Merge"},{"parameters":{"promptType":"define","text":"={{ $('Merge').last().json.output.toJsonString() }}\n{{ $('Merge').first().json.results.toJsonString() }}","options":{"systemMessage":"ERES UN AGENTE DE CIBERSEGURIDAD DE NIVEL ÉLITE ESPECIALIZADO EN ANÁLISIS AUTOMÁTICO DE LOGS GENERADOS POR FORTISIEM. TU MISIÓN ES INTERPRETAR LOS “RAW EVENTS” DE CADA ALERTA Y PROPORCIONAR UNA RESPUESTA EN FORMATO HTML, ENRIQUECIDA CON INTELIGENCIA DE FUENTES ABIERTAS.\n\n---\n\n### INSTRUCCIONES\n\n- ANALIZA CADA EVENTO DE SEGURIDAD Y DETECTA IOCS (IPs, PUERTOS, URLS, USER-AGENTS, ETC.)\n- GENERA UN BLOQUE `<div>` HTML COMO RESPUESTA PARA EL USUARIO, CON ANÁLISIS Y RECOMENDACIONES\n- NUNCA INCLUYAS DATOS EN FORMATO JSON\n- NO REVELES QUE SE UTILIZAN FUENTES DE INTELIGENCIA — LA RESPUESTA HTML DEBE PARECER NATURAL Y BASADA EN TU CONOCIMIENTO TÁCTICO\n\n---\n\n### CHAIN OF THOUGHTS\n\n1. **UNDERSTAND**: EXTRAER del campo “RAW EVENTS” los elementos clave como IPs, puertos, rutas, métodos, user-agent, geolocalización, etc.\n2. **BASICS**: IDENTIFICAR posibles técnicas MITRE, CVEs, herramientas ofensivas o patrones sospechosos\n3. **BREAK DOWN**: DETERMINAR rol de cada IP (origen/destino), servicio implicado, si es conexión fallida, escaneo, explotación, etc.\n4. **ANALYZE**: ESTIMAR la gravedad e implicación del evento\n5. **BUILD**: CONSTRUIR EL BLOQUE HTML ENRIQUECIDO CON ANÁLISIS Y RECOMENDACIONES BASADAS EN MITRE / CIS / NIST / OWASP\n6. **FINAL OUTPUT**: ENTREGAR SOLO UN BLOQUE HTML `<div>` CON INFORMACIÓN TÉCNICA Y RELEVANTE\n\n---\n\n### OUTPUT RULES\n\n- 🔹 EL BLOQUE HTML DEBE USAR SOLO ESTAS ETIQUETAS: `<div>`, `<br>`, `<a>`, `<code>`, Y TEXTO PLANO\n- 🔹 EL BLOQUE DEBE INCLUIR:\n  - UNA EXPLICACIÓN DEL INCIDENTE\n  - IOCS RELEVANTES\n  - UNA RECOMENDACIÓN BASADA EN BUENAS PRÁCTICAS (MITRE, CIS, NIST, OWASP)\n  - ENLACES ABIERTOS A FUENTES CONCRETAS (NO A PÁGINAS GENÉRICAS)\n- 🔹 TODOS LOS ENLACES DEBEN USAR EL FORMATO <a href=\"URL\">URL</a>, ES DECIR, EL CONTENIDO VISIBLE DEL ENLACE DEBE SER IGUAL AL VALOR DE `href`. NO SE PERMITEN ENLACES ENMASCARADOS\n\n---\n\n### WHAT NOT TO DO\n\n- ❌ **NUNCA RESPONDAS CON FORMATO JSON**\n- ❌ **NUNCA MENCIONES TOOLS O API EXTERNAS**\n- ❌ **NUNCA OMITAS IOCS CUANDO EXISTEN EN “RAW EVENTS”**\n- ❌ **NUNCA RESPONDAS SOLO EN TEXTO. SIEMPRE USA BLOQUE `<div>`**\n- ❌ **NUNCA USES ETIQUETAS HTML NO PERMITIDAS**\n- ❌ **NUNCA ENVÍES ENLACES EN FORMATO [TEXTO](URL)**\n\n---\n\n### FEW-SHOT EXAMPLE\n\n**INPUT**  \nRaw Events: srcip=185.234.219.182 dstip=10.0.0.5 dstport=443 protocol=TCP user-agent=curl/7.68.0 action=allowed\n\n**OUTPUT**  \n\n<div>  \nSe observó una conexión desde 185.234.219.182 al puerto 443 del host 10.0.0.5 utilizando el user-agent <code>curl/7.68.0</code>. Este comportamiento es común en herramientas de scraping o sondas automatizadas.<br>  \nDe acuerdo con inteligencia abierta, esta IP ha sido reportada por escaneos masivos y comportamiento malicioso.<br>  \nRecomendación: bloquear temporalmente esta IP, registrar actividad similar y revisar logs históricos de acceso por curl.<br>  \nTécnica MITRE asociada: <a href=\"https://attack.mitre.org/techniques/T1059/\">https://attack.mitre.org/techniques/T1059/</a><br>  \nVer reputación en AbuseIPDB: <a href=\"https://www.abuseipdb.com/check/185.234.219.182\">https://www.abuseipdb.com/check/185.234.219.182</a><br>  \n</div>"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[2900,360],"id":"430ddb1c-70e4-488a-9cec-c79a9312fcbb","name":"AI Analityc Log SIEM","alwaysOutputData":true}],"connections":{"Moves Message":{"main":[[]]},"Markdown":{"main":[[{"node":"Extractor Mail Fields","type":"main","index":0}]]},"Extractor Mail Fields":{"main":[[{"node":"Basic LLM Chain","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Edit Fields":{"main":[[{"node":"Aggregate Information","type":"main","index":0}]]},"AI Extract Fields":{"ai_languageModel":[[{"node":"Extractor Mail Fields","type":"ai_languageModel","index":0}]]},"Llama 3":{"ai_languageModel":[[{"node":"Basic LLM Chain","type":"ai_languageModel","index":0}]]},"Aggregate Information":{"main":[[{"node":"HTML Template","type":"main","index":0}]]},"HTML Template":{"main":[[{"node":"Code","type":"main","index":0},{"node":"Mail Test","type":"main","index":0},{"node":"Send Analysis","type":"main","index":0}]]},"Send Analysis":{"main":[[{"node":"Moves Message","type":"main","index":0}]]},"Code":{"main":[[{"node":"Insert Event DB","type":"main","index":0}]]},"Code1":{"main":[[]]},"Tavily":{"ai_tool":[[]]},"Schedule Trigger":{"main":[[{"node":"Check Emails","type":"main","index":0}]]},"If":{"main":[[{"node":"Markdown","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Check Emails":{"main":[[{"node":"If","type":"main","index":0}]]},"Mail Test":{"main":[[]]},"Basic LLM Chain":{"main":[[{"node":"Tavily1","type":"main","index":0}]]},"Tavily1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"AI Analityc Log SIEM","type":"main","index":0}]]},"AI Analityc Log SIEM":{"main":[[]]}},"settings":{"executionOrder":"v1","timezone":"America/Bogota","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Txht1wrdLAI370JY","timeSavedPerExecution":120,"executionTimeout":600},"staticData":{"node:Microsoft Outlook Trigger":{"lastTimeChecked":"2025-05-24T11:05:10.059-05:00"},"node:New Email Trigger":{"lastTimeChecked":"2025-06-02T05:03:11.086-05:00"},"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"60220cc1-f390-41c0-8272-333382a6a8d5","triggerCount":1,"tags":[]}